@model RT_InvF_InventoryIn
@{
    /**/

    string viewType = CUtils.StrValue(ViewBag.ViewType);
    var userState = ViewBag.UserState as UserState;
    var objInvF_InventoryIn = new InvF_InventoryIn();
    var iF_InvInStatus = "";
    if (Model != null)
    {
        if (Model.Lst_InvF_InventoryIn != null && Model.Lst_InvF_InventoryIn.Count > 0)
        {
            objInvF_InventoryIn = Model.Lst_InvF_InventoryIn[0];
            iF_InvInStatus = CUtils.StrValue(objInvF_InventoryIn.IF_InvInStatus);
        }
    }
}

@* Approve *@
<script type="text/javascript">
    function Approve() {
        iF_InvInNo = $('#IF_InvInNo').val();
        if (iF_InvInNo === undefined || iF_InvInNo.length == 0) {
            alert("Số phiếu nhập trống!");
            return false;
        }
        var listInvF_InventoryIn = [];

        var objDel = {};
        objDel.IF_InvInNo = iF_InvInNo;
        objDel.Remark = '';
        listInvF_InventoryIn.push(objDel);
        var objInvF_InventoryIn = new InvF_InventoryIn();
        var ajaxSettings = {};
        ajaxSettings.Type = 'post';
        ajaxSettings.DataType = 'json';
        ajaxSettings.Url = '@Url.Action("Approve", "InvF_InventoryIn")';

        objInvF_InventoryIn.Image_Message = "<i class=\"fas fa-info-circle\"></i> THÔNG BÁO";
        objInvF_InventoryIn.Confirm_Message = "Đồng ý duyệt phiếu nhập này?";
        objInvF_InventoryIn.ajaxSettings = ajaxSettings;
        objInvF_InventoryIn.approveData(listInvF_InventoryIn);
    }
</script>
@* End Approve *@
@* Cancel *@
<script type="text/javascript">
    function Cancel() {
        iF_InvInNo = $('#IF_InvInNo').val();
        if (iF_InvInNo === undefined || iF_InvInNo.length == 0) {
            alert("Số phiếu nhập trống!");
            return false;
        }
        var listInvF_InventoryIn = [];

        var objDel = {};
        objDel.IF_InvInNo = iF_InvInNo;
        objDel.Remark = '';
        listInvF_InventoryIn.push(objDel);
        var objInvF_InventoryIn = new InvF_InventoryIn();
        var ajaxSettings = {};
        ajaxSettings.Type = 'post';
        ajaxSettings.DataType = 'json';
        ajaxSettings.Url = '@Url.Action("Cancel", "InvF_InventoryIn")';

        objInvF_InventoryIn.Image_Message = "<i class=\"fas fa-info-circle\"></i> THÔNG BÁO";
        objInvF_InventoryIn.Confirm_Message = "Đồng ý hủy phiếu nhập này?";
        objInvF_InventoryIn.ajaxSettings = ajaxSettings;
        objInvF_InventoryIn.cancelData(listInvF_InventoryIn);
    }
</script>
@* End Cancel *@

@*Danh mục hàng hóa*@

@*Autocomplete*@
<script type="text/javascript">
    function checkProductExists(objProduct) {
        var rows = $('tbody#table-tbodyID tr.trdata').length;
        if (rows > 0) {
            var productCode = objProduct.ProductCode;
            var productExists = false;
            $('tbody#table-tbodyID tr.trdata').each(function () {
                if (!productExists) {
                    var $trCur = $(this);
                    var productCodeCur = $trCur.attr('productcode');
                    if (productCodeCur === productCode) {
                        productExists = true;
                    }
                }
            });
            if (productExists) {
                var listToastr = [];
                var message = 'Hàng hóa "' + objProduct.ProductName + '" đã tồn tại trên lưới'
                objToastr = { ToastrType: 'error', ToastrMessage: message };
                listToastr.push(objToastr);
                commonUtils.showToastr(listToastr);
                return false;
            } else {
                return true;
            }
        } else {
            return true;
        }
    }
</script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#myInput').autocomplete({
            source: function (request, response) {
                var keyword = request.term;
                if (!commonUtils.isNullOrEmpty(keyword)) {
                    var invCodeIn = commonUtils.returnValueText('#InvCodeIn');
                    if (commonUtils.isNullOrEmpty(invCodeIn)) {
                        var listToastr = [];
                        objToastr = { ToastrType: 'error', ToastrMessage: '@MvcHtmlString.Create("Chưa chọn kho nhập".HtmlItemString("ordorderdl"))' };
                        listToastr.push(objToastr);
                        commonUtils.showToastr(listToastr);

                        $('#myInput').val('');
                        commonUtils.setFocus('InvCodeIn');
                        return false;
                    }
                    if (keyword.toString().trim().length > 1) {
                        var url = '@Url.Action("SearchProduct", "LoadData")';

                        var token = $('#manageForm input[name=__RequestVerificationToken]').val();
                        $.ajax({
                            url: url,
                            type: 'post',
                            data: {
                                prdid: keyword,
                                __RequestVerificationToken: token
                            },
                            cache: false,
                            dataType: 'json',
                            async: true,
                            success: function (objResult) {
                                debugger;
                                var listItems = [];
                                if (objResult.Success) {
                                    debugger
                                    listItems = $.map(objResult.ListMst_Product, function (data, id) {
                                        return {
                                            value: data.ProductCode,
                                            label: data.ProductCodeUser  + ' - ' + data.ProductName,
                                            //value: data.ProductName,
                                            //label: data.ProductName,
                                            //
                                            data: data
                                        };
                                    })
                                    //listItems.push({ label: "Search", value: "", isShowAll: true })
                                    response(listItems);
                                    var options = "";
                                    options += `<li >
                                                    <a href="javascript:;" onclick="ShowPopupProductSearch();">Tìm kiếm thêm</a>
                                                </li>`;
                                    $('ul#ui-id-1').append(options);
                                }
                                else {
                                    if (!commonUtils.isNullOrEmpty(objResult.Messages)) {
                                        commonUtils.showAlert(objResult.Messages[0]);
                                    }
                                    if (!commonUtils.isNullOrEmpty(objResult.Detail)) {
                                        _showErrorMsg123('Lỗi!', objResult.Detail);
                                    }
                                    response(listItems);
                                }

                            },
                            error: function (xmlHttpRequest, textStatus, errorThrown) {
                                console.log('some error occured', textStatus, errorThrown);
                            }
                        });

                    }
                }
            },
            minLength: 1,
            select: function (event, ui) {
                debugger;
                var _objProduct = ui.item.data;
                // Kiểm tra hàng hóa đã có trên lưới
                var productExists = checkProductExists(_objProduct);
                if (!productExists) {
                    return false;
                }
                else {
                    @*Lấy danh sách hàng hóa cùng base*@
                    var token = $('#manageForm input[name=__RequestVerificationToken]').val();
                    var invCodeIn = commonUtils.returnValueText('#InvCodeIn');
                    var dataInput = {
                        invcode: invCodeIn,
                        prdid: _objProduct.ProductCode,
                        __RequestVerificationToken: token,
                    };
                    $.ajax({
                        type: 'post',
                        data: dataInput,
                        url: '@Url.Action("GetProductExactly", "LoadData")',
                        dataType: 'json',
                        beforeSend: function () {
                        }
                    }).done(function (objResult) {
                        debugger;
                        if (objResult.Success) {
                            @*add hàng hóa vào lưới*@

                            if (objResult.Data !== undefined && objResult.Data !== null && objResult.Data.length > 0) {
                                @* Khởi tạo *@
                                var Lst_InvF_InventoryInDtl = [];

                                for (var i = 0; i < objResult.Data.length; i++) {
                                    var objInvF_InventoryInDtl = {
                                        ProductCodeRoot: commonUtils.returnValue(objResult.Data[i].ProductCodeRoot),
                                        ProductCodeBase: commonUtils.returnValue(objResult.Data[i].ProductCodeBase),
                                        ProductCode: commonUtils.returnValue(objResult.Data[i].ProductCode),
                                        ProductCodeUser: commonUtils.returnValue(objResult.Data[i].ProductCodeUser),
                                        ProductName: commonUtils.returnValue(objResult.Data[i].ProductName),
                                        ProductType: commonUtils.returnValue(objResult.Data[i].ProductType),
                                        //UPBuy: commonUtils.returnValue(objResult.Data[i].UPBuy),
                                        //UPSell: commonUtils.returnValue(objResult.Data[i].UPSell),
                                        //FlagActive: commonUtils.returnValue(objResult.Data[i].FlagActive),
                                        FlagLot: commonUtils.returnValue(objResult.Data[i].FlagLot),
                                        FlagSerial: commonUtils.returnValue(objResult.Data[i].FlagSerial),

                                        // Thông tin hàng hóa
                                        UnitCode: commonUtils.returnValue(objResult.Data[i].UnitCode),
                                        InvCodeInActual: commonUtils.returnValue(objResult.Data[i].InvCodeSuggest),
                                        Qty: '0',
                                        UPIn: commonUtils.returnValue(objResult.Data[i].UPBuy),
                                        UPInDesc: '0',
                                        ValInAfterDesc: '0',
                                        Remark: '',
                                    };

                                    Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl);
                                }

                                var objInvF_InventoryInDtlRender = {
                                    InvF_InventoryInDtl: Lst_InvF_InventoryInDtl[0],
                                    Lst_InvF_InventoryInDtl: Lst_InvF_InventoryInDtl,
                                };

                                renderInvF_InventoryInDtl(objInvF_InventoryInDtlRender);
                                tongTienHang();
                                $('#myInput').val('');
                                commonUtils.setFocus('InvCodeIn');
                                return false;
                            }

                        }
                        else {
                            if (!commonUtils.isNullOrEmpty(objResult.Detail)) {
                                _showErrorMsg123('Lỗi!', objResult.Detail);
                            }
                        }
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                    }).always(function () {
                    });
                }

                return false;
            }
        }).autocomplete("instance")._renderItem = function (ul, item) {
            //var div = $(commonUtils.getHtmlFromTemplate($("#templateImageAuto"), {
            //    productcode: item.Mst_ProductAutoSearch.ProductCodeUser,
            //    productname: item.label,
            //    imagepath: item.Mst_ProductAutoSearch.ProductImagePathList,
            //}));
            var li = $("<li>")
                .attr("data-value", item.value)
                .append(item.label)
                .appendTo(ul);
            if (item.isShowAll === true) {
                li.on("click", function () {
                    var orderNo = $('#OrderNo').val();
                    var url = "";
                    if (orderNo != null && orderNo != "") {
                        url = '@Url.Action("GetProductSearchOrder", "InvF_InventoryOut")';
                    }
                    else {
                        url = '@Url.Action("GetProductSearch", "ModalCommon")';
                    }
                    $.ajax({
                        url: url,
                        data: {
                            productkey: "",
                            showview: "1",
                            orderNo: orderNo
                        },
                        type: 'post',
                        dataType: 'json',
                        traditional: true,
                        success: function (data) {
                            if (data.Success) {
                                $('#ShowPopupProduct').modal({
                                    backdrop: false,
                                    keyboard: true,
                                });
                                $("#ShowPopupProduct").html(data.Html);
                                var display = $("#ShowPopupProduct").css('display');
                                if (display == "none") {
                                    $("#ShowPopupProduct").show();
                                }
                            } else {
                                showErrorDialog(data.Detail);
                            }
                        }
                    });
                    return false;
                });
                li.attr('class', 'showall');
            }
            return li;
        };;
    });
</script>
@*End Autocomplete*@

<script type="text/javascript">
    function ShowPopupProductSearch() {
        $('#ShowPopupProductSearch').modal('show');
    }
    function ClosePopupProductSearch() {
        $('#ShowPopupProductSearch').modal('hide');
        $('#ShowPopupProductSearch #List_Product_Data').html('');
        $('#ShowPopupProductSearch #ProductName').val('');
    }
</script>

@*Thêm hàng hóa vào lưới - Xóa hàng hóa khỏi lưới*@
@*Thêm hàng hóa vào lưới - Trường hợp thêm nhiều hàng hóa xử lý hới khác*@
<script type="text/javascript">
    function renderInvF_InventoryInDtl_Multi(data) {
        debugger;
        var date = new Date();
        var randomCur = date.getTime();
        var randHex = commonUtils.randHex(12);
        randomCur = randomCur + randHex;

        var objInvF_InventoryInDtl = data.InvF_InventoryInDtl;
        var listInvF_InventoryInDtl = data.Lst_InvF_InventoryInDtl;
        var listProductBase = data.Lst_InvF_InventoryOutBase;

        if (objInvF_InventoryInDtl !== undefined && objInvF_InventoryInDtl !== null) {
            var productCode = commonUtils.returnValue(objInvF_InventoryInDtl.ProductCode);
            var productCodeBase = commonUtils.returnValue(objInvF_InventoryInDtl.ProductCodeBase);
            if (!commonUtils.isNullOrEmpty(productCode)) {

                var productcoderootCss = 'productcoderoot-' + randomCur;
                var productcodebaseCss = 'productcodebase-' + randomCur;
                var productcodeCss = 'productcode-' + randomCur;
                var productcodeuserCss = 'productcodeuser-' + randomCur;
                var producttypeCss = 'producttype-' + randomCur;
                var productnameCss = 'productname-' + randomCur;
                var select2Css = 'select2-' + randomCur;
                var qtyCss = 'qty-' + randomCur;
                var invcodeinactualCss = 'invcodeinactual-' + randomCur;
                var invcodeinactualtypeCss = 'invcodeinactualtype-' + randomCur;
                var upinCss = 'upin-' + randomCur;
                var upindescCss = 'upindesc-' + randomCur;
                var valinafterdescCss = 'valinafterdesc-' + randomCur;
                var flaglotCss = 'flaglot-' + randomCur;
                var flagserialCss = 'flagserial-' + randomCur;
                var planqtyCss = 'planqty-' + randomCur;
                var remarkCss = 'remark-' + randomCur;

                var extData = {
                    productcoderootCss: productcoderootCss,
                    productcodebaseCss: productcodebaseCss,
                    productcodeCss: productcodeCss,
                    productcodeuserCss: productcodeuserCss,
                    producttypeCss: producttypeCss,
                    productnameCss: productnameCss,
                    select2Css: select2Css,
                    qtyCss: qtyCss,
                    invcodeinactualCss: invcodeinactualCss,
                    invcodeinactualtypeCss: invcodeinactualtypeCss,
                    upinCss: upinCss,
                    upindescCss: upindescCss,
                    valinafterdescCss: valinafterdescCss,
                    flaglotCss: flaglotCss,
                    flagserialCss: flagserialCss,
                    planqtyCss: planqtyCss,
                    remarkCss: remarkCss,
                    rd: randomCur,
                    idx: 9999,
                };

                var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_InvF_InventoryIn'), objInvF_InventoryInDtl, extData));
                var $tableProduct_InvCodeInActual_Cache = $('#table-detailInvCodeInActual'); @*Cache hàng hóa - vị trí*@
                var flagLot = commonUtils.returnValue(objInvF_InventoryInDtl.FlagLot);
                var flagSerial = commonUtils.returnValue(objInvF_InventoryInDtl.FlagSerial);
                if (flagLot === '0' && flagSerial === '0') {
                    var $spanInvCodeInActualType = $item.find('span.' + invcodeinactualtypeCss);
                    if ($spanInvCodeInActualType !== undefined && $spanInvCodeInActualType !== null && $spanInvCodeInActualType.length > 0) {
                        @* Nếu hàng hóa không quản lý LOT và Serail(Hàng hóa thường ???) thì add tùy chọn show popup vị trí nhập *@
                        var extData_InvCodeInActualType = {};
                        var $invCodeInActualType = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_InvCodeInActual'), objInvF_InventoryInDtl, extData_InvCodeInActualType));
                        $invCodeInActualType.appendTo($spanInvCodeInActualType);
                    }
                }
                else {

                    var $inputQty = $item.find('input.' + qtyCss);
                    if ($inputQty !== undefined && $inputQty !== null && $inputQty.length > 0) {
                        if (!$inputQty.hasClass('disabled-fix')) {
                            $inputQty.addClass('disabled-fix');
                        }
                    }

                    var $spanProductType = $item.find('span.' + producttypeCss);
                    if ($spanProductType !== undefined && $spanProductType !== null && $spanProductType.length > 0) {
                        @* Nếu hàng hóa quản lý LOT hoặc Serail thì add tùy chọn show popup LOT hoặc Serail tương ứng *@
                        var extData_ProductType = {};
                        if (flagLot === '1') {
                            var $productTypeLOT = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_FlagLot'), objInvF_InventoryInDtl, extData_ProductType));
                            $productTypeLOT.appendTo($spanProductType);
                        }
                        else if (flagSerial === '1') {
                            var $productTypeSerial = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_FlagSerial'), objInvF_InventoryInDtl, extData_ProductType));
                            $productTypeSerial.appendTo($spanProductType);
                        }
                    }
                }

                if (listInvF_InventoryInDtl !== undefined && listInvF_InventoryInDtl !== null && listInvF_InventoryInDtl.length > 0) {

                    for (var i = 0; i < listInvF_InventoryInDtl.length; i++) {

                        var productCodeCur = commonUtils.returnValue(listInvF_InventoryInDtl[i].ProductCode);
                        var flagLotCur = commonUtils.returnValue(listInvF_InventoryInDtl[i].FlagLot);
                        var flagSerialCur = commonUtils.returnValue(listInvF_InventoryInDtl[i].FlagSerial);
                        @* Add danh sách hàng hóa cache *@
                        var $divProducts = $item.find('div.products-list');
                        if ($divProducts !== undefined && $divProducts !== null && $divProducts.length > 0) {
                            debugger;
                            var $product = $(commonUtils.getHtmlFromTemplate($('#tmpl_products_list'), listInvF_InventoryInDtl[i]));
                            $product.appendTo($divProducts);
                        }

                        @* Add đơn vị hàng hóa *@
                        //var $select = $item.find('select.select2');
                        //if ($select !== undefined && $select !== null) {
                        //    var $optgroup = $select.find('optgroup');
                        //    if ($optgroup !== undefined && $optgroup !== null) {
                        //        var selected = '';
                        //        if (productCode === productCodeCur) {
                        //            selected = 'selected="selected"';
                        //        }

                        //        var extData_Options = {
                        //            selected: selected,
                        //        };
                        //        var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_options'), listInvF_InventoryInDtl[i], extData_Options));
                        //        $option.appendTo($optgroup);
                        //    }
                        //}

                        @* Nếu hàng hóa không quản lý LOT và Serail(Hàng hóa thường ???) thì vào bảng cache hàng hóa - vị trí *@

                        if (flagLotCur === '0' && flagSerialCur === '0') {
                            debugger
                            //find('tr[productcode="' + productCode + '"]');
                            @* Tìm bản ghi hàng hóa đã được cache trong bảng hàng hóa - vị trí cache *@
                            var $trProductInvCodeInActualCache = $tableProduct_InvCodeInActual_Cache.find('tr[productcode="' + productCode + '"]');
                            if ($trProductInvCodeInActualCache !== undefined && $trProductInvCodeInActualCache !== null && $trProductInvCodeInActualCache.length > 0) {
                                var $divList_Product_InvCodeInActual_Cache = $trProductInvCodeInActualCache.find('div.products-list-cache');
                                if ($divList_Product_InvCodeInActual_Cache !== undefined && $divList_Product_InvCodeInActual_Cache !== null && $divList_Product_InvCodeInActual_Cache.length > 0) {
                                    var extData_Product_InvCodeInActual = {
                                        idx: 99999,
                                    };
                                    var $divProduct_InvCodeInActual = $(commonUtils.getHtmlFromTemplate($('#tmpl_product_invcodeinactual_list_cache'), listInvF_InventoryInDtl[i], extData_Product_InvCodeInActual));
                                    $divProduct_InvCodeInActual.appendTo($divList_Product_InvCodeInActual_Cache);
                                }
                            }

                        }
                    }
                }

                if (listProductBase !== undefined && listProductBase !== null && listProductBase.length > 0) {
                    debugger
                    for (var itemBase = 0; itemBase < listProductBase.length; itemBase++) {
                        var productCodeBaseCur = listProductBase[itemBase].LstProductAutoSearchBase.ProductCodeBase;
                        var productCodeCur = listProductBase[itemBase].LstProductAutoSearchBase.ProductCode;

                        if (productCodeBase === productCodeBaseCur) {
                            @* Add danh sách hàng hóa cache *@
                            var $divProducts = $item.find('div.products-list');
                            if ($divProducts !== undefined && $divProducts !== null && $divProducts.length > 0) {
                                debugger;
                                var $product = $(commonUtils.getHtmlFromTemplate($('#tmpl_products_list'), listProductBase[itemBase].LstProductAutoSearchBase));
                                $product.appendTo($divProducts);

                            }
                            @* Add đơn vị hàng hóa *@
                            var $select = $item.find('select.select2');
                            if ($select !== undefined && $select !== null) {
                                var $optgroup = $select.find('optgroup');
                                if ($optgroup !== undefined && $optgroup !== null) {
                                    var selected = '';
                                    if (productCode === productCodeCur) {
                                        selected = 'selected="selected"';
                                    }

                                    var extData_Options = {
                                        selected: selected,
                                    };
                                    var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_options'), listProductBase[itemBase].LstProductAutoSearchBase, extData_Options));
                                    $option.appendTo($optgroup);
                                }
                                var $tdSelect2 = $select.parent();
                                if ($tdSelect2 !== undefined && $tdSelect2 !== null && $tdSelect2.length > 0) {
                                    if (!$tdSelect2.hasClass('disabled-fix')) {
                                        $tdSelect2.addClass('disabled-fix');
                                    }
                                }
                                
                            }

                        }

                    }


                }


                $item.appendTo($('#table-tbodyID'));
                debugger;
                @* format number *@
                var tableName = 'InvF_InventoryIn';
                var qtyformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'Qty');
                var upinformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'UPIn');
                var upindescformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'UPInDesc');
                var valinafterdescformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'TotalValInAfterDesc');

                $('.' + qtyCss).number(true, qtyformat);
                $('.' + upinCss).number(true, upinformat);
                $('.' + upindescCss).number(true, upindescformat);
                $('.' + valinafterdescCss).number(true, valinafterdescformat);

                $('.' + select2Css).select2({
                    minimumResultsForSearch: -1
                });

                //if (!$('.' + select2Css).hasClass('disabled-fix')) {
                //    $('.' + select2Css).addClass('disabled-fix');
                //}

                tongTienHang();
                commonUtils.updateTableTrNotShowIdx($('#table-tbodyID tr.trdata'), true);
            }
        }
    }
    function renderInvF_InventoryInDtl_MultiExcel(data) {
        debugger;
        var date = new Date();
        var randomCur = date.getTime();
        var randHex = commonUtils.randHex(12);
        randomCur = randomCur + randHex;

        var objInvF_InventoryInDtl = data.InvF_InventoryInDtl;
        var listInvF_InventoryInDtl = data.Lst_InvF_InventoryInDtl;
        var listProductBase = data.Lst_InvF_InventoryOutBase;

        if (objInvF_InventoryInDtl !== undefined && objInvF_InventoryInDtl !== null) {
            var productCode = commonUtils.returnValue(objInvF_InventoryInDtl.ProductCode);
            var productCodeBase = commonUtils.returnValue(objInvF_InventoryInDtl.ProductCodeBase);
            if (!commonUtils.isNullOrEmpty(productCode)) {

                var productcoderootCss = 'productcoderoot-' + randomCur;
                var productcodebaseCss = 'productcodebase-' + randomCur;
                var productcodeCss = 'productcode-' + randomCur;
                var productcodeuserCss = 'productcodeuser-' + randomCur;
                var producttypeCss = 'producttype-' + randomCur;
                var productnameCss = 'productname-' + randomCur;
                var select2Css = 'select2-' + randomCur;
                var qtyCss = 'qty-' + randomCur;
                var invcodeinactualCss = 'invcodeinactual-' + randomCur;
                var invcodeinactualtypeCss = 'invcodeinactualtype-' + randomCur;
                var upinCss = 'upin-' + randomCur;
                var upindescCss = 'upindesc-' + randomCur;
                var valinafterdescCss = 'valinafterdesc-' + randomCur;
                var flaglotCss = 'flaglot-' + randomCur;
                var flagserialCss = 'flagserial-' + randomCur;
                var remarkCss = 'remark-' + randomCur;

                var extData = {
                    productcoderootCss: productcoderootCss,
                    productcodebaseCss: productcodebaseCss,
                    productcodeCss: productcodeCss,
                    productcodeuserCss: productcodeuserCss,
                    producttypeCss: producttypeCss,
                    productnameCss: productnameCss,
                    select2Css: select2Css,
                    qtyCss: qtyCss,
                    invcodeinactualCss: invcodeinactualCss,
                    invcodeinactualtypeCss: invcodeinactualtypeCss,
                    upinCss: upinCss,
                    upindescCss: upindescCss,
                    valinafterdescCss: valinafterdescCss,
                    flaglotCss: flaglotCss,
                    flagserialCss: flagserialCss,
                    remarkCss: remarkCss,
                    rd: randomCur,
                    idx: 9999,
                };

                var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_InvF_InventoryIn'), objInvF_InventoryInDtl, extData));
                var $tableProduct_InvCodeInActual_Cache = $('#table-detailInvCodeInActual'); @* Cache hàng hóa - vị trí *@
                var flagLot = commonUtils.returnValue(objInvF_InventoryInDtl.FlagLot);
                var flagSerial = commonUtils.returnValue(objInvF_InventoryInDtl.FlagSerial);
                if (flagLot === '0' && flagSerial === '0') {
                    var $spanInvCodeInActualType = $item.find('span.' + invcodeinactualtypeCss);
                    if ($spanInvCodeInActualType !== undefined && $spanInvCodeInActualType !== null && $spanInvCodeInActualType.length > 0) {
                        @* Nếu hàng hóa không quản lý LOT và Serail(Hàng hóa thường ???) thì add tùy chọn show popup vị trí nhập *@
                        var extData_InvCodeInActualType = {};
                        var $invCodeInActualType = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_InvCodeInActual'), objInvF_InventoryInDtl, extData_InvCodeInActualType));
                        $invCodeInActualType.appendTo($spanInvCodeInActualType);
                    }
                }
                else {

                    var $inputQty = $item.find('input.' + qtyCss);
                    if ($inputQty !== undefined && $inputQty !== null && $inputQty.length > 0) {
                        if (!$inputQty.hasClass('disabled-fix')) {
                            $inputQty.addClass('disabled-fix');
                        }
                    }

                    var $spanProductType = $item.find('span.' + producttypeCss);
                    if ($spanProductType !== undefined && $spanProductType !== null && $spanProductType.length > 0) {
                        @* Nếu hàng hóa quản lý LOT hoặc Serail thì add tùy chọn show popup LOT hoặc Serail tương ứng *@
                        var extData_ProductType = {};
                        if (flagLot === '1') {
                            var $productTypeLOT = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_FlagLot'), objInvF_InventoryInDtl, extData_ProductType));
                            $productTypeLOT.appendTo($spanProductType);
                        }
                        else if (flagSerial === '1') {
                            var $productTypeSerial = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_FlagSerial'), objInvF_InventoryInDtl, extData_ProductType));
                            $productTypeSerial.appendTo($spanProductType);
                        }
                    }
                }

                if (listInvF_InventoryInDtl !== undefined && listInvF_InventoryInDtl !== null && listInvF_InventoryInDtl.length > 0) {

                    for (var i = 0; i < listInvF_InventoryInDtl.length; i++) {

                        var productCodeCur = commonUtils.returnValue(listInvF_InventoryInDtl[i].ProductCode);
                        var flagLotCur = commonUtils.returnValue(listInvF_InventoryInDtl[i].FlagLot);
                        var flagSerialCur = commonUtils.returnValue(listInvF_InventoryInDtl[i].FlagSerial);
                        @* Add danh sách hàng hóa cache *@
                        var $divProducts = $item.find('div.products-list');
                        if ($divProducts !== undefined && $divProducts !== null && $divProducts.length > 0) {
                            debugger;
                            var $product = $(commonUtils.getHtmlFromTemplate($('#tmpl_products_list'), listInvF_InventoryInDtl[i]));
                            $product.appendTo($divProducts);
                        }

                        @* Add đơn vị hàng hóa *@
                        var $select = $item.find('select.select2');
                        if ($select !== undefined && $select !== null) {
                            var $optgroup = $select.find('optgroup');
                            if ($optgroup !== undefined && $optgroup !== null) {
                                var selected = '';
                                if (productCode === productCodeCur) {
                                    selected = 'selected="selected"';
                                }

                                var extData_Options = {
                                    selected: selected,
                                };
                                var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_options'), listInvF_InventoryInDtl[i], extData_Options));
                                $option.appendTo($optgroup);
                            }

                            var $tdSelect2 = $select.parent();
                            if ($tdSelect2 !== undefined && $tdSelect2 !== null && $tdSelect2.length > 0) {
                                if (!$tdSelect2.hasClass('disabled-fix')) {
                                    $tdSelect2.addClass('disabled-fix');
                                }
                            }
                        }

                        @* Nếu hàng hóa không quản lý LOT và Serail(Hàng hóa thường ???) thì vào bảng cache hàng hóa - vị trí *@

                        if (flagLotCur === '0' && flagSerialCur === '0') {
                            //find('tr[productcode="' + productCode + '"]');
                            @* Tìm bản ghi hàng hóa đã được cache trong bảng hàng hóa - vị trí cache *@
                            var $trProductInvCodeInActualCache = $tableProduct_InvCodeInActual_Cache.find('tr[productcode="' + productCode + '"]');
                            if ($trProductInvCodeInActualCache !== undefined && $trProductInvCodeInActualCache !== null && $trProductInvCodeInActualCache.length > 0) {
                                var $divList_Product_InvCodeInActual_Cache = $trProductInvCodeInActualCache.find('div.products-list-cache');
                                if ($divList_Product_InvCodeInActual_Cache !== undefined && $divList_Product_InvCodeInActual_Cache !== null && $divList_Product_InvCodeInActual_Cache.length > 0) {
                                    var extData_Product_InvCodeInActual = {
                                        idx: 99999,
                                    };
                                    var $divProduct_InvCodeInActual = $(commonUtils.getHtmlFromTemplate($('#tmpl_product_invcodeinactual_list_cache'), listInvF_InventoryInDtl[i], extData_Product_InvCodeInActual));
                                    $divProduct_InvCodeInActual.appendTo($divList_Product_InvCodeInActual_Cache);
                                }
                            }

                        }
                    }
                }



                $item.appendTo($('#table-tbodyID'));
                debugger;
                @* format number *@
                var tableName = 'InvF_InventoryIn';
                var qtyformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'Qty');
                var upinformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'UPIn');
                var upindescformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'UPInDesc');
                var valinafterdescformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'ValInAfterDesc');

                $('.' + qtyCss).number(true, qtyformat);
                $('.' + upinCss).number(true, upinformat);
                $('.' + upindescCss).number(true, upindescformat);
                $('.' + valinafterdescCss).number(true, valinafterdescformat);

                $('.' + select2Css).select2({
                    minimumResultsForSearch: -1
                });

                tongTienHang();
                commonUtils.updateTableTrNotShowIdx($('#table-tbodyID tr.trdata'), true);
            }
        }
    }
</script>
<script type="text/javascript">
    function renderInvF_InventoryInDtl(data) {
        debugger;
        var date = new Date();
        var randomCur = date.getTime();
        var randHex = commonUtils.randHex(12);
        randomCur = randomCur + randHex;

        var objInvF_InventoryInDtl = data.InvF_InventoryInDtl;
        var listInvF_InventoryInDtl = data.Lst_InvF_InventoryInDtl;

        if (objInvF_InventoryInDtl !== undefined && objInvF_InventoryInDtl !== null) {
            var productCode = commonUtils.returnValue(objInvF_InventoryInDtl.ProductCode);
            if (!commonUtils.isNullOrEmpty(productCode)) {

                var productcoderootCss = 'productcoderoot-' + randomCur;
                var productcodebaseCss = 'productcodebase-' + randomCur;
                var productcodeCss = 'productcode-' + randomCur;
                var productcodeuserCss = 'productcodeuser-' + randomCur;
                var producttypeCss = 'producttype-' + randomCur;
                var productnameCss = 'productname-' + randomCur;
                var select2Css = 'select2-' + randomCur;
                var qtyCss = 'qty-' + randomCur;
                var invcodeinactualCss = 'invcodeinactual-' + randomCur;
                var invcodeinactualtypeCss = 'invcodeinactualtype-' + randomCur;
                var upinCss = 'upin-' + randomCur;
                var upindescCss = 'upindesc-' + randomCur;
                var valinafterdescCss = 'valinafterdesc-' + randomCur;
                var flaglotCss = 'flaglot-' + randomCur;
                var flagserialCss = 'flagserial-' + randomCur;
                var remarkCss = 'remark-' + randomCur;
                var planqtyCss = 'planqty-' + randomCur;

                var extData = {
                    productcoderootCss: productcoderootCss,
                    productcodebaseCss: productcodebaseCss,
                    productcodeCss: productcodeCss,
                    productcodeuserCss: productcodeuserCss,
                    producttypeCss: producttypeCss,
                    productnameCss: productnameCss,
                    select2Css: select2Css,
                    qtyCss: qtyCss,
                    invcodeinactualCss: invcodeinactualCss,
                    invcodeinactualtypeCss: invcodeinactualtypeCss,
                    upinCss: upinCss,
                    upindescCss: upindescCss,
                    valinafterdescCss: valinafterdescCss,
                    flaglotCss: flaglotCss,
                    flagserialCss: flagserialCss,
                    remarkCss: remarkCss,
                    planqtyCss: planqtyCss,
                    rd: randomCur,
                    idx: 9999,
                };

                var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_InvF_InventoryIn'), objInvF_InventoryInDtl, extData));
                var $tableProduct_InvCodeInActual_Cache = $('#table-detailInvCodeInActual'); @*Cache hàng hóa - vị trí*@
                var flagLot = commonUtils.returnValue(objInvF_InventoryInDtl.FlagLot);
                var flagSerial = commonUtils.returnValue(objInvF_InventoryInDtl.FlagSerial);
                if (flagLot === '0' && flagSerial === '0') {
                    var $spanInvCodeInActualType = $item.find('span.' + invcodeinactualtypeCss);
                    if ($spanInvCodeInActualType !== undefined && $spanInvCodeInActualType !== null && $spanInvCodeInActualType.length > 0) {
                        @* Nếu hàng hóa không quản lý LOT và Serail(Hàng hóa thường ???) thì add tùy chọn show popup vị trí nhập *@
                        var extData_InvCodeInActualType = {};
                        var $invCodeInActualType = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_InvCodeInActual'), objInvF_InventoryInDtl, extData_InvCodeInActualType));
                        $invCodeInActualType.appendTo($spanInvCodeInActualType);
                    }

                    @*Add cache hàng hóa - vị trí**@
                    var extData_Product_InvCodeInActual_Cache = {};
                    var $trProduct_InvCodeInActual_Cache = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_InvCodeInActual'), objInvF_InventoryInDtl, extData_Product_InvCodeInActual_Cache));
                    $trProduct_InvCodeInActual_Cache.appendTo($tableProduct_InvCodeInActual_Cache);
                }
                else {

                    var $inputQty = $item.find('input.' + qtyCss);
                    if ($inputQty !== undefined && $inputQty !== null && $inputQty.length > 0) {
                        if (!$inputQty.hasClass('disabled-fix')) {
                            $inputQty.addClass('disabled-fix');
                        }
                    }

                    var $spanProductType = $item.find('span.' + producttypeCss);
                    if ($spanProductType !== undefined && $spanProductType !== null && $spanProductType.length > 0) {
                        @* Nếu hàng hóa quản lý LOT hoặc Serail thì add tùy chọn show popup LOT hoặc Serail tương ứng *@
                        var extData_ProductType = {};
                        if (flagLot === '1') {
                            var $productTypeLOT = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_FlagLot'), objInvF_InventoryInDtl, extData_ProductType));
                            $productTypeLOT.appendTo($spanProductType);
                        }
                        else if (flagSerial === '1') {
                            var $productTypeSerial = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_FlagSerial'), objInvF_InventoryInDtl, extData_ProductType));
                            $productTypeSerial.appendTo($spanProductType);
                        }
                    }
                }


                if (listInvF_InventoryInDtl !== undefined && listInvF_InventoryInDtl !== null && listInvF_InventoryInDtl.length > 0) {

                    for (var i = 0; i < listInvF_InventoryInDtl.length; i++) {

                        var productCodeCur = commonUtils.returnValue(listInvF_InventoryInDtl[i].ProductCode);
                        var flagLotCur = commonUtils.returnValue(listInvF_InventoryInDtl[i].FlagLot);
                        var flagSerialCur = commonUtils.returnValue(listInvF_InventoryInDtl[i].FlagSerial);
                        @* Add danh sách hàng hóa cache *@
                        var $divProducts = $item.find('div.products-list');
                        if ($divProducts !== undefined && $divProducts !== null && $divProducts.length > 0) {
                            debugger;
                            var $product = $(commonUtils.getHtmlFromTemplate($('#tmpl_products_list'), listInvF_InventoryInDtl[i]));
                            $product.appendTo($divProducts);
                        }

                        @* Add đơn vị hàng hóa *@
                        var $select = $item.find('select.select2');
                        if ($select !== undefined && $select !== null) {
                            var $optgroup = $select.find('optgroup');
                            if ($optgroup !== undefined && $optgroup !== null) {
                                var selected = '';
                                if (productCode === productCodeCur) {
                                    selected = 'selected="selected"';
                                }

                                var extData_Options = {
                                    selected: selected,
                                };
                                var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_options'), listInvF_InventoryInDtl[i], extData_Options));
                                $option.appendTo($optgroup);
                            }
                            var $tdSelect2 = $select.parent();
                            if ($tdSelect2 !== undefined && $tdSelect2 !== null && $tdSelect2.length > 0) {
                                if (!$tdSelect2.hasClass('disabled-fix')) {
                                    $tdSelect2.addClass('disabled-fix');
                                }
                            }
                        }

                        @* Nếu hàng hóa không quản lý LOT và Serail(Hàng hóa thường ???) thì vào bảng cache hàng hóa - vị trí *@

                        if (flagLotCur === '0' && flagSerialCur === '0') {
                            //find('tr[productcode="' + productCode + '"]');
                            @*Tìm bản ghi hàng hóa đã được cache trong bảng hàng hóa - vị trí cache*@
                            var $trProductInvCodeInActualCache = $tableProduct_InvCodeInActual_Cache.find('tr[productcode="' + productCode + '"]');
                            if ($trProductInvCodeInActualCache !== undefined && $trProductInvCodeInActualCache !== null && $trProductInvCodeInActualCache.length > 0) {
                                var $divList_Product_InvCodeInActual_Cache = $trProductInvCodeInActualCache.find('div.products-list-cache');
                                if ($divList_Product_InvCodeInActual_Cache !== undefined && $divList_Product_InvCodeInActual_Cache !== null && $divList_Product_InvCodeInActual_Cache.length > 0) {
                                    var extData_Product_InvCodeInActual = {
                                        idx: 99999,
                                    };
                                    var $divProduct_InvCodeInActual = $(commonUtils.getHtmlFromTemplate($('#tmpl_product_invcodeinactual_list_cache'), listInvF_InventoryInDtl[i], extData_Product_InvCodeInActual));
                                    $divProduct_InvCodeInActual.appendTo($divList_Product_InvCodeInActual_Cache);
                                }
                            }

                        }
                    }
                }

                $item.appendTo($('#table-tbodyID'));
                debugger;
                @* format number *@
                var tableName = 'InvF_InventoryIn';
                var qtyformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'Qty');
                var upinformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'UPIn');
                var upindescformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'UPInDesc');
                var valinafterdescformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'TotalValInAfterDesc');

                $('.' + qtyCss).number(true, qtyformat);
                $('.' + upinCss).number(true, upinformat);
                $('.' + upindescCss).number(true, upindescformat);
                $('.' + valinafterdescCss).number(true, valinafterdescformat);

                $('.' + select2Css).select2({
                    minimumResultsForSearch: -1
                });
                commonUtils.updateTableTrNotShowIdx($('#table-tbodyID tr.trdata'), true);
                commonUtils.updateTableTrNotShowIdx($('#table-detailInvCodeInActual tr.trdata'), true);
            }
        }


    }
</script>
<script type="text/javascript">
    function deleteRow(thiz) {
        var rows = $('tbody#table-tbodyID tr.trdata').length;
        if (rows > 0) {
            debugger;
            var $tr = $(thiz).parent().parent();
            if ($tr !== undefined && $tr !== null) {
                var rd = $tr.attr('rd');
                var productCode = $tr.attr('productcode');
                @*Xóa cache*@
                var flagLOT = commonUtils.returnValue($tr.find('input.flaglot-' + rd).val());
                var flagSerial = commonUtils.returnValue($tr.find('input.flagserial-' + rd).val());
                var rowOlds = 0;
                if (flagLOT === '0' && flagSerial === '0') {
                    rowOlds = $('#table-detailInvCodeInActual').find('tr[productcode="' + productCode + '"]').length;
                    if (rowOlds > 0) {
                        $('#table-detailInvCodeInActual').find('tr[productcode="' + productCode + '"]').each(function () {
                            $(this).remove();
                        });
                        commonUtils.updateTableTrNotShowIdx($('#table-detailInvCodeInActual tr.trdata'), true);
                    }
                }
                else if (flagLOT === '1') {
                    rowOlds = $('#table-detailLot').find('tr[productcode="' + productCode + '"]').length;
                    if (rowOlds > 0) {
                        $('#table-detailLot').find('tr[productcode="' + productCode + '"]').each(function () {
                            $(this).remove();
                        });
                        commonUtils.updateTableTrNotShowIdx($('#table-detailLot tr.trdata'), true);
                    }
                }
                else if (flagSerial === '1') {
                    rowOlds = $('#table-detailSerial').find('tr[productcode="' + productCode + '"]').length;
                    if (rowOlds > 0) {
                        $('#table-detailSerial').find('tr[productcode="' + productCode + '"]').each(function () {
                            $(this).remove();
                        });
                        commonUtils.updateTableTrNotShowIdx($('#table-detailSerial tr.trdata'), true);
                    }
                }

                $tr.remove();

            }
            if (rows > 1) {
                commonUtils.updateTableTrNotShowIdx($('tbody#table-tbodyID tr.trdata'), true);

            } else {
                // Css lại table head
            }
            tongTienHang();
        }
    }
</script>
@*End Thêm hàng hóa vào lưới*@

@*Xử lý tính toán và thay đổi đơn vị trên lưới hàng hóa*@
<script type="text/javascript">
    function resetTable_Empty() {
        $('#table-tbodyID').empty();
        $('#table-detailLot').empty();
        $('#table-detailSerial').empty();
        $('#table-detailInvCodeInActual').empty();
        $('#table-tbodyIDXacThuc').empty();
        tongTienHang();
    }
</script>
<script type="text/javascript">
    function List_InvF_InventoryInDtl() {
        debugger;
        @* Danh sách hàng hóa(lưới hàng hóa chính) *@
        var Lst_InvF_InventoryInDtl = [];
        var rowsProductData = $('tbody#table-tbodyID tr.trdata').length;
        if (rowsProductData > 0) {
            $('tbody#table-tbodyID tr.trdata').each(function () {
                debugger;
                var $tr = $(this);
                var objInvF_InventoryInDtl = {};
                var productcode = commonUtils.returnValue($tr.attr('productcode'));
                objInvF_InventoryInDtl.ProductCode = productcode;
                Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl);
            });
        }

        return Lst_InvF_InventoryInDtl;
    }
</script>

<script type="text/javascript">
    function tongTienHang() {
        var tongtienhang = 0.0;
        var giamgia = 0.0;
        var tongtientrancc = 0.0;
        var tongsl = 0.0;
        var rows = $('tbody#table-tbodyID tr').length;
        if (rows > 0) {
            $("#table-tbodyID tr.trdata").each(function () {

                var $tr = $(this);
                var rd = $tr.attr('rd');
                var fQty = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.qty-' + rd).val()));
                var fUPIn = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.upin-' + rd).val()));
                var fUPInDesc = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.upindesc-' + rd).val()));

                var fValInAfterDesc = (fUPIn - fUPInDesc) * fQty;
                $tr.find('input.valinafterdesc-' + rd).val(fValInAfterDesc);
                tongtientrancc += fValInAfterDesc;
                tongtienhang += (fUPIn * fQty);
                tongsl += fQty;

            });
        }

        giamgia = tongtienhang - tongtientrancc;
        if ($('#TotalValIn').length) {
            $('#TotalValIn').val(tongtienhang);
        }
        if ($('#TotalValInDesc').length) {
            $('#TotalValInDesc').val(giamgia);
        }
        if ($('#TotalValInAfterDesc').length) {
            $('#TotalValInAfterDesc').val(tongtientrancc);
        }

        document.getElementById('spanTotalPrd').textContent = tongsl;
    }
</script>
<script type="text/javascript">
    function inputQty(thiz) {
        setTimeout(function () {
            debugger;
            var $tr = $(thiz).parent().parent();
            var rd = $tr.attr('rd');

            var checked = $('#FlagNhapTuDH').prop('checked');

            var listError = [];

            var fQty = 0.0;
            var qty = commonUtils.returnValue($(thiz).val());

            var planQty = commonUtils.parseFloat(commonUtils.returnValue($tr.find('td.Qty input.planqty-' + rd).val()));

            if (commonUtils.isNullOrEmpty(qty)) {
                var objToastr = {
                    ToastrType: 'error',
                    ToastrMessage: 'Vui lòng nhập số lượng',
                };
                listError.push(objToastr);
            }
            else {
                fQty = commonUtils.parseFloat(qty);
                if (fQty <= 0) {
                    var objToastr = {
                        ToastrType: 'error',
                        ToastrMessage: 'Số lượng phải > 0',
                    };
                    listError.push(objToastr);
                }
            }

            if (listError !== undefined && listError !== null && listError.length > 0) {
                commonUtils.showToastr(listError);
                return false;
            }
            else {

                if (planQty < fQty && checked === true) {
                    bootbox.confirm({
                        title: 'THÔNG BÁO',
                        message: 'Số lượng nhập kho vượt quá số lượng đặt hàng sản xuất. Bạn có chắc muốn nhập?',
                        buttons: {
                            'cancel': {
                                label: 'Cancel',
                                className: 'btn mybtn-Button btnButton'
                            },
                            'confirm': {
                                label: 'Yes',
                                className: 'btn mybtn-Button btnButton'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                var fUPIn = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.upin-' + rd).val()));
                                var fUPInDesc = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.upindesc-' + rd).val()));

                                var fValInAfterDesc = (fUPIn - fUPInDesc) * fQty;
                                $tr.find('input.valinafterdesc-' + rd).val(fValInAfterDesc);
                                $tr.find('input.qty-' + rd).val(qty);

                                tongTienHang();
                                debugger;
                                @* Update Số lượng, Thành tiền vào cache danh sách hàng hóa(lưới hàng hóa chính) *@
                                var productCode = $tr.attr('productcode');
                                //var $divProducts = $tr.find('div.products-list');
                                //var $divProduct = $divProducts.find('div[productcode="' + productCode + '"]');
                                //if ($divProduct !== undefined && $divProduct !== null && $divProduct.length > 0) {
                                //    $divProduct.find('input.Qty').val(fQty);
                                //    $divProduct.find('input.ValInAfterDesc').val(fValInAfterDesc);
                                //}

                                //Cập nhật SL hàng hóa tại các vị trí (Mặc định gán số lượng cho vị trí đầu tiên, các vị trí còn lại gán = 0)

                                if (!commonUtils.isNullOrEmpty(productCode)) {
                                    $('#table-detailInvCodeInActual').find('tr[productcode="' + productCode + '"]').each(function () {
                                        debugger;
                                        var $trInvCodeInActual = $(this);
                                        if ($trInvCodeInActual !== undefined && $trInvCodeInActual !== null && $trInvCodeInActual.length > 0) {
                                            var $divList_Product_InvCodeInActual_Cache = $trInvCodeInActual.find('div.products-list-cache');
                                            $divList_Product_InvCodeInActual_Cache.find('div.result[productcode="' + productCode + '"]').each(function () {
                                                var $div = $(this);
                                                $div.find('input.Qty').val(fQty);
                                                //fQty = 0.0;
                                            });
                                        }
                                    });
                                }

                            }
                            else {
                               
                            }
                        }
                    });
                }   
                else {

                    var fUPIn = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.upin-' + rd).val()));
                    var fUPInDesc = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.upindesc-' + rd).val()));

                    var fValInAfterDesc = (fUPIn - fUPInDesc) * fQty;
                    $tr.find('input.valinafterdesc-' + rd).val(fValInAfterDesc);
                    $tr.find('input.qty-' + rd).val(qty);

                    tongTienHang();
                    debugger;
                @* Update Số lượng, Thành tiền vào cache danh sách hàng hóa (lưới hàng hóa chính) *@
                    var productCode = $tr.attr('productcode');
                    //var $divProducts = $tr.find('div.products-list');
                    //var $divProduct = $divProducts.find('div[productcode="' + productCode + '"]');
                    //if ($divProduct !== undefined && $divProduct !== null && $divProduct.length > 0) {
                    //    $divProduct.find('input.Qty').val(fQty);
                    //    $divProduct.find('input.ValInAfterDesc').val(fValInAfterDesc);
                    //}

                    //Cập nhật SL hàng hóa tại các vị trí (Mặc định gán số lượng cho vị trí đầu tiên, các vị trí còn lại gán = 0)

                    if (!commonUtils.isNullOrEmpty(productCode)) {
                        $('#table-detailInvCodeInActual').each(function () {
                            debugger;
                            var $trInvCodeInActual = $(this);
                            if ($trInvCodeInActual !== undefined && $trInvCodeInActual !== null && $trInvCodeInActual.length > 0) {
                                var $divList_Product_InvCodeInActual_Cache = $trInvCodeInActual.find('div.products-list-cache');
                                $divList_Product_InvCodeInActual_Cache.find('div.result[productcode="' + productCode + '"]').each(function () {
                                    debugger
                                    var $div = $(this);
                                    $div.find('input.Qty').val(fQty);
                                    //fQty = 0.0;
                                });
                            }
                        });
                    }
                }
            }

        }, 0);
    }
</script>
<script type="text/javascript">
    function inputUPIn(thiz) {
        setTimeout(function () {
            debugger;
            var $tr = $(thiz).parent().parent();
            var rd = $tr.attr('rd');

            var listError = [];

            var fUPInDesc = 0.0;
            var fUPIn = 0.0;
            var uPIn = commonUtils.returnValue($(thiz).val());
            var uPInInit = commonUtils.returnValue($(thiz).attr('initdata'));
            if (commonUtils.isNullOrEmpty(uPIn)) {
                var objToastr = {
                    ToastrType: 'error',
                    ToastrMessage: 'Vui lòng nhập giá nhập',
                };
                listError.push(objToastr);
            }
            else {
                fUPIn = commonUtils.parseFloat(uPIn);
                if (fUPIn < 0) {
                    var objToastr = {
                        ToastrType: 'error',
                        ToastrMessage: 'Giá nhập >= 0',
                    };
                    listError.push(objToastr);
                }
                else {
                    fUPInDesc = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.upindesc-' + rd).val()));
                    if (fUPIn < fUPInDesc) {
                        var objToastr = {
                            ToastrType: 'error',
                            ToastrMessage: 'Giá nhập >= giá giảm',
                        };
                        listError.push(objToastr);
                        //
                        //$(thiz).val(uPInInit);
                    }
                }
            }
            if (listError !== undefined && listError !== null && listError.length > 0) {
                commonUtils.showToastr(listError);
                return false;
            }
            else {
                var fQty = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.qty-' + rd).val()));
                var fValInAfterDesc = (fUPIn - fUPInDesc) * fQty;
                $tr.find('input.valinafterdesc-' + rd).val(fValInAfterDesc);

                tongTienHang();

                @* Update Giá nhập, Thành tiền vào cache danh sách hàng hóa(lưới hàng hóa chính) *@
                //var productCode = $tr.attr('productcode');
                //var $divProducts = $tr.find('div.products-list');
                //var $divProduct = $divProducts.find('div[productcode="' + productCode + '"]');
                //if ($divProduct !== undefined && $divProduct !== null && $divProduct.length > 0) {
                //    $divProduct.find('input.UPIn').val(fUPIn);
                //    $divProduct.find('input.ValInAfterDesc').val(fValInAfterDesc);
                //}

            }

        }, 0);
    }
</script>
<script type="text/javascript">
    function inputUPInDesc(thiz) {
        setTimeout(function () {
            debugger;
            var $tr = $(thiz).parent().parent();
            var rd = $tr.attr('rd');

            var listError = [];

            var fUPIn = 0.0;
            var fUPInDesc = 0.0;
            var uPInDesc = commonUtils.returnValue($(thiz).val());
            var uPInDescInit = commonUtils.returnValue($(thiz).attr('initdata'));
            if (commonUtils.isNullOrEmpty(uPInDesc)) {
                var objToastr = {
                    ToastrType: 'error',
                    ToastrMessage: 'Vui lòng nhập giá giảm',
                };
                listError.push(objToastr);
            }
            else {
                fUPInDesc = commonUtils.parseFloat(uPInDesc);
                if (fUPInDesc < 0) {
                    var objToastr = {
                        ToastrType: 'error',
                        ToastrMessage: 'Giá giảm >= 0',
                    };
                    listError.push(objToastr);
                }
                else {
                    fUPIn = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.upin-' + rd).val()));
                    if (fUPIn < fUPInDesc) {
                        var objToastr = {
                            ToastrType: 'error',
                            ToastrMessage: 'Giá giảm <= giá nhập',
                        };
                        listError.push(objToastr);
                        //
                        //$(thiz).val(uPInDescInit);
                    }
                }
            }

            if (listError !== undefined && listError !== null && listError.length > 0) {
                commonUtils.showToastr(listError);
                return false;
            }
            else {
                var fQty = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.qty-' + rd).val()));
                var fValInAfterDesc = (fUPIn - fUPInDesc) * fQty;
                $tr.find('input.valinafterdesc-' + rd).val(fValInAfterDesc);

                tongTienHang();

                @* Update Giá giảm, Thành tiền vào cache danh sách hàng hóa(lưới hàng hóa chính) *@
                //var productCode = $tr.attr('productcode');
                //var $divProducts = $tr.find('div.products-list');
                //var $divProduct = $divProducts.find('div[productcode="' + productCode + '"]');
                //if ($divProduct !== undefined && $divProduct !== null && $divProduct.length > 0) {
                //    $divProduct.find('input.UPInDesc').val(fUPInDesc);
                //    $divProduct.find('input.ValInAfterDesc').val(fValInAfterDesc);
                //}
            }
        }, 0);

    }
</script>
<script type="text/javascript">
    function changeProduct(thiz) {
        debugger;
        var message = '';
        var listToastr = [];

        var $select = $(thiz);
        if ($select !== undefined && $select !== null) {

            var ischange = $select.attr('ischange');
            if (ischange === '1') {
                $select.attr('ischange', '0');
                return false;
            }

            var $tr = $(thiz).parent().parent();
            var rd = $tr.attr('rd');

            var unitCode = $select.val();
            var productCodeInit = $select.attr('initdata');

            if (!commonUtils.isNullOrEmpty(unitCode)) {

                var $option = $select.find(":selected");
                var productCodeSelected = '';

                if ($option != undefined && $option !== null && $option.length > 0) {
                    productCodeSelected = commonUtils.returnValue($option.attr('productcode'));
                }

                var productCode = $tr.attr('productcode');
                var $divProducts = $tr.find('div.products-list');

                @* Danh sách hàng hóa(lưới hàng hóa chính) *@
                var Lst_InvF_InventoryInDtl = List_InvF_InventoryInDtl();
                @* Kiểm tra hàng hóa theo đơn vị vừa chọn đã tồn tại trên lưới hàng hóa chính chưa *@
                if (!commonUtils.isNullOrEmpty(productCodeSelected)) {
                    if (Lst_InvF_InventoryInDtl !== undefined && Lst_InvF_InventoryInDtl !== null && Lst_InvF_InventoryInDtl.length > 0) {
                        for (var i = 0; i < Lst_InvF_InventoryInDtl.length; i++) {
                            if (productCodeSelected === Lst_InvF_InventoryInDtl[i].ProductCode) {
                                var productCodeUserSelectedCur = '';
                                var productNameSelectedCur = '';
                                var unitCodeSelectedCur = '';
                                var upinSelectedCur = '';
                                var $divProductSelected = $divProducts.find('div[productcode="' + productCodeSelected + '"]');
                                if ($divProductSelected !== undefined && $divProductSelected !== null) {
                                    productCodeUserSelectedCur = $divProductSelected.find('input.ProductCodeUser').val();
                                    productNameSelectedCur = $divProductSelected.find('input.ProductName').val();
                                    unitCodeSelectedCur = $divProductSelected.find('input.UnitCode').val();
                                    upinSelectedCur = $divProductSelected.find('input.UPIn').val();
                                }
                                message = 'Hàng hóa "' + productNameSelectedCur + '" - "' + unitCodeSelectedCur + '" đã tồn tại trên lưới';
                                var objToastr = { ToastrType: 'error', ToastrMessage: message };
                                listToastr.push(objToastr);
                                break;
                            }
                        }
                    }
                }

                if (listToastr !== undefined && listToastr !== null && listToastr.length > 0) {
                    commonUtils.showToastr(listToastr);
                    var $divProductOld = $divProducts.find('div[productcode="' + productCode + '"]');
                    if ($divProductOld !== undefined && $divProductOld !== null) {
                        var unitCodeOld = $divProductOld.find('input.UnitCode').val();
                        if (!commonUtils.isNullOrEmpty(unitCodeOld)) {
                            $select.val(unitCodeOld);
                            $select.attr('ischange', '1');
                            $select.select2().trigger('change');
                        }
                    }

                    return false;
                }
                else {

                    var flagLOT = commonUtils.returnValue($tr.find('input.flaglot-' + rd).val());
                    var flagSerial = commonUtils.returnValue($tr.find('input.flagserial-' + rd).val());

                    if (flagLOT === '0' && flagSerial === '0') {
                        changeProduct_No_LOT_No_Serial(thiz);
                    }
                    else if (flagLOT === '1') {
                        changeProduct_LOT(thiz);
                    }
                    else if (flagSerial === '1') {
                        changeProduct_Serial(thiz);
                    }
                }

            }
        }
    }
</script>
<script type="text/javascript">
    function changeProduct_No_LOT_No_Serial(thiz) {
        debugger
        var $tr = $(thiz).parent().parent();
        var rd = $tr.attr('rd');
        var $select = $(thiz);
        if ($select !== undefined && $select !== null && $select.length > 0) {
            var $option = $select.find(":selected");
            var productCodeSelected = '';

            if ($option != undefined && $option !== null && $option.length > 0) {
                productCodeSelected = commonUtils.returnValue($option.attr('productcode'));
            }
            var productCodeOld = $tr.attr('productcode');
            var $divProducts = $tr.find('div.products-list');
            if ($divProducts !== undefined && $divProducts !== null) {
                @* Update thông tin của hàng hóa hiện tại vào list cache danh sách hàng hóa *@
                var $divProductOld = $divProducts.find('div[productcode="' + productCodeOld + '"]');
                if ($divProductOld !== undefined && $divProductOld !== null && $divProductOld.length > 0) {
                    var qtyOld = $tr.find('input.qty-' + rd).val();
                    var invCodeInActualOld = $tr.find('input.invcodeinactual-' + rd).val();
                    var uPInOld = $tr.find('input.upin-' + rd).val();
                    var uPInDescOld = $tr.find('input.upindesc-' + rd).val();
                    var valInAfterDescOld = $tr.find('input.valinafterdesc-' + rd).val();
                    var remarkOld = $tr.find('textarea.remark-' + rd).val();

                    $divProductOld.find('input.Qty').val(qtyOld);
                    $divProductOld.find('input.InvCodeInActual').val(invCodeInActualOld);
                    $divProductOld.find('input.UPIn').val(uPInOld);
                    $divProductOld.find('input.UPInDesc').val(uPInDescOld);
                    $divProductOld.find('input.ValInAfterDesc').val(valInAfterDescOld);
                    $divProductOld.find('input.Remark').val(remarkOld);
                }
                var $divProductSelected = $divProducts.find('div[productcode="' + productCodeSelected + '"]');
                if ($divProductSelected !== undefined && $divProductSelected !== null && $divProductSelected.length > 0) {

                    var productCodeRoot = $divProductSelected.find('input.ProductCodeRoot').val();
                    var productCodeBase = $divProductSelected.find('input.ProductCodeBase').val();
                    var productCode = $divProductSelected.find('input.ProductCode').val();
                    var productCodeUser = $divProductSelected.find('input.ProductCodeUser').val();
                    var productName = $divProductSelected.find('input.ProductName').val();
                    var flagLot = $divProductSelected.find('input.FlagLot').val();
                    var flagSerial = $divProductSelected.find('input.FlagSerial').val();

                    var invCodeInActual = $divProductSelected.find('input.InvCodeInActual').val();
                    var qty = $divProductSelected.find('input.Qty').val();
                    var uPIn = $divProductSelected.find('input.UPIn').val();
                    var uPInDesc = $divProductSelected.find('input.UPInDesc').val();
                    var valInAfterDesc = $divProductSelected.find('input.ValInAfterDesc').val();
                    var remark = $divProductSelected.find('input.Remark').val();

                    @* Gán giá trị *@
                    $tr.attr('productcode', productCode);

                    var $spanProductCodeUser = $tr.find('span.productcodeuser-' + rd);
                    if ($spanProductCodeUser !== undefined && $spanProductCodeUser !== null && $spanProductCodeUser.length > 0) {
                        $spanProductCodeUser.text(productCodeUser);
                    }

                    var $spanProductName = $tr.find('span.productname-' + rd);
                    if ($spanProductName !== undefined && $spanProductName !== null && $spanProductName.length > 0) {
                        $spanProductName.text(productName);
                    }
                    $tr.find('input.productcode-' + rd).val(productCode);
                    $tr.find('input.productcodeuser-' + rd).val(productCodeUser);
                    $tr.find('input.productcodebase-' + rd).val(productCodeBase);
                    $tr.find('input.productcoderoot-' + rd).val(productCodeRoot);
                    $tr.find('input.productname-' + rd).val(productName);
                    $tr.find('input.flaglot-' + rd).val(flagLot);
                    $tr.find('input.flagserial-' + rd).val(flagSerial);

                    $select.attr('ischange', '0');
                    $select.attr('initdata', productCode);

                    $tr.find('input.qty-' + rd).val(qty);

                    $tr.find('input.invcodeinactual-' + rd).val(invCodeInActual);
                    var $spanInvCodeInActualType = $tr.find('span.invcodeinactualtype-' + rd);
                    if ($spanInvCodeInActualType !== undefined && $spanInvCodeInActualType !== null && $spanInvCodeInActualType.length > 0) {
                        var objInvF_InventoryInDtl = {
                            ProductCode: productCode,
                            ProductCodeUser: productCodeUser,
                            ProductName: productName,
                            ProductCodeBase: productCodeBase,
                        };
                        var extData_InvCodeInActualType = {};
                        var $invCodeInActualType = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_InvCodeInActual'), objInvF_InventoryInDtl, extData_InvCodeInActualType));
                        $spanInvCodeInActualType.empty();
                        $invCodeInActualType.appendTo($spanInvCodeInActualType);
                    }
                    $tr.find('input.upin-' + rd).val(uPIn);
                    $tr.find('input.upindesc-' + rd).val(uPInDesc);
                    $tr.find('input.valinafterdesc-' + rd).val(valInAfterDesc);
                    $tr.find('textarea.remark-' + rd).val(remark);

                    tongTienHang();

                }
            }
        }

    }
</script>
<script type="text/javascript">
    function changeProduct_LOT(thiz) {
        var $tr = $(thiz).parent().parent();
        var rd = $tr.attr('rd');
        var $select = $(thiz);
        if ($select !== undefined && $select !== null && $select.length > 0) {
            var $option = $select.find(":selected");
            var productCodeSelected = '';

            if ($option != undefined && $option !== null && $option.length > 0) {
                productCodeSelected = commonUtils.returnValue($option.attr('productcode'));
            }
            var productCodeOld = $tr.attr('productcode');
            var $divProducts = $tr.find('div.products-list');
            if ($divProducts !== undefined && $divProducts !== null) {
                @* Update ghi chú của hàng hóa hiện tại vào list cache danh sách hàng hóa *@
                var $divProductOld = $divProducts.find('div[productcode="' + productCodeOld + '"]');
                if ($divProductOld !== undefined && $divProductOld !== null && $divProductOld.length > 0) {
                    var remarkOld = $tr.find('textarea.remark-' + rd).val();
                    $divProductOld.find('input.Remark').val(remarkOld);
                }
                var $divProductSelected = $divProducts.find('div[productcode="' + productCodeSelected + '"]');
                if ($divProductSelected !== undefined && $divProductSelected !== null && $divProductSelected.length > 0) {

                    var productCodeRoot = $divProductSelected.find('input.ProductCodeRoot').val();
                    var productCodeBase = $divProductSelected.find('input.ProductCodeBase').val();
                    var productCode = $divProductSelected.find('input.ProductCode').val();
                    var productCodeUser = $divProductSelected.find('input.ProductCodeUser').val();
                    var productName = $divProductSelected.find('input.ProductName').val();
                    var flagLot = $divProductSelected.find('input.FlagLot').val();
                    var flagSerial = $divProductSelected.find('input.FlagSerial').val();

                    var invCodeInActual = $divProductSelected.find('input.InvCodeInActual').val();
                    var qty = $divProductSelected.find('input.Qty').val();
                    var uPIn = $divProductSelected.find('input.UPIn').val();
                    var uPInDesc = $divProductSelected.find('input.UPInDesc').val();
                    var valInAfterDesc = $divProductSelected.find('input.ValInAfterDesc').val();
                    var remark = $divProductSelected.find('input.Remark').val();

                    @* Gán giá trị *@
                    $tr.attr('productcode', productCode);

                    var $spanProductCodeUser = $tr.find('span.productcodeuser-' + rd);
                    if ($spanProductCodeUser !== undefined && $spanProductCodeUser !== null && $spanProductCodeUser.length > 0) {
                        $spanProductCodeUser.text(productCodeUser);
                    }

                    var $spanProductType = $tr.find('span.producttype-' + rd);
                    if ($spanProductType !== undefined && $spanProductType !== null && $spanProductType.length > 0) {
                        var objInvF_InventoryInDtl = {
                            ProductCode: productCode,
                            ProductName: productName,
                            ProductCodeUser: productCodeUser,
                        };
                        var extData_ProductType = {};
                        var $productTypeLOT = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_FlagLot'), objInvF_InventoryInDtl, extData_ProductType));
                        $spanProductType.empty();
                        $productTypeLOT.appendTo($spanProductType);

                    }


                    var $spanProductName = $tr.find('span.productname-' + rd);
                    if ($spanProductName !== undefined && $spanProductName !== null && $spanProductName.length > 0) {
                        $spanProductName.text(productName);
                    }
                    $tr.find('input.productcode-' + rd).val(productCode);
                    $tr.find('input.productcodeuser-' + rd).val(productCodeUser);
                    $tr.find('input.productcodebase-' + rd).val(productCodeBase);
                    $tr.find('input.productcoderoot-' + rd).val(productCodeRoot);
                    $tr.find('input.productname-' + rd).val(productName);
                    $tr.find('input.flaglot-' + rd).val(flagLot);
                    $tr.find('input.flagserial-' + rd).val(flagSerial);

                    $select.attr('ischange', '0');
                    $select.attr('initdata', productCode);

                    $tr.find('input.qty-' + rd).val(qty);

                    $tr.find('input.invcodeinactual-' + rd).val(invCodeInActual);

                    $tr.find('input.upin-' + rd).val(uPIn);
                    $tr.find('input.upindesc-' + rd).val(uPInDesc);
                    $tr.find('input.valinafterdesc-' + rd).val(valInAfterDesc);
                    $tr.find('textarea.remark-' + rd).val(remark);

                    tongTienHang();

                }
            }
        }

    }
</script>
<script type="text/javascript">
    function changeProduct_Serial(thiz) {
        var $tr = $(thiz).parent().parent();
        var rd = $tr.attr('rd');
        var $select = $(thiz);
        if ($select !== undefined && $select !== null && $select.length > 0) {
            var $option = $select.find(":selected");
            var productCodeSelected = '';

            if ($option != undefined && $option !== null && $option.length > 0) {
                productCodeSelected = commonUtils.returnValue($option.attr('productcode'));
            }
            var productCodeOld = $tr.attr('productcode');
            var $divProducts = $tr.find('div.products-list');
            if ($divProducts !== undefined && $divProducts !== null) {
                @* Update ghi chú của hàng hóa hiện tại vào list cache danh sách hàng hóa *@
                var $divProductOld = $divProducts.find('div[productcode="' + productCodeOld + '"]');
                if ($divProductOld !== undefined && $divProductOld !== null && $divProductOld.length > 0) {
                    var remarkOld = $tr.find('textarea.remark-' + rd).val();
                    $divProductOld.find('input.Remark').val(remarkOld);
                }
                var $divProductSelected = $divProducts.find('div[productcode="' + productCodeSelected + '"]');
                if ($divProductSelected !== undefined && $divProductSelected !== null && $divProductSelected.length > 0) {

                    var productCodeRoot = $divProductSelected.find('input.ProductCodeRoot').val();
                    var productCodeBase = $divProductSelected.find('input.ProductCodeBase').val();
                    var productCode = $divProductSelected.find('input.ProductCode').val();
                    var productCodeUser = $divProductSelected.find('input.ProductCodeUser').val();
                    var productName = $divProductSelected.find('input.ProductName').val();
                    var flagLot = $divProductSelected.find('input.FlagLot').val();
                    var flagSerial = $divProductSelected.find('input.FlagSerial').val();

                    var invCodeInActual = $divProductSelected.find('input.InvCodeInActual').val();
                    var qty = $divProductSelected.find('input.Qty').val();
                    var uPIn = $divProductSelected.find('input.UPIn').val();
                    var uPInDesc = $divProductSelected.find('input.UPInDesc').val();
                    var valInAfterDesc = $divProductSelected.find('input.ValInAfterDesc').val();
                    var remark = $divProductSelected.find('input.Remark').val();

                    @* Gán giá trị *@
                    $tr.attr('productcode', productCode);

                    var $spanProductCodeUser = $tr.find('span.productcodeuser-' + rd);
                    if ($spanProductCodeUser !== undefined && $spanProductCodeUser !== null && $spanProductCodeUser.length > 0) {
                        $spanProductCodeUser.text(productCodeUser);
                    }

                    var $spanProductType = $tr.find('span.producttype-' + rd);
                    if ($spanProductType !== undefined && $spanProductType !== null && $spanProductType.length > 0) {
                        var objInvF_InventoryInDtl = {
                            ProductCode: productCode,
                            ProductCodeUser: productCodeUser,
                            ProductName: productName,
                        };
                        var extData_ProductType = {};
                        var $productTypeSerial = $(commonUtils.getHtmlFromTemplate($('#tmpl_ShowPopup_Product_FlagSerial'), objInvF_InventoryInDtl, extData_ProductType));
                        $spanProductType.empty();
                        $productTypeSerial.appendTo($spanProductType);

                    }


                    var $spanProductName = $tr.find('span.productname-' + rd);
                    if ($spanProductName !== undefined && $spanProductName !== null && $spanProductName.length > 0) {
                        $spanProductName.text(productName);
                    }
                    $tr.find('input.productcode-' + rd).val(productCode);
                    $tr.find('input.productcodeuser-' + rd).val(productCodeUser);
                    $tr.find('input.productcodebase-' + rd).val(productCodeBase);
                    $tr.find('input.productcoderoot-' + rd).val(productCodeRoot);
                    $tr.find('input.productname-' + rd).val(productName);
                    $tr.find('input.flaglot-' + rd).val(flagLot);
                    $tr.find('input.flagserial-' + rd).val(flagSerial);

                    $select.attr('ischange', '0');
                    $select.attr('initdata', productCode);

                    $tr.find('input.qty-' + rd).val(qty);

                    $tr.find('input.invcodeinactual-' + rd).val(invCodeInActual);

                    $tr.find('input.upin-' + rd).val(uPIn);
                    $tr.find('input.upindesc-' + rd).val(uPInDesc);
                    $tr.find('input.valinafterdesc-' + rd).val(valInAfterDesc);
                    $tr.find('textarea.remark-' + rd).val(remark);

                    tongTienHang();

                }
            }
        }

    }
</script>
@*End Xử lý tính toán trên lưới hàng hóa*@

@*Popup thêm vị trí kho*@
<script type="text/javascript">
    function showPopupInvCodeInActual(productCode, productCodeUser, productName, productCodeBase) {
        debugger;
        if (!commonUtils.isNullOrEmpty(productCode)) {
            var invBUPattern = '';
            var iF_InvInStatus = commonUtils.returnValueText('#IF_InvInStatus');
            var viewType = commonUtils.returnValueText('#manageForm .ViewType');
            var $option = $('#InvCodeIn').find(":selected");
            if ($option !== undefined && $option !== null && $option.length > 0) {
                invBUPattern = $option.attr('InvBUPattern');
            }
            var listInvF_InventoryInDtl = []; @*Hàng hóa theo vị trí*@
            var rows = $('tbody#table-detailInvCodeInActual tr[productcode="' + productCode + '"]').length;
            if (rows > 0) {
                $('tbody#table-detailInvCodeInActual tr[productcode="' + productCode +'"]').each(function () {
                    debugger;
                    var $tr = $(this);
                    var $divList_Product_InvCodeInActual_Cache = $tr.find('div.products-list-cache');
                    $divList_Product_InvCodeInActual_Cache.find('div.result[productcode="' + productCode + '"]').each(function () {
                        var $div = $(this);

                        var objInvF_InventoryInDtlCur = {};
                        objInvF_InventoryInDtlCur.ProductCode = productCode;
                        objInvF_InventoryInDtlCur.Qty = commonUtils.returnValue($div.find('input.Qty').val());
                        objInvF_InventoryInDtlCur.InvCodeInActual = commonUtils.returnValue($div.find('input.InvCodeInActual').val());

                        listInvF_InventoryInDtl.push(objInvF_InventoryInDtlCur);

                    });
                });
            }

            var objListDtl = commonUtils.returnJSONValue(listInvF_InventoryInDtl);
            var url = '@Url.Action("ShowInvCodeInActual", "InvF_InventoryIn")';
            var token = $('#manageForm input[name=__RequestVerificationToken]').val();
            $.ajax({
                type: 'post',
                data: {
                    productcode: productCode,
                    productcodeuser: productCodeUser,
                    productcodebase: productCodeBase,
                    productname: productName,
                    invbupattern: invBUPattern,
                    listdetail: objListDtl,
                    ifinvinstatus: iF_InvInStatus, @* Trạng thái phiếu nhập để hiển thị button trên popup *@
                    viewtype: viewType,
                    __RequestVerificationToken: token,
                },
                url: url,
                dataType: 'json',
                beforeSend: function () {
                }
            }).done(function (objResult) {
                if (objResult.Success) {
                    $("#ShowPopupInvCodeInActual").html('');
                    $("#ShowPopupInvCodeInActual").html(objResult.Html); // truyen html vao #form
                    $('#ShowPopupInvCodeInActual').modal({
                        backdrop: false,
                        keyboard: true,
                    });
                    $('#ShowPopupInvCodeInActual').modal('show');
                } else {
                    _showErrorMsg123('Lỗi!', objResult.Detail);
                }
            }).fail(function (jqXHR, textStatus, errorThrown) {

            }).always(function () {

            });

        }
    }

    function closePopupInvCodeInActual() {
        $('#ShowPopupInvCodeInActual').modal('hide');
        $('#ShowPopupInvCodeInActual').on('hidden.bs.modal', function () {
            $('#ShowPopupInvCodeInActual form')[0].reset();
        });
    }
</script>

<script type="text/javascript">
    function renderProductInvCodeInActual(data) {
        debugger;
        var date = new Date();
        var randomCur = date.getTime();
        var randHex = commonUtils.randHex(12);
        randomCur = randomCur + randHex;

        var objProduct_InvCodeInActual = data.Product_InvCodeInActual;
        var listMst_Inventory = data.Lst_Mst_Inventory;

        if (objProduct_InvCodeInActual !== undefined && objProduct_InvCodeInActual !== null) {
            var invCodeInActual = commonUtils.returnValue(objProduct_InvCodeInActual.InvCodeInActual);
            var productCode = commonUtils.returnValue(objProduct_InvCodeInActual.ProductCode);
            //if (!commonUtils.isNullOrEmpty(invCodeInActual))
            if (true) {
                var select2Css = 'select2-' + randomCur;
                var qtyCss = 'qty-' + randomCur;

                var extData = {
                    select2Css: select2Css,
                    qtyCss: qtyCss,
                    rd: randomCur,
                    idx: 9999,
                };

                var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_InvCodeInActual_Add'), objProduct_InvCodeInActual, extData));

                if (listMst_Inventory !== undefined && listMst_Inventory !== null && listMst_Inventory.length > 0) {
                    for (var i = 0; i < listMst_Inventory.length; i++) {
                        var invCodeCur = commonUtils.returnValue(listMst_Inventory[i].InvCode);
                        @* Add vị trí kho *@
                        var $select = $item.find('select.select2');
                        if ($select !== undefined && $select !== null) {
                            var $optgroup = $select.find('optgroup');
                            if ($optgroup !== undefined && $optgroup !== null) {
                                var selected = '';
                                if (invCodeInActual === invCodeCur) {
                                    selected = 'selected="selected"';
                                }

                                var extData_Options = {
                                    selected: selected,
                                };
                                var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_options_InvCodeInActual'), listMst_Inventory[i], extData_Options));
                                $option.appendTo($optgroup);
                            }
                        }
                    }
                }

                $item.appendTo($('#table-tbodyIDInvCodeInActual'));
                @* format number *@
                var tableName = 'InvF_InventoryIn';
                var qtyformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'Qty');

                $('.' + qtyCss).number(true, qtyformat);

                $('.' + select2Css).select2({
                    minimumResultsForSearch: -1
                });
                commonUtils.updateTableTrNotShowIdx($('#table-tbodyIDInvCodeInActual tr.trdata'), true);

            }
        }

    }
</script>

<script type="text/javascript">

    function ListInvCodeInActual() {
        var Lst_InvCodeInActual = [];
        var rows = $('tbody#table-tbodyIDInvCodeInActual tr.trdata').length;
        if (rows > 0) {
            $('tbody#table-tbodyIDInvCodeInActual tr.trdata').each(function () {
                var $tr = $(this);
                var rd = $tr.attr('rd');
                var $select = $tr.find('select.select2-' + rd);
                if ($select !== undefined && $select !== null && $select.length > 0) {
                    //var invCode = commonUtils.returnValue($select.val());
                    var invCode = commonUtils.returnValue($select.attr('initdata'));
                    if (!commonUtils.isNullOrEmpty(invCode)) {
                        Lst_InvCodeInActual.push(invCode);
                    }
                }
            });
        }
        return Lst_InvCodeInActual;
    }

    function changeInvCodeInActual(thiz) {
        var message = '';
        var listToastr = [];
        debugger;
        var $select = $(thiz);
        if ($select !== undefined && $select !== null && $select.length > 0) {

            var ischange = $select.attr('ischange');
            if (ischange === '1') {
                $select.attr('ischange', '0');
                return false;
            }

            var invCode = commonUtils.returnValue($select.val());
            var invCodeInit = commonUtils.returnValue($select.attr('initdata'));
            var invName = '';
            var $option = $select.find(":selected");
            if ($option !== undefined && $option !== null && $option.length > 0) {
                invName = commonUtils.returnValue($option.attr('invname'));
            }
            if (!commonUtils.isNullOrEmpty(invCode)) {
                @* Danh sách kho trên lưới đã chọn *@
                listInvCodeInActual = ListInvCodeInActual();
                if (listInvCodeInActual !== undefined && listInvCodeInActual !== null && listInvCodeInActual.length > 0) {
                    for (var i = 0; i < listInvCodeInActual.length; i++) {
                        var invCodeCur = commonUtils.returnValue(listInvCodeInActual[i]);
                        if (invCode === invCodeCur) {
                            message = 'Vị trí "' + invName + '" đã tồn tại trên lưới';
                            var objToastr = { ToastrType: 'error', ToastrMessage: message };
                            listToastr.push(objToastr);
                            break;
                        }
                    }
                }

                if (listToastr !== undefined && listToastr !== null && listToastr.length > 0) {
                    commonUtils.showToastr(listToastr);
                    $select.val(invCodeInit);
                    $select.attr('ischange', '1');
                    $select.select2().trigger('change');

                    return false;
                }
                else {
                    $select.attr('ischange', '0');
                    $select.attr('initdata', invCode);
                }
            }
        }
    }

    function product_InvCodeInActual_AddNewRow() {
        debugger;
        var objProduct_InvCodeInActual = {
            InvCodeInActual: '',
            Qty: 0.0,
        }
        var objProduct_InvCodeInActual_AddRow = {
            Product_InvCodeInActual: objProduct_InvCodeInActual,
            Lst_Mst_Inventory: Lst_Mst_Inventory,
        };

        renderProductInvCodeInActual(objProduct_InvCodeInActual_AddRow);
    }

    function product_InvCodeInActual_DeleteRow(thiz) {
        var rows = $('tbody#table-tbodyIDInvCodeInActual tr.trdata').length;
        if (rows > 0) {
            var $tr = $(thiz).parent().parent();
            if ($tr !== undefined && $tr !== null && $tr.length > 0) {
                $tr.remove();
            }
            if (rows > 1) {
                commonUtils.updateTableTrNotShowIdx($('tbody#table-tbodyIDInvCodeInActual tr.trdata'), true);
            } else {
                // Css lại table head
            }
        }
    }

    function checkForm_PopupInvCodeInActual() {
        var listError = [];
        var message = '';
        var rows = $('tbody#table-tbodyIDInvCodeInActual tr.trdata').length;
        if (rows > 0) {
            var arrInvCodeInActual = [];
            $('tbody#table-tbodyIDInvCodeInActual tr.trdata').each(function () {
                debugger;
                var $tr = $(this);
                var rd = $tr.attr('rd');
                var $select = $tr.find('select.select2-' + rd);
                if ($select !== undefined && $select !== null && $select.length > 0) {
                    var invCode = commonUtils.returnValue($select.val());
                    if (commonUtils.isNullOrEmpty(invCode)) {
                        message = '';
                        message = 'Chưa chọn vị trí';
                        var objToastr = { ToastrType: 'error', ToastrMessage: message };
                        listError.push(objToastr);
                    }
                    else {
                        if (!arrInvCodeInActual.includes(invCode)) {
                            arrInvCodeInActual.push(invCode);

                            @*Chọn vị trí họp lệ => check số lượng*@
                            var qty = commonUtils.returnValue($tr.find('input.qty-' + rd).val());
                            if (commonUtils.isNullOrEmpty(qty)) {
                                message = '';
                                message = 'Chưa nhập số lượng';
                                var objToastr = { ToastrType: 'error', ToastrMessage: message };
                                listError.push(objToastr);
                            }
                            else {
                                var fQty = commonUtils.parseFloat(qty);
                                @*Tạm thời bắt < 0; check lại nghiệp vụ chỗ sửa số lượng trên lưới hàng hóa khi set các vị trí khác = 0*@
                                if (fQty < 0) {
                                    message = '';
                                    message = 'Vị trí "' + invCode +'"' + 'số lượng phải >= 0';
                                    var objToastr = { ToastrType: 'error', ToastrMessage: message };
                                    listError.push(objToastr);
                                }
                            }
                        }
                        else {
                            message = '';
                            message = 'Không thể chọn trùng vị trí';
                            var objToastr = { ToastrType: 'error', ToastrMessage: message };
                            listError.push(objToastr);
                        }
                    }
                }
            });
        }

        if (listError !== undefined && listError !== null && listError.length > 0) {
            commonUtils.showToastr(listError);
            return false;
        }
        return true;
    }


    function checkPlanQty(thiz) {
        debugger
        var fQty = 0.0;
        var qty = commonUtils.returnValue($(thiz).val());
        fQty = commonUtils.parseFloat(qty);
        var checked = $('#FlagNhapTuDH').prop('checked');
        var productCode = commonUtils.returnValue($(thiz).attr('productcode'));
        var $trInvF_InventoryInDtl = $('#table-tbodyID').find('tr[productcode="' + productCode + '"]');
        if ($trInvF_InventoryInDtl !== undefined && $trInvF_InventoryInDtl !== null && $trInvF_InventoryInDtl.length > 0) {
            var rdInvF_InventoryInDtl = $trInvF_InventoryInDtl.attr('rd');
            var planQty = commonUtils.parseFloat(commonUtils.returnValue($trInvF_InventoryInDtl.find('td.Qty input.planqty-' + rdInvF_InventoryInDtl).val()));

            if (planQty < fQty && checked === true) {
                bootbox.confirm({
                    title: 'THÔNG BÁO',
                    message: 'Số lượng nhập kho vượt quá số lượng đặt hàng sản xuất. Bạn có chắc muốn nhập?',
                    buttons: {
                        'cancel': {
                            label: 'Cancel',
                            className: 'btn mybtn-Button btnButton'
                        },
                        'confirm': {
                            label: 'Yes',
                            className: 'btn mybtn-Button btnButton'
                        }
                    },
                    callback: function (result) {
                        if (result) {
                            

                        }
                        else {
                            $(thiz).val('');
                        }
                    }
                });
            }

        }



    }



    function checkPlanQtyLot(thiz) {
        debugger
        var fQty = 0.0;
        //var qty = commonUtils.returnValue($('#PlanQty').val());
        var productCode = commonUtils.returnValue($(thiz).attr('productcode'));
        var $trInvF_InventoryInDtl = $('#table-tbodyID').find('tr[productcode="' + productCode + '"]');
        if ($trInvF_InventoryInDtl !== undefined && $trInvF_InventoryInDtl !== null && $trInvF_InventoryInDtl.length > 0) {
            var rdInvF_InventoryInDtl = $trInvF_InventoryInDtl.attr('rd');

            var qty = commonUtils.returnValue($trInvF_InventoryInDtl.find('td.Qty input.planqty-' + rdInvF_InventoryInDtl).val());
            fQty = commonUtils.parseFloat(qty);
            var checked = $('#FlagNhapTuDH').prop('checked');
            var fQty1 = 0.0;
            var qty1 = commonUtils.returnValue($(thiz).val());
            fQty1 = commonUtils.parseFloat(qty1);
            fQty1 = commonUtils.parseFloat(qty1);


            if (fQty1 > fQty && checked === true) {
                bootbox.confirm({
                    title: 'THÔNG BÁO',
                    message: 'Số lượng nhập kho vượt quá số lượng đặt hàng sản xuất. Bạn có chắc muốn nhập?',
                    buttons: {
                        'cancel': {
                            label: 'Cancel',
                            className: 'btn mybtn-Button btnButton'
                        },
                        'confirm': {
                            label: 'Yes',
                            className: 'btn mybtn-Button btnButton'
                        }
                    },
                    callback: function (result) {
                        if (result) {


                        }
                        else {
                            $(thiz).val('');
                        }
                    }
                });
            }

        }
        
    }

    function product_InvCodeInActual_Save() {
        debugger;
        var rows = $('tbody#table-tbodyIDInvCodeInActual tr.trdata').length;
        if (rows > 0) {
            var productCode = commonUtils.returnValueText('#manageFormShowPopupInvCodeInActual input.ProductCode_Popup_InvCodeInActual');
            if (!commonUtils.isNullOrEmpty(productCode)) {
                var checkForm = checkForm_PopupInvCodeInActual();
                if (checkForm) {
                    @*Xóa hàng hóa - vị trí đã lưu cache*@
                    var $tableProduct_InvCodeInActual_Cache = $('#table-detailInvCodeInActual'); @* Cache hàng hóa - vị trí *@
                    var rowOlds = $tableProduct_InvCodeInActual_Cache.find('tr[productcode="' + productCode + '"]').length;
                    if (rowOlds > 0) {
                        $tableProduct_InvCodeInActual_Cache.find('tr[productcode="' + productCode + '"]').each(function () {
                            debugger;
                            var $tr = $(this);
                            var $divList_Product_InvCodeInActual = $tr.find('div.products-list-cache');
                            if ($divList_Product_InvCodeInActual !== undefined && $divList_Product_InvCodeInActual !== null) {

                                $divList_Product_InvCodeInActual.find('div.result[productcode="' + productCode + '"]').each(function () {
                                    var $div = $(this);
                                    $div.remove();

                                });
                            }

                        });
                    }

                    @*Thêm hàng hóa - vị trí vào cache*@

                    debugger;
                    var $trInvCodeInActual = $tableProduct_InvCodeInActual_Cache.find('tr[productcode="' + productCode + '"]');
                    @*if ($trInvCodeInActual == undefined || $trInvCodeInActual == null) {

                        var extData_Product_InvCodeInActual_Cache = {};
                        var $trInvCodeInActual = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_InvCodeInActual'), objInvF_InventoryInDtl, extData_Product_InvCodeInActual_Cache));
                        $trInvCodeInActual.appendTo($tableProduct_InvCodeInActual_Cache);
                    }*@

                    var $divList_Product_InvCodeInActual_Cache = $trInvCodeInActual.find('div.products-list-cache');

                    var strInvCodeInActual = '';
                    var totalQty = 0.0;
                    $("#table-tbodyIDInvCodeInActual tr.trdata").each(function () {
                        debugger;
                        var $tr = $(this);
                        var rd = $tr.attr('rd');

                        var invCode = commonUtils.returnValue($tr.find('select.select2-' + rd).val());
                        if (!commonUtils.isNullOrEmpty(strInvCodeInActual)) {
                            strInvCodeInActual += ', ';
                        }
                        strInvCodeInActual += invCode;

                        var qty = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.qty-' + rd).val()));
                        totalQty += qty;
                        if ($divList_Product_InvCodeInActual_Cache !== undefined && $divList_Product_InvCodeInActual_Cache !== null && $divList_Product_InvCodeInActual_Cache.length > 0) {
                            var objProduct = {
                                ProductCode: productCode,
                                InvCodeInActual: invCode,
                                Qty: qty,
                            };

                            var extData = {
                                idx: 9999,
                            };

                            var $divProduct_InvCodeInActual = $(commonUtils.getHtmlFromTemplate($('#tmpl_product_invcodeinactual_list_cache'), objProduct, extData));
                            $divProduct_InvCodeInActual.appendTo($divList_Product_InvCodeInActual_Cache);

                        }

                    });

                    commonUtils.updateTableTrNotShowIdx($('#table-detailInvCodeInActual tr.trdata'), true);

                    @*Update lại vị trí, số lượng*@
                    var $trInvF_InventoryInDtl = $('#table-tbodyID').find('tr[productcode="' + productCode + '"]');
                    if ($trInvF_InventoryInDtl !== undefined && $trInvF_InventoryInDtl !== null && $trInvF_InventoryInDtl.length > 0) {
                        var rdInvF_InventoryInDtl = $trInvF_InventoryInDtl.attr('rd');
                        var $inputQty = $trInvF_InventoryInDtl.find('input.qty-' + rdInvF_InventoryInDtl);
                        if ($inputQty !== undefined && $inputQty !== null && $inputQty.length > 0) {
                            $inputQty.val(totalQty);
                        }

                        var $inputInvCodeInActual = $trInvF_InventoryInDtl.find('input.invcodeinactual-' + rdInvF_InventoryInDtl);
                        if ($inputInvCodeInActual !== undefined && $inputInvCodeInActual !== null && $inputInvCodeInActual.length > 0) {
                            $inputInvCodeInActual.val(strInvCodeInActual);
                        }

                        tongTienHang();
                    }

                    closePopupInvCodeInActual();
                }
            }
        }
    }
</script>
@*End Popup thêm vị trí kho*@

@*Popup Serial*@
<script type="text/javascript">
    function showPopupSerial(productCode, productCodeUser, productName) {
        if (!commonUtils.isNullOrEmpty(productCode)) {
            var invBUPattern = '';
            var iF_InvInStatus = commonUtils.returnValueText('#IF_InvInStatus');
            var viewType = commonUtils.returnValueText('#manageForm .ViewType');
            var $option = $('#InvCodeIn').find(":selected");
            if ($option !== undefined && $option !== null && $option.length > 0) {
                invBUPattern = $option.attr('InvBUPattern');
            }

            var listInvF_InventoryInInstSerial = []; @* Danh sách Serial của hàng hóa - table-detailSerial *@
            var rows = $('tbody#table-detailSerial tr[productcode="' + productCode + '"]').length;
            if (rows > 0) {
                $('tbody#table-detailSerial tr[productcode="' + productCode + '"]').each(function () {
                    debugger;
                    var $tr = $(this);
                    var objInvF_InventoryInInstSerialCur = {};
                    objInvF_InventoryInInstSerialCur.ProductCode = productCode;
                    objInvF_InventoryInInstSerialCur.SerialNo = commonUtils.returnValue($tr.find('input.SerialNo').val());
                    objInvF_InventoryInInstSerialCur.InvCodeInActual = commonUtils.returnValue($tr.find('input.InvCodeInActual').val());

                    listInvF_InventoryInInstSerial.push(objInvF_InventoryInInstSerialCur);
                });
            }

            var objListSerial = commonUtils.returnJSONValue(listInvF_InventoryInInstSerial);
            var url = '@Url.Action("ShowSerial", "InvF_InventoryIn")';
            var token = $('#manageForm input[name=__RequestVerificationToken]').val();

            $.ajax({
                type: 'post',
                data: {
                    productcode: productCode,
                    productcodeuser: productCodeUser,
                    productname: productName,
                    invbupattern: invBUPattern,
                    listserial: objListSerial,
                    ifinvinstatus: iF_InvInStatus, @* Trạng thái phiếu nhập để hiển thị button trên popup *@
                    viewtype: viewType,
                    __RequestVerificationToken: token,
                },
                url: url,
                dataType: 'json',
                beforeSend: function () {
                }
            }).done(function (objResult) {
                if (objResult.Success) {
                    $("#ShowPopupSerial").html('');
                    $("#ShowPopupSerial").html(objResult.Html); // truyen html vao #form
                    $('#ShowPopupSerial').modal({
                        backdrop: false,
                        keyboard: true,
                    });
                    $('#ShowPopupSerial').modal('show');
                } else {
                    _showErrorMsg123('Lỗi!', objResult.Detail);
                }
            }).fail(function (jqXHR, textStatus, errorThrown) {

            }).always(function () {

            });

        }
    }

    function closePopupSerial() {
        $('#ShowPopupSerial').modal('hide');
        $('#ShowPopupSerial').on('hidden.bs.modal', function () {
            $('#ShowPopupSerial form')[0].reset();
        });
    }
</script>

<script type="text/javascript">
    function renderProductInvFInventoryInInstSerial(data) {
        debugger;
        var date = new Date();
        var randomCur = date.getTime();
        var randHex = commonUtils.randHex(12);
        randomCur = randomCur + randHex;

        var objProduct_InvF_InventoryInInstSerial = data.Product_InvF_InventoryInInstSerial;
        var listMst_Inventory = data.Lst_Mst_Inventory;

        if (objProduct_InvF_InventoryInInstSerial !== undefined && objProduct_InvF_InventoryInInstSerial !== null) {
            var serialNo = commonUtils.returnValue(objProduct_InvF_InventoryInInstSerial.SerialNo);
            var invCodeInActual = commonUtils.returnValue(objProduct_InvF_InventoryInInstSerial.InvCodeInActual);
            //if (!commonUtils.isNullOrEmpty(invCodeInActual))
            if (true) {
                var select2Css = 'select2-' + randomCur;
                var serialnoCss = 'serialno-' + randomCur;

                var extData = {
                    select2Css: select2Css,
                    serialnoCss: serialnoCss,
                    rd: randomCur,
                    idx: 9999,
                };

                var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_Serial_Add'), objProduct_InvF_InventoryInInstSerial, extData));

                if (listMst_Inventory !== undefined && listMst_Inventory !== null && listMst_Inventory.length > 0) {
                    for (var i = 0; i < listMst_Inventory.length; i++) {
                        var invCodeCur = commonUtils.returnValue(listMst_Inventory[i].InvCode);
                        @* Add vị trí kho *@
                        var $select = $item.find('select.select2');
                        if ($select !== undefined && $select !== null) {
                            var $optgroup = $select.find('optgroup');
                            if ($optgroup !== undefined && $optgroup !== null) {
                                var selected = '';
                                if (invCodeInActual === invCodeCur) {
                                    selected = 'selected="selected"';
                                }

                                var extData_Options = {
                                    selected: selected,
                                };
                                var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_options_InvCodeInActual'), listMst_Inventory[i], extData_Options));
                                $option.appendTo($optgroup);
                            }
                        }
                    }
                }

                $item.appendTo($('#table-tbodyIDSerial'));

                $('.' + select2Css).select2({
                    minimumResultsForSearch: -1
                });
                commonUtils.updateTableTrNotShowIdx($('#table-tbodyIDSerial tr.trdata'), true);

            }
        }

    }
</script>

<script type="text/javascript">

    function product_InvF_InventoryInInstSerial_AddNewRow() {
        var objProduct_InvF_InventoryInInstSerial = {
            InvCodeInActual: '',
            SerialNo: '',
        }
        var objProduct_InvF_InventoryInInstSerial_AddRow = {
            Product_InvF_InventoryInInstSerial: objProduct_InvF_InventoryInInstSerial,
            Lst_Mst_Inventory: Lst_Mst_Inventory_Serial,
        };

        renderProductInvFInventoryInInstSerial(objProduct_InvF_InventoryInInstSerial_AddRow);
    }

    function product_Serial_DeleteRow(thiz) {
        var rows = $('tbody#table-tbodyIDSerial tr.trdata').length;
        if (rows > 0) {
            var $tr = $(thiz).parent().parent();
            if ($tr !== undefined && $tr !== null && $tr.length > 0) {
                $tr.remove();
            }
            if (rows > 1) {
                commonUtils.updateTableTrNotShowIdx($('tbody#table-tbodyIDSerial tr.trdata'), true);
            } else {
                // Css lại table head
            }
        }
    }

    function checkForm_PopupSerial() {
        var listError = [];
        var message = '';
        var rows = $('tbody#table-tbodyIDSerial tr.trdata').length;
        if (rows > 0) {
            var arrSerialNo = [];
            $('tbody#table-tbodyIDSerial tr.trdata').each(function () {
                debugger;
                var $tr = $(this);
                var rd = $tr.attr('rd');

                var serialNo = commonUtils.returnValue($tr.find('input.serialno-' + rd).val());

                if (commonUtils.isNullOrEmpty(serialNo)) {
                    message = '';
                    message = 'Chưa nhập số serial';
                    var objToastr = { ToastrType: 'error', ToastrMessage: message };
                    listError.push(objToastr);
                }
                else {
                    if (!arrSerialNo.includes(serialNo)) {
                        arrSerialNo.push(serialNo);
                    }
                    else {
                        message = '';
                        message = 'Số serial "' + serialNo + '" bị trùng';
                        var objToastr = { ToastrType: 'error', ToastrMessage: message };
                        listError.push(objToastr);
                    }
                }
                var $select = $tr.find('select.select2-' + rd);
                if ($select !== undefined && $select !== null && $select.length > 0) {
                    var invCode = commonUtils.returnValue($select.val());
                    if (commonUtils.isNullOrEmpty(invCode)) {
                        message = '';
                        message = 'Chưa chọn vị trí';
                        var objToastr = { ToastrType: 'error', ToastrMessage: message };
                        listError.push(objToastr);
                    }

                }
            });
        }

        if (listError !== undefined && listError !== null && listError.length > 0) {
            commonUtils.showToastr(listError);
            return false;
        }
        return true;
    }

    function product_InvF_InventoryInInstSerial_Save() {
        var rows = $('tbody#table-tbodyIDSerial tr.trdata').length;
        var checked = $('#FlagNhapTuDH').prop('checked');
        if (rows > 0) {
            var productCode = commonUtils.returnValueText('#manageFormShowPopupSerial input.ProductCode_Popup_InvCodeInActual_Serial');
            if (!commonUtils.isNullOrEmpty(productCode)) {

                var checkForm = checkForm_PopupSerial();
                if (checkForm) {
                    @* Xóa serial - hàng hóa đã lưu cache *@
                    var rowOlds = $('#table-detailSerial').find('tr[productcode="' + productCode + '"]').length;
                    if (rowOlds > 0) {
                        $('#table-detailSerial').find('tr[productcode="' + productCode + '"]').each(function () {
                            $(this).remove();
                        });
                    }

                    @* Thêm serial - hàng hóa vào cache *@
                    var lstVitri = "";
                    var arrayInvCode = [];
                    $("#table-tbodyIDSerial tr.trdata").each(function () {
                        var $tr = $(this);
                        var rd = $tr.attr('rd');

                        var invCode = commonUtils.returnValue($tr.find('select.select2-' + rd).val());
                        if (invCode != null) {
                            if (arrayInvCode.includes(invCode) == false ) {
                                arrayInvCode.push(invCode);
                                if (lstVitri == "") {
                                    lstVitri += invCode;
                                }
                                else {
                                    lstVitri += ", " + invCode;
                                }
                            }

                        }

                        var serialNo = commonUtils.returnValue($tr.find('input.serialno-' + rd).val());

                        var objProduct = {
                            ProductCode: productCode,
                            InvCodeInActual: invCode,
                            SerialNo: serialNo,
                        };

                        var extData = {
                            idx: 9999,
                        };

                        var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_Serial'), objProduct, extData));
                        $item.appendTo($('#table-detailSerial'));

                    });

                    commonUtils.updateTableTrNotShowIdx($('#table-detailSerial tr.trdata'), true);

                    @* Update lại vị trí, số lượng *@
                    var $trInvF_InventoryInDtl = $('#table-tbodyID').find('tr[productcode="' + productCode + '"]');
                    if ($trInvF_InventoryInDtl !== undefined && $trInvF_InventoryInDtl !== null && $trInvF_InventoryInDtl.length > 0) {
                        var rdInvF_InventoryInDtl = $trInvF_InventoryInDtl.attr('rd');


                        var planQty = commonUtils.parseFloat(commonUtils.returnValue($trInvF_InventoryInDtl.find('td.Qty input.planqty-' + rdInvF_InventoryInDtl).val()));

                        if (rows > planQty && checked === true) {
                            bootbox.confirm({
                                title: 'THÔNG BÁO',
                                message: 'Số lượng nhập kho vượt quá số lượng đặt hàng sản xuất. Bạn có chắc muốn nhập?',
                                buttons: {
                                    'cancel': {
                                        label: 'Cancel',
                                        className: 'btn mybtn-Button btnButton'
                                    },
                                    'confirm': {
                                        label: 'Yes',
                                        className: 'btn mybtn-Button btnButton'
                                    }
                                },
                                callback: function (result) {
                                    if (result) {
                                        var $inputQty = $trInvF_InventoryInDtl.find('input.qty-' + rdInvF_InventoryInDtl);
                                        if ($inputQty !== undefined && $inputQty !== null && $inputQty.length > 0) {
                                            $inputQty.val(rows);
                                        }

                                        var $inputInvCodeInActual = $trInvF_InventoryInDtl.find('input.invcodeinactual-' + rdInvF_InventoryInDtl);
                                        if ($inputInvCodeInActual !== undefined && $inputInvCodeInActual !== null && $inputInvCodeInActual.length > 0) {
                                            $inputInvCodeInActual.val(lstVitri);
                                        }

                                        tongTienHang();

                                    }
                                    else {
                                        closePopupLo();
                                    }
                                }
                            });
                        }
                        else {

                            var $inputQty = $trInvF_InventoryInDtl.find('input.qty-' + rdInvF_InventoryInDtl);
                            if ($inputQty !== undefined && $inputQty !== null && $inputQty.length > 0) {
                                $inputQty.val(rows);
                            }

                            var $inputInvCodeInActual = $trInvF_InventoryInDtl.find('input.invcodeinactual-' + rdInvF_InventoryInDtl);
                            if ($inputInvCodeInActual !== undefined && $inputInvCodeInActual !== null && $inputInvCodeInActual.length > 0) {
                                $inputInvCodeInActual.val(lstVitri);
                            }

                            tongTienHang();
                        }
                    }

                    closePopupSerial();
                }
            }
        }
    }
</script>

@*End Popup Serial*@

@*Popup LOT*@
<script type="text/javascript">
    debugger
    function showPopupLot(thiz, productCode, productCodeUser, productName) {

        var $tr = $(thiz).parent().parent().parent();
        if ($tr !== undefined && $tr !== null && $tr.length > 0) {
            var rd = $tr.attr('rd');

            var productCode = commonUtils.returnValue($tr.find('input.productcode-' + rd).val());
            if (!commonUtils.isNullOrEmpty(productCode)) {
                var invBUPattern = '';
                var iF_InvInStatus = commonUtils.returnValueText('#IF_InvInStatus');
                var viewType = commonUtils.returnValueText('#manageForm .ViewType');
                var $option = $('#InvCodeIn').find(":selected");
                if ($option !== undefined && $option !== null && $option.length > 0) {
                    invBUPattern = $option.attr('InvBUPattern');
                }

                var listInvF_InventoryInInstLot = []; @* Danh sách LOT của hàng hóa - table-detailLot *@
                var rows = $('tbody#table-detailLot tr[productcode="' + productCode + '"]').length;
                if (rows > 0) {
                    $('tbody#table-detailLot tr[productcode="' + productCode + '"]').each(function () {
                        debugger;
                        var $tr = $(this);
                        var objInvF_InventoryInInstLotCur = {};
                        objInvF_InventoryInInstLotCur.ProductCode = productCode;
                        objInvF_InventoryInInstLotCur.ProductLotNo = commonUtils.returnValue($tr.find('input.ProductLotNo').val());
                        objInvF_InventoryInInstLotCur.ProductionDate = commonUtils.returnValue($tr.find('input.ProductionDate').val());
                        objInvF_InventoryInInstLotCur.ExpiredDate = commonUtils.returnValue($tr.find('input.ExpiredDate').val());
                        objInvF_InventoryInInstLotCur.Qty = commonUtils.returnValue($tr.find('input.Qty').val());
                        objInvF_InventoryInInstLotCur.InvCodeInActual = commonUtils.returnValue($tr.find('input.InvCodeInActual').val());

                        listInvF_InventoryInInstLot.push(objInvF_InventoryInInstLotCur);
                    });
                }

                var objListLOT = commonUtils.returnJSONValue(listInvF_InventoryInInstLot);
                var url = '@Url.Action("ShowLo", "InvF_InventoryIn")';
                var token = $('#manageForm input[name=__RequestVerificationToken]').val();

                $.ajax({
                    type: 'post',
                    data: {
                        productcode: productCode,
                        productcodeuser: productCodeUser,
                        productName: productName,
                        invbupattern: invBUPattern,
                        listlot: objListLOT,
                        ifinvinstatus: iF_InvInStatus, @* Trạng thái phiếu nhập để hiển thị button trên popup *@
                        viewtype: viewType,
                        __RequestVerificationToken: token,
                    },
                    url: url,
                    dataType: 'json',
                    beforeSend: function () {
                    }
                }).done(function (objResult) {
                    if (objResult.Success) {
                        $("#ShowPopupLot").html('');
                        $("#ShowPopupLot").html(objResult.Html); // truyen html vao #form
                        $('#ShowPopupLot').modal({
                            backdrop: false,
                            keyboard: true,
                        });
                        $('#ShowPopupLot').modal('show');
                    } else {
                        _showErrorMsg123('Lỗi!', objResult.Detail);
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {

                }).always(function () {

                });

            }
        }
    }

    function closePopupLo() {
        $('#ShowPopupLot').modal('hide');
        $('#ShowPopupLot').on('hidden.bs.modal', function () {
            $('#ShowPopupLot form')[0].reset();
        });
    }
</script>

<script type="text/javascript">
    function renderProductInvFInventoryInInstLot(data) {
        debugger;
        var date = new Date();
        var randomCur = date.getTime();
        var randHex = commonUtils.randHex(12);
        randomCur = randomCur + randHex;

        var objProduct_InvF_InventoryInInstLot = data.Product_InvF_InventoryInInstLot;
        var listMst_Inventory = data.Lst_Mst_Inventory;

        if (objProduct_InvF_InventoryInInstLot !== undefined && objProduct_InvF_InventoryInInstLot !== null) {
            var invCodeInActual = commonUtils.returnValue(objProduct_InvF_InventoryInInstLot.InvCodeInActual);
            if (true) {
                var select2Css = 'select2-' + randomCur;
                var productlotnoCss = 'productlotno-' + randomCur;
                var productiondateCss = 'productiondate-' + randomCur;
                var expireddateCss = 'expireddate-' + randomCur;
                var qtyCss = 'qty-' + randomCur;

                var extData = {
                    select2Css: select2Css,
                    productlotnoCss: productlotnoCss,
                    productiondateCss: productiondateCss,
                    expireddateCss: expireddateCss,
                    qtyCss: qtyCss,
                    rd: randomCur,
                    idx: 9999,
                };

                var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_LOT_Add'), objProduct_InvF_InventoryInInstLot, extData));

                if (listMst_Inventory !== undefined && listMst_Inventory !== null && listMst_Inventory.length > 0) {
                    for (var i = 0; i < listMst_Inventory.length; i++) {
                        var invCodeCur = commonUtils.returnValue(listMst_Inventory[i].InvCode);
                        @* Add vị trí kho *@
                        var $select = $item.find('select.select2');
                        if ($select !== undefined && $select !== null) {
                            var $optgroup = $select.find('optgroup');
                            if ($optgroup !== undefined && $optgroup !== null) {
                                var selected = '';
                                if (invCodeInActual === invCodeCur) {
                                    selected = 'selected="selected"';
                                }

                                var extData_Options = {
                                    selected: selected,
                                };
                                var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_options_InvCodeInActual'), listMst_Inventory[i], extData_Options));
                                $option.appendTo($optgroup);
                            }
                        }
                    }
                }

                $item.appendTo($('#table-tbodyIDLo'));
                var tableName = 'InvF_InventoryIn';
                var qtyformat = objMst_ColumnConfig.returnValueColumnFormat_V2(tableName, 'Qty');

                $('.' + qtyCss).number(true, qtyformat);

                $('.' + productiondateCss + ', .' + expireddateCss).datepicker({
                    autoclose: true,
                    format: 'yyyy-mm-dd'
                })


                $('.' + select2Css).select2({
                    minimumResultsForSearch: -1
                });
                commonUtils.updateTableTrNotShowIdx($('#table-tbodyIDLo tr.trdata'), true);

            }
        }

    }
</script>

<script type="text/javascript">
    function product_InvF_InventoryInInstLot_AddNewRow() {
        var objProduct_InvF_InventoryInInstLot = {
            InvCodeInActual: '',
            ProductLotNo: '',
            ProductionDate: '',
            ExpiredDate: '',
            Qty: '',
            ProductCode: '',
        }
        var objProduct_InvF_InventoryInInstLot_AddRow = {
            Product_InvF_InventoryInInstLot: objProduct_InvF_InventoryInInstLot,
            Lst_Mst_Inventory: Lst_Mst_Inventory_LOT,
        };

        renderProductInvFInventoryInInstLot(objProduct_InvF_InventoryInInstLot_AddRow);
    }

    function product_LOT_DeleteRow(thiz) {
        var rows = $('tbody#table-tbodyIDLo tr.trdata').length;
        if (rows > 0) {
            var $tr = $(thiz).parent().parent();
            if ($tr !== undefined && $tr !== null && $tr.length > 0) {
                $tr.remove();
            }
            if (rows > 1) {
                commonUtils.updateTableTrNotShowIdx($('tbody#table-tbodyIDLo tr.trdata'), true);
            } else {
                // Css lại table head
            }
        }
    }

    function checkForm_PopupLOT() {
        var listError = [];
        var message = '';
        var fTotalQty = 0.0;
        debugger;
        var rows = $('tbody#table-tbodyIDLo tr.trdata').length;

        if (rows > 0) {
            debugger
            var productCode = commonUtils.returnValueText('#manageFormShowPopupLo input.ProductCode_Popup_InvCodeInActual_LOT');
            var $trInvF_InventoryInDtl = $('#table-tbodyID').find('tr[productcode="' + productCode + '"]');
            if ($trInvF_InventoryInDtl !== undefined && $trInvF_InventoryInDtl !== null && $trInvF_InventoryInDtl.length > 0) {
                var rdInvF_InventoryInDtl = $trInvF_InventoryInDtl.attr('rd');
                //var $inputQty = $trInvF_InventoryInDtl.find('input.planqty-' + rdInvF_InventoryInDtl);
                var planQty = commonUtils.parseFloat(commonUtils.returnValue($trInvF_InventoryInDtl.find('td.Qty input.planqty-' + rdInvF_InventoryInDtl).val()));
            }
            var arrLOTNo_InvCodeInActual = [];
            $('tbody#table-tbodyIDLo tr.trdata').each(function () {
                debugger;
                var $tr = $(this);
                var rd = $tr.attr('rd');

                var productLotNo = commonUtils.returnValue($tr.find('input.productlotno-' + rd).val());
                var invCode = '';
                if (commonUtils.isNullOrEmpty(productLotNo)) {
                    message = '';
                    message = 'Chưa nhập số lô';
                    var objToastr = { ToastrType: 'error', ToastrMessage: message };
                    listError.push(objToastr);
                }
                else {

                    //var productionDate = commonUtils.returnValue($tr.find('input.productiondate-' + rd).val());
                    //if (commonUtils.isNullOrEmpty(productionDate)) {
                    //    message = '';
                    //    message = 'Chưa nhập ngày sản xuất';
                    //    var objToastr = { ToastrType: 'error', ToastrMessage: message };
                    //    listError.push(objToastr);
                    //}
                    //var expiredDate = commonUtils.returnValue($tr.find('input.expireddate-' + rd).val());
                    //if (commonUtils.isNullOrEmpty(expiredDate)) {
                    //    message = '';
                    //    message = 'Chưa nhập ngày hết hạn';
                    //    var objToastr = { ToastrType: 'error', ToastrMessage: message };
                    //    listError.push(objToastr);
                    //}

                    var $select = $tr.find('select.select2-' + rd);
                    if ($select !== undefined && $select !== null && $select.length > 0) {
                        invCode = commonUtils.returnValue($select.val());
                        if (commonUtils.isNullOrEmpty(invCode)) {
                            message = '';
                            message = 'Chưa chọn vị trí';
                            var objToastr = { ToastrType: 'error', ToastrMessage: message };
                            listError.push(objToastr);
                        }
                    }
                    if (!commonUtils.isNullOrEmpty(productLotNo) && !commonUtils.isNullOrEmpty(invCode)) {
                        const found = arrLOTNo_InvCodeInActual.some(el => el.ProductLotNo === productLotNo && el.InvCodeInActual === invCode);
                        if (!found) {
                            arrLOTNo_InvCodeInActual.push({ ProductLotNo: productLotNo, InvCodeInActual: invCode });
                        }
                        else {
                            message = '';
                            message = 'Số lô "' + productLotNo + '" - vị trí "' + invCode + '" bị trùng';
                            var objToastr = { ToastrType: 'error', ToastrMessage: message };
                            listError.push(objToastr);
                        }
                    }

                    var qty = commonUtils.returnValue($tr.find('input.qty-' + rd).val());
                    if (commonUtils.isNullOrEmpty(qty)) {
                        message = '';
                        message = 'Chưa nhập số lượng của số lô "' + productLotNo + '"';
                        if (!commonUtils.isNullOrEmpty(invCode)) {
                            message = 'Chưa nhập số lượng của số lô "' + productLotNo + '" - vị trí "' + invCode + '"';
                        }
                        var objToastr = { ToastrType: 'error', ToastrMessage: message };
                        listError.push(objToastr);
                    }
                    else {
                        debugger
                        var fQty = commonUtils.parseFloat(qty);
                        fTotalQty += fQty;
                        if (fQty < 0) {
                            message = '';
                            message = 'Số lượng của số lô "' + productLotNo + '" >= 0';
                            if (!commonUtils.isNullOrEmpty(invCode)) {
                                message = 'Số lượng của số lô "' + productLotNo + '" - vị trí "' + invCode + '" >= 0';
                            }
                            var objToastr = { ToastrType: 'error', ToastrMessage: message };
                            listError.push(objToastr);
                        }

                       

                        
                    }
                }

            });
        }

        if (listError !== undefined && listError !== null && listError.length > 0) {
            commonUtils.showToastr(listError);
            return false;
        }
        return true;
    }

    function product_InvF_InventoryInInstLot_Save() {
        var rows = $('tbody#table-tbodyIDLo tr.trdata').length;
        var checked = $('#FlagNhapTuDH').prop('checked');
        if (rows > 0) {
            var productCode = commonUtils.returnValueText('#manageFormShowPopupLo input.ProductCode_Popup_InvCodeInActual_LOT');
            if (!commonUtils.isNullOrEmpty(productCode)) {

                var checkForm = checkForm_PopupLOT();
                if (checkForm) {
                    @* Xóa LOT - hàng hóa đã lưu cache *@
                    var rowOlds = $('#table-detailLot').find('tr[productcode="' + productCode + '"]').length;
                    if (rowOlds > 0) {
                        $('#table-detailLot').find('tr[productcode="' + productCode + '"]').each(function () {
                            $(this).remove();
                        });
                    }

                    @* Thêm LOT - hàng hóa vào cache *@
                    var strInvCodeInActual = '';
                    var fTotalQty = 0.0;
                    var arrayInvCode = [];
                    var lstVitri = "";
                    $("#table-tbodyIDLo tr.trdata").each(function () {
                        var $tr = $(this);
                        var rd = $tr.attr('rd');

                        var invCode = commonUtils.returnValue($tr.find('select.select2-' + rd).val());
                        var productLotNo = commonUtils.returnValue($tr.find('input.productlotno-' + rd).val());
                        var productionDate = commonUtils.returnValue($tr.find('input.productiondate-' + rd).val());
                        var expiredDate = commonUtils.returnValue($tr.find('input.expireddate-' + rd).val());
                        var fQty = commonUtils.parseFloat(commonUtils.returnValue($tr.find('input.qty-' + rd).val()));
                        if (invCode != null) {
                            if (arrayInvCode.includes(invCode) == false && fQty !== '0' && fQty > 0) {
                                arrayInvCode.push(invCode);
                                if (lstVitri == "") {
                                    lstVitri += invCode;
                                }
                                else {
                                    lstVitri += ", " + invCode;
                                }
                            }

                        }
                        fTotalQty += fQty;
                        var objProduct = {
                            ProductCode: productCode,
                            ProductLotNo: productLotNo,
                            ProductionDate: productionDate,
                            ExpiredDate: expiredDate,
                            Qty: fQty,
                            InvCodeInActual: invCode,
                        };

                        var extData = {
                            idx: 9999,
                        };

                        var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_LOT'), objProduct, extData));
                        $item.appendTo($('#table-detailLot'));

                    });

                    commonUtils.updateTableTrNotShowIdx($('#table-detailLot tr.trdata'), true);


                    debugger

                    @* Update lại vị trí, số lượng *@
                    var $trInvF_InventoryInDtl = $('#table-tbodyID').find('tr[productcode="' + productCode + '"]');
                    if ($trInvF_InventoryInDtl !== undefined && $trInvF_InventoryInDtl !== null && $trInvF_InventoryInDtl.length > 0) {
                        var rdInvF_InventoryInDtl = $trInvF_InventoryInDtl.attr('rd');

                        var planQty = commonUtils.parseFloat(commonUtils.returnValue($trInvF_InventoryInDtl.find('td.Qty input.planqty-' + rdInvF_InventoryInDtl).val()));
                        if (fTotalQty > planQty && checked === true) {
                            bootbox.confirm({
                                title: 'THÔNG BÁO',
                                message: 'Số lượng nhập kho vượt quá số lượng đặt hàng sản xuất. Bạn có chắc muốn nhập?',
                                buttons: {
                                    'cancel': {
                                        label: 'Cancel',
                                        className: 'btn mybtn-Button btnButton'
                                    },
                                    'confirm': {
                                        label: 'Yes',
                                        className: 'btn mybtn-Button btnButton'
                                    }
                                },
                                callback: function (result) {
                                    if (result) {
                                        debugger
                                        var $inputQty = $trInvF_InventoryInDtl.find('input.qty-' + rdInvF_InventoryInDtl);
                                        if ($inputQty !== undefined && $inputQty !== null && $inputQty.length > 0) {
                                            $inputQty.val(fTotalQty);
                                        }

                                        var $inputInvCodeInActual = $trInvF_InventoryInDtl.find('input.invcodeinactual-' + rdInvF_InventoryInDtl);
                                        if ($inputInvCodeInActual !== undefined && $inputInvCodeInActual !== null && $inputInvCodeInActual.length > 0) {
                                            $inputInvCodeInActual.val(lstVitri);
                                        }

                                        tongTienHang();

                                    }
                                    else {
                                        closePopupLo();
                                    }
                                }
                            });
                        }
                        else {
                            var $inputQty = $trInvF_InventoryInDtl.find('input.qty-' + rdInvF_InventoryInDtl);
                            if ($inputQty !== undefined && $inputQty !== null && $inputQty.length > 0) {
                                $inputQty.val(fTotalQty);
                            }

                            var $inputInvCodeInActual = $trInvF_InventoryInDtl.find('input.invcodeinactual-' + rdInvF_InventoryInDtl);
                            if ($inputInvCodeInActual !== undefined && $inputInvCodeInActual !== null && $inputInvCodeInActual.length > 0) {
                                $inputInvCodeInActual.val(lstVitri);
                            }

                            tongTienHang();
                        }


                       
                    }

                    closePopupLo();
                }
            }
        }
    }
</script>

@*End Popup LOT*@

@*End Danh mục hàng hóa*@

@*Thông tin xác thực*@
@*Load hàng hóa vào dropdown list hàng hóa xác thực*@
<script type="text/javascript">
    function reloadSelectPrd() {
        debugger
        $('#ProductCodeQR').find('option').remove();
        $('#ProductCodeQR').append($("<option></option>").attr("value", '').text('--Chọn hàng hóa--'));

        var rows = $('tbody#table-tbodyID tr').length;
        if (rows > 0) {
            $("#table-tbodyID tr.trdata").each(function () {
                var $tr = $(this);
                var rd = $tr.attr('rd');
                var productCode = commonUtils.returnValue($tr.find('input.productcode-' + rd).val());
                var productCodeUser = commonUtils.returnValue($tr.find('input.productcodeuser-' + rd).val());
                var productName = commonUtils.returnValue($tr.find('input.productname-' + rd).val());
                var flagLot = commonUtils.returnValue($tr.find('input.flaglot-' + rd).val());
                var flagSerial = commonUtils.returnValue($tr.find('input.flagserial-' + rd).val());

                if (flagLot === '0' && flagSerial === '0') {
                    $('#ProductCodeQR').append($("<option></option>").attr("value", productCode).attr("productcodeuser", productCodeUser).attr("productname", productName).text(productCodeUser + ' - ' + productName));
                }
            });
        }
    }
</script>
@*Thêm - xóa hàng hóa xác thực*@
<script type="text/javascript">
    function changeProductCodeQR(thiz) {
        debugger;
        var $select = $(thiz);
        if ($select !== undefined && $select !== null && $select.length > 0) {
            var productCode = commonUtils.returnValue($select.val());
            if (!commonUtils.isNullOrEmpty(productCode)) {
                var $option = $select.find(":selected");

                if ($option !== undefined && $option !== null && $option.length > 0) {
                    var productName = commonUtils.returnValue($option.attr('productname'));
                    var productCodeUser = commonUtils.returnValue($option.attr('productcodeuser'));

                    var date = new Date();
                    var randomCur = date.getTime();
                    var randHex = commonUtils.randHex(12);
                    randomCur = randomCur + randHex;

                    var objInvF_InventoryInQR = {
                        ProductCode: productCode,
                        ProductCodeUser: productCodeUser,
                        ProductName: productName,
                        QRCode: '',
                        NetworkID: '',
                        BoxNo: '',
                        CanNo: '',
                        ProductLotNo: '',
                        ShiftInCode: '',
                        UserKCS: '',
                    };

                    var productcodeCss = 'productcode-' + randomCur;
                    var productcodeuserCss = 'productcodeuser-' + randomCur;
                    var productnameCss = 'productname-' + randomCur;
                    var qrcodeCss = 'qrcode-' + randomCur;
                    var boxnoCss = 'boxno-' + randomCur;
                    var cannoCss = 'canno-' + randomCur;
                    var productlotnoCss = 'productlotno-' + randomCur;
                    var shiftincodeCss = 'shiftincode-' + randomCur;
                    var userkcsCss = 'userkcs-' + randomCur;

                    var extData = {
                        productcodeCss: productcodeCss,
                        productcodeuserCss: productcodeuserCss,
                        productnameCss: productnameCss,
                        qrcodeCss: qrcodeCss,
                        boxnoCss: boxnoCss,
                        cannoCss: cannoCss,
                        productlotnoCss: productlotnoCss,
                        shiftincodeCss: shiftincodeCss,
                        userkcsCss: userkcsCss,
                        rd: randomCur,
                        idx: 9999,
                    };


                    var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_InvF_InventoryInQR'), objInvF_InventoryInQR, extData));

                    $item.appendTo($('#table-tbodyIDXacThuc'));
                    commonUtils.updateTableTrNotShowIdx($('#table-tbodyIDXacThuc tr.trdata'), true);
                }

                $select.val('');
                $select.trigger('change');
            }
        }
    }

    function deleteRow_InvF_InventoryInQR(thiz) {
        var rows = $('tbody#table-tbodyIDXacThuc tr.trdata').length;
        if (rows > 0) {
            debugger;
            var $tr = $(thiz).parent().parent();
            if ($tr !== undefined && $tr !== null) {

                $tr.remove();

            }
            if (rows > 1) {
                commonUtils.updateTableTrNotShowIdx($('tbody#table-tbodyIDXacThuc tr.trdata'), true);

            } else {
                // Css lại table head
            }
        }
    }
</script>
@*Cắt Mã xác thực, mã hộp, mã thùng - Chưa rõ nghiệp vụ chỗ này*@
<script type="text/javascript">
    function splitQRCode(thiz) {
        setTimeout(function () {
            var qrCodeText = commonUtils.returnValue($(thiz).val());
            if (commonUtils.isNullOrEmpty(qrCodeText)) {
                return;
            }
            else {
                var fields = qrCodeText.split('=');
                if (fields.length >= 2) {
                    var qrCode = fields[1];
                    $(thiz).val(qrCode);
                }
            }
        }, 0);
    }
</script>
<script type="text/javascript">
    function renderInvF_InventoryInQRCode(data) {
        debugger
        var date = new Date();
        var randomCur = date.getTime();
        var randHex = commonUtils.randHex(12);
        randomCur = randomCur + randHex;

        var listData = data.Lst_InvF_InventoryInQR;
        var objInvF_InventoryInQR = data.InvF_InventoryInQR;
        if (objInvF_InventoryInQR !== undefined && objInvF_InventoryInQR !== null) {
            if (true) {
                var productcodeuserCss = 'productcodeuserCss-' + randomCur;
                var productnameCss = 'productnameCss-' + randomCur;
                var qrcodeCss = 'qrcode-' + randomCur;
                var boxnoCss = 'boxnoCss-' + randomCur;
                var cannoCss = 'cannoCss-' + randomCur;
                var productlotnoCss = 'productlotnoCss-' + randomCur;
                var shiftincodeCss = 'shiftincodeCss-' + randomCur;
                var userkcsCss = 'userkcsCss-' + randomCur;

                var extData = {
                    productcodeuserCss: productcodeuserCss,
                    productnameCss: productnameCss,
                    qrcodeCss: qrcodeCss,
                    boxnoCss: boxnoCss,
                    cannoCss: cannoCss,
                    productlotnoCss: productlotnoCss,
                    shiftincodeCss: shiftincodeCss,
                    userkcsCss: userkcsCss,
                    rd: randomCur,
                    idx: 9999,
                };

                var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_InvF_InventoryInQR'), objInvF_InventoryInQR, extData));


                $item.appendTo($('#table-tbodyIDXacThuc'));

                commonUtils.updateTableTrNotShowIdx($('#table-tbodyIDXacThuc tr.trdata'), true);

            }
        }
    }
</script>
@*End Thông tin xác thực*@

@*Xử lý import file*@
<script type="text/javascript">
    var objCommonExcel = new CommonExcel();
    var objVariablesInit = {
        Id_FormMain: '',
        Id_FormImportExcel: 'manageFormImportExcel',
        Id_Modal: 'ImportExcelModal',
        Id_FileInput: 'file',
    };

    var ajaxSettings_Excel = {};
    ajaxSettings_Excel.Type = 'post';
    ajaxSettings_Excel.DataType = 'json';

    function ImportProducts() {
        $('#key').val("PRODUCT");
        $('#file').val('');
        ShowPopupImportExcel();
    }
    function ImportLot() {
        $('#key').val("LOT");
        $('#file').val('');
        ShowPopupImportExcel();
    }
    function ImportSerial() {
        $('#key').val("SERIAL");
        $('#file').val('');
        ShowPopupImportExcel();
    }
    function ImportQR() {
        $('#key').val("QR");
        $('#file').val('');
        ShowPopupImportExcel();
    }

    function ShowPopupImportExcel() {
        $('#ImportExcelModal').modal('show')
    }

    function CloseModalImportExcel() {
        $('#ImportExcelModal').modal('hide')
        $('#ImportExcelModal').on('hidden.bs.modal', function () {
            $(this).find('#manageFormImportExcel').trigger('reset');
        });
    }

    function Import() {
        var file = $("#file").val();

        if (file.length === 0) {
            alert("Nhập file cần Import");
            $("#file").val('');
            return false;
        } else {
            var checkFile = false;
            var _index = file.lastIndexOf('.');
            if (_index !== undefined && _index !== null && _index > 0) {
                var fileType = file.substring(_index + 1, file.length).toLowerCase();
                if (fileType === 'xls' || fileType.toLowerCase() === 'xlsx') {
                    checkFile = true;
                }
            }
            if (checkFile) {
                var key = $("#key").val();
                if (key.toString().toUpperCase().trim() == "PRODUCT") {
                    ImportFileExcelProduct();
                }
                else if (key.toString().toUpperCase().trim() == "LOT") {
                    ImportFileExcelLot();
                }
                else if (key.toString().toUpperCase().trim() == "SERIAL") {
                    ImportFileExcelSerial();
                }
                else if (key.toString().toUpperCase().trim() == "QR") {
                    ImportFileExcelQR();
                }
            } else {
                alert("File Excel Import không hợp lệ!");
            }
        }
    }

    function ImportFileExcelProduct() {
        debugger;
        var formData = new window.FormData($('#manageFormImportExcel')[0]);
        var invCodeIn = commonUtils.returnValueText('#InvCodeIn');
        if (commonUtils.isNullOrEmpty(invCodeIn)) {
            var listToastr = [];
            objToastr = { ToastrType: 'error', ToastrMessage: '@MvcHtmlString.Create("Chưa chọn kho nhập".HtmlItemString("ordorderdl"))' };
            listToastr.push(objToastr);
            commonUtils.showToastr(listToastr);

            commonUtils.setFocus('InvCodeIn');
            return false;
        }
        else {
            var invBUPattern = '';
            var iF_InvInStatus = commonUtils.returnValueText('#IF_InvInStatus');
            var viewType = commonUtils.returnValueText('#manageForm .ViewType');
            var $option = $('#InvCodeIn').find(":selected");
            if ($option !== undefined && $option !== null && $option.length > 0) {
                invBUPattern = $option.attr('InvBUPattern');
            }


            formData.append('tax_file', $('input[type=file]')[0].files[0]);
            formData.append('invBUPattern', invBUPattern);

            $('#ImportExcelModal').modal("hide");
            //Loading();
            var url = '@(Url.Action("ImportProduct", "InvF_InventoryIn"))';
            $.ajax({
                url: url,
                data: formData,
                type: 'post',
                beforeSend: function () { },
                success: function (objResult) {
                    //Endloading();
                    if (objResult.Success) {
                        //resetTable_Empty();
                        var listData = objResult.ListInvFInventoryInDtlUI;
                        if (listData !== undefined && listData !== null && listData.length > 0) {

                            var $tableProduct_InvCodeInActual_Cache = $('#table-detailInvCodeInActual'); @* Cache hàng hóa - vị trí *@

                            for (var i = 0; i < listData.length; i++) {

                                var Lst_Product_InvCodeInActual = [];
                                var Lst_InvF_InventoryInDtl = [];
                                var objInvF_InventoryInDtl = listData[i];
                                Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl);

                                var objInvF_InventoryInDtlRender = {
                                    InvF_InventoryInDtl: objInvF_InventoryInDtl,
                                    Lst_InvF_InventoryInDtl: Lst_InvF_InventoryInDtl,
                                };
                                renderInvF_InventoryInDtl_MultiExcel(objInvF_InventoryInDtlRender);

                                if (objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI !== undefined
                                    && objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI !== null
                                    && objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI.length > 0) {

                                    var productCodeBase = commonUtils.returnValue(objInvF_InventoryInDtl.ProductCodeBase);
                                    var productCode = commonUtils.returnValue(objInvF_InventoryInDtl.ProductCode);
                                    for (var j = 0; j < objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI.length; j++) {
                                        Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI[j]);
                                        var productCodeBaseCur = objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI[j].ProductCodeBase;
                                        var productCodeCur = objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI[j].ProductCode;


                                        if (productCodeBase === productCodeBaseCur) {
                                            @* Add danh sách hàng hóa cache *@
                                            var $divProducts = $('div.products-list');
                                            if ($divProducts !== undefined && $divProducts !== null && $divProducts.length > 0) {
                                                debugger;
                                                var $product = $(commonUtils.getHtmlFromTemplate($('#tmpl_products_list'), objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI[j]));
                                                $product.appendTo($divProducts);

                                            }
                                            @* Add đơn vị hàng hóa *@

                                            var $item = $(commonUtils.getHtmlFromTemplate($('#tmpl_InvF_InventoryIn'), objInvF_InventoryInDtl));
                                            var $select = $item.find('select.select2');
                                            var $optgroup = $select.find('optgroup');
                                            var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_options'), objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI[j]));
                                            $option.appendTo($optgroup);
                                            //if ($select !== undefined && $select !== null) {
                                            //    var $optgroup = $select.find('optgroup');
                                            //    if ($optgroup !== undefined && $optgroup !== null) {
                                            //        var selected = '';
                                            //        if (productCode === productCodeCur) {
                                            //            selected = 'selected="selected"';
                                            //        }

                                            //        var extData_Options = {
                                            //            selected: selected,
                                            //        };
                                            //        var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_options'), objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI[j], extData_Options));
                                            //        $option.appendTo($optgroup);
                                            //    }
                                            //}

                                        }
                                    }
                                }


                                var flagLot = commonUtils.returnValue(objInvF_InventoryInDtl.FlagLot);
                                var flagSerial = commonUtils.returnValue(objInvF_InventoryInDtl.FlagSerial);

                                if (flagLot === '0' && flagSerial === '0') {
                                    Lst_Product_InvCodeInActual = objInvF_InventoryInDtl.Lst_Product_InvCodeInActual;

                                    if (Lst_Product_InvCodeInActual !== undefined && Lst_Product_InvCodeInActual !== null && Lst_Product_InvCodeInActual.length > 0) {
                                        var extData_Product_InvCodeInActual_Cache = {};
                                        var $trProduct_InvCodeInActual_Cache = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_InvCodeInActual'), objInvF_InventoryInDtl, extData_Product_InvCodeInActual_Cache));
                                        $trProduct_InvCodeInActual_Cache.appendTo($tableProduct_InvCodeInActual_Cache);

                                        var $divList_Product_InvCodeInActual_Cache = $trProduct_InvCodeInActual_Cache.find('div.products-list-cache');


                                        if ($divList_Product_InvCodeInActual_Cache !== undefined && $divList_Product_InvCodeInActual_Cache !== null && $divList_Product_InvCodeInActual_Cache.length > 0) {

                                            for (var k = 0; k < Lst_Product_InvCodeInActual.length; k++) {
                                                var extData_Product_InvCodeInActual = {
                                                    idx: 99999,
                                                };
                                                var obj = Lst_Product_InvCodeInActual[k];
                                                var $divProduct_InvCodeInActual = $(commonUtils.getHtmlFromTemplate($('#tmpl_product_invcodeinactual_list_cache'), obj, extData_Product_InvCodeInActual));
                                                $divProduct_InvCodeInActual.appendTo($divList_Product_InvCodeInActual_Cache);
                                            }

                                            commonUtils.updateTableTrNotShowIdx($('#table-detailInvCodeInActual tr.trdata'), true);

                                        }
                                    }
                                }



                            }
                        }
                    }
                    else {
                        var listError = [];
                        var message = commonUtils.returnValue(objResult.Messages[0]);
                        if (!commonUtils.isNullOrEmpty(message)) {
                            var objToastr = { ToastrType: 'error', ToastrMessage: message };
                            listError.push(objToastr);
                        }
                        if (listError !== undefined && listError !== null && listError.length > 0) {
                            commonUtils.showToastr(listError);
                        }
                        var detail = commonUtils.returnValue(objResult.Detail);
                        if (!commonUtils.isNullOrEmpty(detail)) {
                            _showErrorMsg123('Lỗi!', detail);
                        }
                    }
                },
                error: function () {
                    //Endloading();
                },
                cache: false,
                contentType: false,
                //dataType: "json",
                processData: false
            });


        }

    }

    function ImportFileExcelSerial() {
        debugger
        var formData = new window.FormData($('#manageFormImportExcel')[0]);
        var invCodeIn = commonUtils.returnValueText('#InvCodeIn');
        if (commonUtils.isNullOrEmpty(invCodeIn)) {
            var listToastr = [];
            objToastr = { ToastrType: 'error', ToastrMessage: '@MvcHtmlString.Create("Chưa chọn kho nhập".HtmlItemString("ordorderdl"))' };
            listToastr.push(objToastr);
            commonUtils.showToastr(listToastr);

            commonUtils.setFocus('InvCodeIn');
            return false;
        }
        else {
            var invBUPattern = '';
            var iF_InvInStatus = commonUtils.returnValueText('#IF_InvInStatus');
            var viewType = commonUtils.returnValueText('#manageForm .ViewType');
            var $option = $('#InvCodeIn').find(":selected");
            if ($option !== undefined && $option !== null && $option.length > 0) {
                invBUPattern = $option.attr('InvBUPattern');
            }
            formData.append('tax_file', $('input[type=file]')[0].files[0]);
            formData.append('invBUPattern', invBUPattern);
            $('#ImportExcelModal').modal("hide");
            //Loading();
            var url = '@(Url.Action("ImportSerial", "InvF_InventoryIn"))';
            $.ajax({
                url: url,
                data: formData,
                type: 'post',
                beforeSend: function () { },
                success: function (objResult) {
                    if (objResult.Success) {
                        //resetTable_Empty();
                        var listData = objResult.ListInvFInventoryInDtlUI;
                        if (listData !== undefined && listData !== null && listData.length > 0) {
                            var $tableSerial_Cache = $('#table-detailSerial'); @* Cache hàng hóa serial - vị trí *@
                            for (var i = 0; i < listData.length; i++) {

                                var Lst_Product_InvCodeInActual = [];
                                var Lst_InvF_InventoryInDtl = [];
                                var objInvF_InventoryInDtl = listData[i];
                                Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl);
                                if (objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI !== undefined
                                    && objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI !== null
                                    && objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI.length > 0) {
                                    for (var j = 0; j < objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI.length; j++) {
                                        Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI[j]);
                                    }
                                }
                                var objInvF_InventoryInDtlRender = {
                                    InvF_InventoryInDtl: objInvF_InventoryInDtl,
                                    Lst_InvF_InventoryInDtl: Lst_InvF_InventoryInDtl,
                                };
                                renderInvF_InventoryInDtl_MultiExcel(objInvF_InventoryInDtlRender);

                                var Lst_Product_InvCodeInActual = [];
                                Lst_Product_InvCodeInActual = objInvF_InventoryInDtl.Lst_Product_InvSerial;
                                if (Lst_Product_InvCodeInActual !== undefined && Lst_Product_InvCodeInActual !== null && Lst_Product_InvCodeInActual.length > 0) {
                                    var extData_Product_InvCodeInActual_Cache = {
                                        idx: 9999,
                                    };
                                    for (var item = 0; item < Lst_Product_InvCodeInActual.length; item++) {
                                        obj = Lst_Product_InvCodeInActual[item];
                                        var $trSerial_Cache = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_Serial'), obj, extData_Product_InvCodeInActual_Cache));
                                        $trSerial_Cache.appendTo($tableSerial_Cache);


                                        commonUtils.updateTableTrNotShowIdx($('#table-detailSerial tr.trdata'), true);
                                    }
                                }
                            }
                        }

                    }
                    else {
                        var listError = [];
                        var message = commonUtils.returnValue(objResult.Messages[0]);
                        if (!commonUtils.isNullOrEmpty(message)) {
                            var objToastr = { ToastrType: 'error', ToastrMessage: message };
                            listError.push(objToastr);
                        }
                        if (listError !== undefined && listError !== null && listError.length > 0) {
                            commonUtils.showToastr(listError);
                        }
                        var detail = commonUtils.returnValue(objResult.Detail);
                        if (!commonUtils.isNullOrEmpty(detail)) {
                            _showErrorMsg123('Lỗi!', detail);
                        }
                    }
                },
                error: function () {
                    //Endloading();
                },
                cache: false,
                contentType: false,
                //dataType: "json",
                processData: false
            });
        }
    }

    function ImportFileExcelLot() {
        debugger
        var formData = new window.FormData($('#manageFormImportExcel')[0]);
        var invCodeIn = commonUtils.returnValueText('#InvCodeIn');
        if (commonUtils.isNullOrEmpty(invCodeIn)) {
            var listToastr = [];
            objToastr = { ToastrType: 'error', ToastrMessage: '@MvcHtmlString.Create("Chưa chọn kho nhập".HtmlItemString("ordorderdl"))' };
            listToastr.push(objToastr);
            commonUtils.showToastr(listToastr);

            commonUtils.setFocus('InvCodeIn');
            return false;
        }
        else {
            var invBUPattern = '';
            var iF_InvInStatus = commonUtils.returnValueText('#IF_InvInStatus');
            var viewType = commonUtils.returnValueText('#manageForm .ViewType');
            var $option = $('#InvCodeIn').find(":selected");
            if ($option !== undefined && $option !== null && $option.length > 0) {
                invBUPattern = $option.attr('InvBUPattern');
            }
            formData.append('tax_file', $('input[type=file]')[0].files[0]);
            formData.append('invBUPattern', invBUPattern);
            $('#ImportExcelModal').modal("hide");
            //Loading();
            var url = '@(Url.Action("ImportLot", "InvF_InventoryIn"))';
            $.ajax({
                url: url,
                data: formData,
                type: 'post',
                beforeSend: function () { },
                success: function (objResult) {
                    if (objResult.Success) {
                        //resetTable_Empty();
                        var listData = objResult.ListInvFInventoryInDtlUI;
                        if (listData !== undefined && listData !== null && listData.length > 0) {
                            var $tableSerial_Cache = $('#table-detailLot'); @* Cache hàng hóa lot - vị trí *@
                            for (var i = 0; i < listData.length; i++) {
                                var Lst_InvF_InventoryInDtl = [];
                                var objInvF_InventoryInDtl = listData[i];
                                Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl);
                                if (objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI !== undefined
                                    && objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI !== null
                                    && objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI.length > 0) {
                                    for (var j = 0; j < objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI.length; j++) {
                                        Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl.Lst_InvF_InventoryInDtlUI[j]);
                                    }
                                }
                                var objInvF_InventoryInDtlRender = {
                                    InvF_InventoryInDtl: objInvF_InventoryInDtl,
                                    Lst_InvF_InventoryInDtl: Lst_InvF_InventoryInDtl,
                                };
                                renderInvF_InventoryInDtl_MultiExcel(objInvF_InventoryInDtlRender);

                                var Lst_Product_InvCodeInActual = [];
                                Lst_Product_InvCodeInActual = objInvF_InventoryInDtl.Lst_Product_InvLot;
                                if (Lst_Product_InvCodeInActual !== undefined && Lst_Product_InvCodeInActual !== null && Lst_Product_InvCodeInActual.length > 0) {
                                    var extData_Product_InvCodeInActual_Cache = {
                                        idx: 9999,
                                    };
                                    for (var item = 0; item < Lst_Product_InvCodeInActual.length; item++) {
                                        obj = Lst_Product_InvCodeInActual[item];
                                        var $trSerial_Cache = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_LOT'), obj, extData_Product_InvCodeInActual_Cache));
                                        $trSerial_Cache.appendTo($tableSerial_Cache);

                                        commonUtils.updateTableTrNotShowIdx($('#table-detailLot tr.trdata'), true);
                                    }
                                }
                            }
                        }
                    }
                    else {
                        var listError = [];
                        var message = commonUtils.returnValue(objResult.Messages[0]);
                        if (!commonUtils.isNullOrEmpty(message)) {
                            var objToastr = { ToastrType: 'error', ToastrMessage: message };
                            listError.push(objToastr);
                        }
                        if (listError !== undefined && listError !== null && listError.length > 0) {
                            commonUtils.showToastr(listError);
                        }
                        var detail = commonUtils.returnValue(objResult.Detail);
                        if (!commonUtils.isNullOrEmpty(detail)) {
                            _showErrorMsg123('Lỗi!', detail);
                        }
                    }
                },
                error: function () {
                    //Endloading();
                },
                cache: false,
                contentType: false,
                //dataType: "json",
                processData: false

            });
        }
    }

    function ImportFileExcelQR() {
        var invBUPattern = '';
        var formData = new window.FormData($('#manageFormImportExcel')[0]);
        var invCodeIn = commonUtils.returnValueText('#InvCodeIn');
        var $option = $('#InvCodeIn').find(":selected");
        if ($option !== undefined && $option !== null && $option.length > 0) {
            invBUPattern = $option.attr('InvBUPattern');
        }
        formData.append('tax_file', $('input[type=file]')[0].files[0]);
        formData.append('invBUPattern', invBUPattern);
        
    var listProduct = [];
        
        var rows = $("tbody#table-tbodyID.GetPrd tr.trdata").length;
        if (rows > 0) {
            var trArr = $('tbody#table-tbodyID.GetPrd tr.trdata');
            if (trArr !== null && trArr.length > 0) {
                for (var i = 0; i < trArr.length; i++) {
                    var trCur = trArr[i];
                    if (trCur !== null && trCur !== undefined) {
                        var productCode = $(trCur).attr('productcode');
                        debugger

                        var rd = $(trCur).attr('rd');
                        var divCur = productCode;
                        if ($(divCur) !== undefined && $(divCur) !== null) {

                            var productname = $('tbody#table-tbodyID.GetPrd tr td').find('input.productname-' + rd).val();
                            var productcodeuser = $('tbody#table-tbodyID.GetPrd tr td').find('input.productcodeuser-' + rd).val();
                            var flagLot = $('tbody#table-tbodyID.GetPrd tr td').find('input.flaglot-' + rd).val();
                            var flagSerial = $('tbody#table-tbodyID.GetPrd tr td').find('input.flagserial-' + rd).val();
                        }
                        if (flagLot == 0 && flagSerial == 0) {
                            var objProduct = {};
                            objProduct.ProductCodeUser = productcodeuser;
                            objProduct.ProductCode = productCode;
                            objProduct.ProductName = productname;
                            listProduct.push(objProduct);
                        }
                    }
                }
            }
        }
        $('#ImportExcelModal').modal("hide");
        var url = '@(Url.Action("ImportQR", "InvF_InventoryIn"))';
        formData.append('listProduct', JSON.stringify(listProduct));
        $.ajax({
            url: url,
            data: formData,
            type: 'post',
            beforeSend: function () { },
            success: function (objResult) {
                debugger
                if (objResult.Success) {
                    //resetTable_Empty();
                    var listData = objResult.Lst_InvF_InventoryInQR;
                    if (listData !== undefined && listData !== null && listData.length > 0) {
                        for (var i = 0; i < listData.length; i++) {
                            var objData = {};
                                objData = listData[i];
                                objData.ProductCodeUser = listData[i].mp_ProductCodeUser;
                                objData.ProductName = listData[i].mp_Productname;
                            var objInvFQRCode = {
                                InvF_InventoryInQR: objData,
                            };
                            renderInvF_InventoryInQRCode(objInvFQRCode);
                        }
                    }
                }
                else {
                    var listError = [];
                    var message = commonUtils.returnValue(objResult.Messages[0]);
                    if (!commonUtils.isNullOrEmpty(message)) {
                        var objToastr = { ToastrType: 'error', ToastrMessage: message };
                        listError.push(objToastr);
                    }
                    if (listError !== undefined && listError !== null && listError.length > 0) {
                        commonUtils.showToastr(listError);
                    }
                    var detail = commonUtils.returnValue(objResult.Detail);
                    if (!commonUtils.isNullOrEmpty(detail)) {
                        _showErrorMsg123('Lỗi!', detail);
                    }
                }
            },
            error: function () {
                //Endloading();
            },
            cache: false,
            contentType: false,
            //dataType: "json",
            processData: false
        });
    }
</script>
@*End xử lý import file*@

<script type="text/javascript">
    function renderInvF_InventoryInDtlCache(data) {
        debugger
        var listData = data.ListInvFInventoryInDtlUI;
        if (listData !== undefined && listData !== null && listData.length > 0) {

            var $tableProduct_InvCodeInActual_Cache = $('#table-detailInvCodeInActual'); @* Cache hàng hóa - vị trí *@

            for (var i = 0; i < listData.length; i++) {

                var Lst_Product_InvCodeInActual = [];
                var Lst_InvF_InventoryInDtl = [];
                var objInvF_InventoryInDtl = listData[i];
                Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl);



                var flagLot = commonUtils.returnValue(objInvF_InventoryInDtl.FlagLot);
                var flagSerial = commonUtils.returnValue(objInvF_InventoryInDtl.FlagSerial);

                if (flagLot === '0' && flagSerial === '0') {
                    Lst_Product_InvCodeInActual = Lst_InvF_InventoryInDtl;

                    if (Lst_Product_InvCodeInActual !== undefined && Lst_Product_InvCodeInActual !== null && Lst_Product_InvCodeInActual.length > 0) {
                        var extData_Product_InvCodeInActual_Cache = {};
                        var $trProduct_InvCodeInActual_Cache = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_InvCodeInActual'), objInvF_InventoryInDtl, extData_Product_InvCodeInActual_Cache));
                        $trProduct_InvCodeInActual_Cache.appendTo($tableProduct_InvCodeInActual_Cache);

                        var $divList_Product_InvCodeInActual_Cache = $trProduct_InvCodeInActual_Cache.find('div.products-list-cache');


                        if ($divList_Product_InvCodeInActual_Cache !== undefined && $divList_Product_InvCodeInActual_Cache !== null && $divList_Product_InvCodeInActual_Cache.length > 0) {

                            for (var k = 0; k < Lst_Product_InvCodeInActual.length; k++) {
                                var extData_Product_InvCodeInActual = {
                                    idx: 99999,
                                };
                                var obj = Lst_Product_InvCodeInActual[k];
                                var $divProduct_InvCodeInActual = $(commonUtils.getHtmlFromTemplate($('#tmpl_product_invcodeinactual_list_cache'), obj, extData_Product_InvCodeInActual));
                                $divProduct_InvCodeInActual.appendTo($divList_Product_InvCodeInActual_Cache);
                            }

                            commonUtils.updateTableTrNotShowIdx($('#table-detailInvCodeInActual tr.trdata'), true);

                        }
                    }
                }

            }
        }
    }
</script>
<script>
    function renderProductInvFInventoryInInstSerial_Cache(data) {
        debugger
        var listData = data.Lst_Mst_Inventory;
        if (listData != undefined && listData != null && listData.length > 0) {
            var $tableSerial_Cache = $('#table-detailSerial'); @* Cache hàng hóa serial - vị trí *@
            for (var i = 0; i < listData.length; i++) {

                var Lst_Serial = [];
                var Lst_SerialDtl = [];
                var objSerialDtl = listData[i];
                Lst_SerialDtl.push(objSerialDtl);


                Lst_Serial = Lst_SerialDtl;

                if (Lst_Serial !== undefined && Lst_Serial !== null && Lst_Serial.length > 0) {
                    var extData_Product_InvCodeInActual_Cache = {
                        idx: 9999,
                    };
                    for (var item = 0; item < Lst_Serial.length; item++) {
                        obj = Lst_Serial[item];
                        var $trSerial_Cache = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_Serial'), obj, extData_Product_InvCodeInActual_Cache));
                        $trSerial_Cache.appendTo($tableSerial_Cache);


                        commonUtils.updateTableTrNotShowIdx($('#table-detailSerial tr.trdata'), true);
                    }
                }

            }
        }
    }
</script>
<script type="text/javascript">
    function renderProductInvFInventoryInInstLot_Cache(data) {
        debugger
        var listData = data.Lst_Mst_Inventory;
        if (listData != undefined && listData != null && listData.length > 0) {
            var $tableSerial_Cache = $('#table-detailLot'); @* Cache hàng hóa lot - vị trí *@
            for (var i = 0; i < listData.length; i++) {

                var Lst_Lot = [];
                var Lst_LotDtl = [];
                var objLotDtl = listData[i];
                Lst_LotDtl.push(objLotDtl);


                Lst_Lot = Lst_LotDtl;

                if (Lst_Lot !== undefined && Lst_Lot !== null && Lst_Lot.length > 0) {
                    var extData_Product_InvCodeInActual_Cache = {
                        idx: 9999,
                    };
                    for (var item = 0; item < Lst_Lot.length; item++) {
                        obj = Lst_Lot[item];
                        var $trSerial_Cache = $(commonUtils.getHtmlFromTemplate($('#tmpl_Product_LOT'), obj, extData_Product_InvCodeInActual_Cache));
                        $trSerial_Cache.appendTo($tableSerial_Cache);

                        commonUtils.updateTableTrNotShowIdx($('#table-detailLot tr.trdata'), true);
                    }
                }

            }
        }
    }
</script>

@* Export excel *@
<script type="text/javascript">
    function ExportTemplate(url) {
        ajaxSettings_Excel.Url = url;

        objCommonExcel.ajaxSettingsInit();
        objCommonExcel.ajaxSettings = ajaxSettings_Excel;
        objCommonExcel.exportExcel();
    }
</script>
@* End Export excel *@

@* RefNo *@


@*<script type="text/javascript">
    $(document).ready(function () {
         @if (viewType.Equals("update"))
         {
             <text>
        var checked = $('#FlagNhapTuDH').prop('checked');
             </text>

         }

    });
</script>*@


<script type="text/javascript">
    $(document).ready(function (){
        $("#RefNo").focusout(function (){
            debugger
            var refno = $("#RefNo").val();
            var listError = [];
            if (refno === null || refno === undefined || refno.length === 0) {
          
                //listError = commonUtils.checkElementIsNullOrEmpty_AddListError(listError, '#RefNo', 'has-error-fix', 'Chưa nhập số refno!');

                //var refType = $('#RefType').val();
                //if (refType == '' || reftype == null || reftype == undefined) {
                //    var objToastr = {
                //        ToastrType: 'error',
                //        ToastrMessage: 'Chưa chọn reftype!'
                //    };
                //    listError.push(objToastr);
                //}
                //commonUtils.showToastr(listError);
                $("#RefNo").focus();
            }
            else{
                var invcodein = $('#InvCodeIn').val();
                if (invcodein === undefined || invcodein === '') {
                    var objToastr = {
                        ToastrType: 'error',
                        ToastrMessage: 'Chưa chọn kho nhập!'
                    };
                    listError.push(objToastr);

                    $('#InvCodeIn').focus();
                }

                //var refType = $('#RefType').val();
                //if (refType == '' || reftype == null || reftype == undefined) {
                //    var objToastr = {
                //        ToastrType: 'error',
                //        ToastrMessage: 'Chưa chọn reftype!'
                //    };
                //    listError.push(objToastr);
                //}
                if (listError !== undefined && listError !== null && listError.length > 0) {
                    commonUtils.showToastr(listError);

                }
                else {
                    $('#ShowPopupProductInOrderSearch #sRefNo').val(refno);
                    var token = $('#manageForm input[name=__RequestVerificationToken]').val();
                    var url = '@Url.Action("SearchProduct", "InvF_InventoryIn")';
                    $.ajax({
                        type: "post",
                        data: {
                            __RequestVerificationToken: token,
                            refno: refno
                        },
                        url: url,
                        dataType: 'json',
                        beforeSend: function () { }
                    }).done(function (result) {
                        if (result.Success) {
                            debugger;
                            
                            //$('#ordProductCode').html('');
                            //$('#ordProductCode').html(result.Html);
                            //$('#ordProductCode').select2();
                            //if (result.Html.length === 0 || result.Html === "\r\n") {
                            //    alert('Số phiếu in không tồn tại trong hệ thống');
                            //}
                            var lstRpt_OrderSummary_TotalProductForInv = result.LstRpt_OrderSummary_TotalProductForInv;
                            if (lstRpt_OrderSummary_TotalProductForInv == null || lstRpt_OrderSummary_TotalProductForInv.length == 0) {
                                var objToastr = {
                                    ToastrType: 'error',
                                    ToastrMessage: 'Số RefNo không có trong hệ thống !'
                                };
                                listError.push(objToastr);
                                commonUtils.showToastr(listError);
                                $('#CustomerCode').val('');
                                $('select#ordProductCode').val('');
                                $('select#ordProductCode').trigger('change');
                                $('#CustomerCode').trigger('change');
                                $('#CustomerCode').prop('disabled', false);
                            }
                            else {
                                $('#myInput').hide();

                                $('#divPrdOrder').show();
                                //Gán KH
                                //let optSelect = $('#ordProductCode').find('option:selected');
                                //debugger
                                //let customerCodeSys = $(optSelect).attr("CustomerCodeSys");
                                //let planQty = $(optSelect).attr("Planty");
                                //$('#PlanQty').val(planQty);
                                //$('#CustomerCode').val(customerCodeSys);
                                //$('#CustomerCode').trigger('change');
                                for (var i = 0; i < lstRpt_OrderSummary_TotalProductForInv.length; i++) {

                                    debugger
                                    var $select = $('select#ordProductCode');
                                    if ($select !== null && $select !== undefined) {
                                        var $optgroup = $select.find('optgroup');

                                        if ($optgroup != null && $optgroup !== undefined) {
                                            var selected = '';


                                            var extData_Options = {
                                                selected: selected,
                                            };


                                            var $option = $(commonUtils.getHtmlFromTemplate($('#tmpl_optionproductinorder'), lstRpt_OrderSummary_TotalProductForInv[i], extData_Options));
                                            $option.appendTo($optgroup);
                                        }
                                    }

                                    $('select#ordProductCode').select2();
                                    var customercodesys = lstRpt_OrderSummary_TotalProductForInv[i].CustomerCodeSys;
                                    $('#CustomerCode').val(customercodesys);
                                    $('#CustomerCode').trigger('change');
                                    $('#CustomerCode').prop('disabled', true);
                                }
                            }

                        } else {
                            if (!commonUtils.isNullOrEmpty(result.Detail)) {
                                showErrorDialog(result.Detail);
                            }
                            if (!commonUtils.isNullOrEmpty(result.Messages)) {
                                var listToastr = [];
                                objToastr = { ToastrType: 'error', ToastrMessage: result.Messages };
                                listToastr.push(objToastr);
                                commonUtils.showToastr(listToastr);
                            }
                        }
                    }).fail(function (jqXHR, textStatus, errorThrown) {

                    }).always(function (jqXHROrData, textStatus, jqXHROrErrorThrown) {
                        //alert("complete");
                    });
                }
            }
        });
    });
</script>
<script type="text/javascript">
    function AddProductToList(thiz) {
        debugger
        let productCode = $(thiz).val();
        let optSelect = $(thiz).find('option:selected');
        let productName = $(optSelect).attr("ProductName");
        let productCodeUser = $(optSelect).attr("ProductCodeUser");
        let unitCode = $(optSelect).attr("UnitCode");
        let uPIn = $(optSelect).attr("UPIn");
        let qty = $(optSelect).attr("Qty");
        let invCodeInActual = "";
        let flagLot = $(optSelect).attr("FlagLot");
        let flagSerial = $(optSelect).attr("FlagSerial");

        var planQty = $(optSelect).attr("PlanQty");
        let remark = "";

        let option = $(thiz).find('option:selected').val();
        if (option === "SEARCHDATA") {
            ShowPopupProductSearch();
        }
        else {

            var dataInput = {
                ProductCode: productCode,
                ProductCodeUser: productCodeUser,
                ProductName: productName,
                UnitCode: unitCode,
                UPIn: uPIn,
                Remark: remark,
                FlagSerial: flagSerial,
                FlagLot: flagLot,
                InvCodeInActual: invCodeInActual,
                Qty: qty,
                PlanQty: planQty
            };
            var LstDtl = [];
            LstDtl.push(dataInput);

            var objInvF_InventoryInDtlRender = {
                InvF_InventoryInDtl: dataInput,
                Lst_InvF_InventoryInDtl: LstDtl,
            };
            debugger
            renderInvF_InventoryInDtl(objInvF_InventoryInDtlRender);

            let customerCodeSys = $(optSelect).attr("CustomerCodeSys");
            $('#CustomerCode').val(customerCodeSys);
            $('#CustomerCode').trigger('change');

            var refnosys = $(optSelect).attr("OrderPDNoSys");
            $('#RefNoSys').val(refnosys);

           var planQty = $(optSelect).attr("Planty");
            $('#PlanQty').val(planQty);
            tongTienHang();
            $('#myInput').val('');
            commonUtils.setFocus('InvCodeIn');
        }

    }
</script>
@* End RefNo *@

@*Quét mã sản phẩm*@
<script type="text/javascript">
    function quetMaVach(thiz) {
        debugger;
        var listToastr = [];
        var flagmavach = commonUtils.returnValue($(thiz).attr('flagmavach'));
        if (flagmavach === '0') {

            var objToastr = { ToastrType: 'success', ToastrMessage: '@MvcHtmlString.Create("Bắt đầu chuyển sang chế độ quét".HtmlItemString("invf_inventorycusreturn"))' };
            listToastr.push(objToastr);
            commonUtils.showToastr(listToastr);

            flagmavach = '1';
            commonUtils.addClassCss('#myInput', 'display-none');
            commonUtils.removeClassCss('#quetmavach', 'display-none');
            commonUtils.setFocus('quetmavach');
        }
        else if (flagmavach === '1') {

            objToastr = { ToastrType: 'success', ToastrMessage: '@MvcHtmlString.Create("Đã tắt chế độ quét".HtmlItemString("invf_inventorycusreturn"))' };
            listToastr.push(objToastr);
            commonUtils.showToastr(listToastr);

            flagmavach = '0';
            commonUtils.addClassCss('#quetmavach', 'display-none');
            commonUtils.removeClassCss('#myInput', 'display-none');
            commonUtils.setFocus('myInput');
        }
        $(thiz).attr('flagmavach', flagmavach);
    }

</script>

<script type="text/javascript">
    $(document).ready(function () {
        $('#quetmavach').enterKey(function () {

            var keyword = $('#quetmavach').val();
            if (!commonUtils.isNullOrEmpty(keyword)) {
                var invCodeIn = commonUtils.returnValueText('#InvCodeIn');
                if (commonUtils.isNullOrEmpty(invCodeIn)) {
                    var listToastr = [];
                    objToastr = { ToastrType: 'error', ToastrMessage: '@MvcHtmlString.Create("Chưa chọn kho nhập".HtmlItemString("ordorderdl"))' };
                    listToastr.push(objToastr);
                    commonUtils.showToastr(listToastr);

                    $('#quetmavach').val('');
                    commonUtils.setFocus('InvCodeIn');
                    return false;
                }

                if (keyword.toString().trim().length > 1) {
                    var url = '@Url.Action("SearchProduct", "LoadData")';
                    var token = $('#manageForm input[name=__RequestVerificationToken]').val();
                    var flagquetmavach = '1';
                    var dataInput = {
                        prdid: keyword,
                        flagquetmavach: flagquetmavach,
                        __RequestVerificationToken: token
                    };

                    $.ajax({
                        type: 'post',
                        data: dataInput,
                        url: url,
                        dataType: 'json',
                        beforeSend: function () {
                        }
                    }).done(function (objResult) {
                        if (objResult.Success) {
                            var listMst_Product = objResult.ListMst_Product;
                            if (listMst_Product !== undefined && listMst_Product !== null && listMst_Product.length > 0) {
                                var _objProduct = listMst_Product[0];
                                // Kiểm tra hàng hóa đã có trên lưới
                                var productExists = checkProductExists(_objProduct);

                                if (!productExists) {
                                    return false;
                                }
                                else {
                                    @*Lấy danh sách hàng hóa cùng base*@
                                    var token = $('#manageForm input[name=__RequestVerificationToken]').val();
                                    var invCodeIn = commonUtils.returnValueText('#InvCodeIn');
                                    var dataInput = {
                                        invcode: invCodeIn,
                                        prdid: _objProduct.ProductCode,
                                        __RequestVerificationToken: token,
                                    };
                                    $.ajax({
                                        type: 'post',
                                        data: dataInput,
                                        url: '@Url.Action("GetProductExactly", "LoadData")',
                                        dataType: 'json',
                                        beforeSend: function () {
                                        }
                                    }).done(function (objResult) {
                                        debugger;
                                        if (objResult.Success) {
                                            @*add hàng hóa vào lưới*@

                                            if (objResult.Data !== undefined && objResult.Data !== null && objResult.Data.length > 0) {
                                                @* Khởi tạo *@
                                                var Lst_InvF_InventoryInDtl = [];

                                                for (var i = 0; i < objResult.Data.length; i++) {
                                                    var objInvF_InventoryInDtl = {
                                                        ProductCodeRoot: commonUtils.returnValue(objResult.Data[i].ProductCodeRoot),
                                                        ProductCodeBase: commonUtils.returnValue(objResult.Data[i].ProductCodeBase),
                                                        ProductCode: commonUtils.returnValue(objResult.Data[i].ProductCode),
                                                        ProductCodeUser: commonUtils.returnValue(objResult.Data[i].ProductCodeUser),
                                                        ProductName: commonUtils.returnValue(objResult.Data[i].ProductName),
                                                        ProductType: commonUtils.returnValue(objResult.Data[i].ProductType),
                                                        //UPBuy: commonUtils.returnValue(objResult.Data[i].UPBuy),
                                                        //UPSell: commonUtils.returnValue(objResult.Data[i].UPSell),
                                                        //FlagActive: commonUtils.returnValue(objResult.Data[i].FlagActive),
                                                        FlagLot: commonUtils.returnValue(objResult.Data[i].FlagLot),
                                                        FlagSerial: commonUtils.returnValue(objResult.Data[i].FlagSerial),

                                                        // Thông tin hàng hóa
                                                        UnitCode: commonUtils.returnValue(objResult.Data[i].UnitCode),
                                                        InvCodeInActual: commonUtils.returnValue(objResult.Data[i].InvCodeSuggest),
                                                        Qty: '0',
                                                        UPIn: commonUtils.returnValue(objResult.Data[i].UPBuy),
                                                        UPInDesc: '0',
                                                        ValInAfterDesc: '0',
                                                        Remark: '',
                                                    };

                                                    Lst_InvF_InventoryInDtl.push(objInvF_InventoryInDtl);
                                                }

                                                var objInvF_InventoryInDtlRender = {
                                                    InvF_InventoryInDtl: Lst_InvF_InventoryInDtl[0],
                                                    Lst_InvF_InventoryInDtl: Lst_InvF_InventoryInDtl,
                                                };

                                                renderInvF_InventoryInDtl(objInvF_InventoryInDtlRender);
                                                tongTienHang();
                                                $('#quetmavach').val('');
                                                //commonUtils.setFocus('InvCodeIn');
                                                return false;
                                            }

                                        }
                                        else {
                                            if (!commonUtils.isNullOrEmpty(objResult.Detail)) {
                                                _showErrorMsg123('Lỗi!', objResult.Detail);
                                            }
                                        }
                                    }).fail(function (jqXHR, textStatus, errorThrown) {
                                    }).always(function () {
                                    });
                                }


                            }
                        }
                        else {
                            if (!commonUtils.isNullOrEmpty(objResult.Detail)) {
                                _showErrorMsg123('Lỗi!', objResult.Detail);
                            }
                        }


                    }).fail(function (jqXHR, textStatus, errorThrown) {

                    }).always(function () {

                    });
                }

            }
        });
    });
</script>
@*End Quét mã sản phẩm*@