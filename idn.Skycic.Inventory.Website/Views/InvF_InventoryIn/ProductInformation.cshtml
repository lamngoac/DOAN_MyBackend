@{
    var Lst_InvF_InventoryInDtlUI = ViewBag.Lst_InvF_InventoryInDtlUI as List<InvF_InventoryInDtlUI>;
    var iF_InvInStatus = CUtils.StrValue(ViewBag.IF_InvInStatus);

    var strDisplay = "";
    if (!string.IsNullOrEmpty(iF_InvInStatus) && iF_InvInStatus != "PENDING")
    {
        strDisplay = "display:none";
    }
    double sumQty = 0;
    if(Lst_InvF_InventoryInDtlUI != null && Lst_InvF_InventoryInDtlUI.Count > 0)
    {
        sumQty = Lst_InvF_InventoryInDtlUI.Sum(m => Convert.ToDouble(m.Qty));
    }
}

<style>
    .readonly {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        pointer-events: none;
    }
</style>

<div class="panel-body row no-margin no-padding" id="panel-body" style="padding-left: 0px; padding-right: 0px;">
    <div class="col-12 padding-left-0 padding-right-0 div-scrollable" style="padding-top: 0!important;">
        <div style="width: 100%; float: left;">
            <div class="row no-margin margin-bottom-9" style="margin-top: 9px!important;">
                <form autocomplete="off" style="width: 100%; display: flex;">
                    <div class="autocomplete row col-6" style="@strDisplay">
                        <label class="control-label" style="margin-right: 20px;">
                            @("Hàng hóa".HtmlItemString("invf_inventoryin"))
                        </label>
                        <input class="col-8" id="myInput" type="text" name="myInput" onkeyup="Autocompletesearch()" placeholder="@("Quét mã vạch hoặc nhập mã, tên để tìm kiếm".HtmlItemString("invf_inventoryin"))">
                        <input class="col-8" style="display: none" id="quetmavach" type="text" name="quetmavach" placeholder="@("Quét mã vạch".HtmlItemString("invf_inventoryin"))">
                        <a href="javascript:void(0);" class="btn btn-nc-button" style="margin-left: 10px" id="btnScan" onclick="StartScan()" title="Quét"><i class="fa fa-qrcode" aria-hidden="true"></i></a>
                        <a class="btn font-color btn-nc-button" data-toggle="dropdown" aria-expanded="false" style="font-size: 13px; position: relative;"><i class="fas fa-ellipsis-h"></i></a>
                        <ul class="dropdown-menu dropdown-action" role="menu" style="">
                            <li style="padding: 6px 5px">
                                <span class="row no-margin col-12 no-padding" href="javascript:void(0);" style="line-height: 13px; color: #000000">Nhập excel</span>
                            </li>
                            <li style="padding: 6px 5px 6px 15px!important">
                                <a class="row no-margin col-12 no-padding" onclick="ImportProducts()" href="javascript:void(0);" style="line-height: 13px; color: #000000"><i class="fas fa-upload" style="margin-right: 7px" aria-hidden="true"></i> Nhập hàng hóa</a>
                            </li>
                            <li style="padding: 6px 5px 6px 15px!important">
                                <a class="row no-margin col-12 no-padding" onclick="ImportLot()" href="javascript:void(0);" style="line-height: 13px; color: #000000"><i class="fas fa-upload" style="margin-right: 7px" aria-hidden="true"></i> Nhập lô</a>
                            </li>
                            <li style="padding: 6px 5px 6px 15px!important">
                                <a class="row no-margin col-12 no-padding" onclick="ImportSerial()" href="javascript:void(0);" style="line-height: 13px; color: #000000"><i class="fas fa-upload" style="margin-right: 7px" aria-hidden="true"></i> Nhập serial</a>
                            </li>
                            <li style="padding: 6px 5px 6px 15px!important">
                                <a class="row no-margin col-12 no-padding" onclick="ImportQR()" href="javascript:void(0);" style="line-height: 13px; color: #000000">
                                    <i class="fas fa-upload" style="margin-right: 7px" aria-hidden="true"></i> Nhập thông tin xác thực
                                </a>
                            </li>

                            <li style="padding: 6px 5px">
                                <span class="row no-margin col-12 no-padding" href="javascript:void(0);" style="line-height: 13px; color: #000000">Xuất file excel template</span>
                            </li>
                            <li style="padding: 6px 5px 6px 15px!important">
                                <a class="row no-margin col-12 no-padding" onclick="ExportTemplateProduct()" href="javascript:void(0);" style="line-height: 13px; color: #000000"><i class="fas fa-download" style="margin-right: 7px" aria-hidden="true"></i> Xuất hàng hóa</a>
                            </li>
                            <li style="padding: 6px 5px 6px 15px!important">
                                <a class="row no-margin col-12 no-padding" onclick="ExportTemplateLot()" href="javascript:void(0);" style="line-height: 13px; color: #000000"><i class="fas fa-download" style="margin-right: 7px" aria-hidden="true"></i> Xuất lô</a>
                            </li>
                            <li style="padding: 6px 5px 6px 15px!important">
                                <a class="row no-margin col-12 no-padding" onclick="ExportTemplateSerial()" href="javascript:void(0);" style="line-height: 13px; color: #000000"><i class="fas fa-download" style="margin-right: 7px" aria-hidden="true"></i> Xuất serial</a>
                            </li>
                            <li style="padding: 6px 5px 6px 15px!important">
                                <a class="row no-margin col-12 no-padding" onclick="ExportTemplateQR()" href="javascript:void(0);" style="line-height: 13px; color: #000000"><i class="fas fa-download" style="margin-right: 7px" aria-hidden="true"></i> Xuất thông tin xác thực</a>
                            </li>
                        </ul>
                    </div>
                    <div class="col-6 text-right" style="margin-top: 9px;">
                        <span style="font-weight: bold">Tổng: </span><span id="spanTotalPrd" style="font-weight: bold">@sumQty</span>
                    </div>
                </form>
            </div>
            <table id="dynamic-table-thead" class="table table-striped table-bordered table-hover table-cus table-bottom-0 no-margin">
                <thead>
                    <tr class="trthead">
                        <th class="cell-50">
                            @MvcHtmlString.Create("")
                        </th>
                        <th fieldid="PRODUCTCODE" sorttype="T" class="cell-100">
                            @("Mã hàng hóa".HtmlItemString("invf_inventoryin"))
                        </th>
                        <th fieldid="PRODUCTNAME" sorttype="T" class="cell-200">
                            @("Tên hàng hóa (TV)".HtmlItemString("invf_inventoryin"))
                        </th>
                        <th fieldid="UNITCODE" sorttype="D" class="cell-75">
                            @("Đơn vị".HtmlItemString("invf_inventoryin"))
                        </th>
                        <th fieldid="QTY" sorttype="D" class="cell-75">
                            @("Số lượng".HtmlItemString("invf_inventoryin"))
                        </th>
                        <th fieldid="INVCODEINACTUAL" sorttype="D" class="cell-150">
                            @("Vị trí nhập".HtmlItemString("invf_inventoryin"))
                        </th>
                        <th fieldid="UPIN" sorttype="T" class="cell-100">
                            @("Giá nhập".HtmlItemString("invf_inventoryin"))
                        </th>
                        <th fieldid="UPINDESC" sorttype="T" class="cell-100">
                            @("Giảm giá".HtmlItemString("invf_inventoryin"))
                        </th>
                        <th fieldid="VALINAFTERDESC" sorttype="T" class="cell-100">
                            @("Thành tiền".HtmlItemString("invf_inventoryin"))
                        </th>
                        <th fieldid="REMARK" sorttype="T" class="cell-100">
                            @("Ghi chú".HtmlItemString("invf_inventoryin"))
                        </th>
                    </tr>
                </thead>
            </table>
            <div id="" class="scrollable" style="width: 100%; float: left">
                <table id="dynamic-table-thead-tbody" class="table table-borderedtable-cus table-bottom-0 dynamic-table-tbody dynamic-table-thead-tbody">
                    <tbody id="table-tbodyID" class="GetPrd">
                        @Html.Partial("LoadProduct", Lst_InvF_InventoryInDtlUI, new ViewDataDictionary() { { "IF_InvInStatus", iF_InvInStatus } })
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<table hidden>
    <tbody id="rowtemplateProduct">

        <tr id="unit_==ProductCode==" idx="==idx==" flagvisible="==flagvisible==" data-prdcode="==ProductCode==" class="data-item trdata getbom ==ProductCode==" style="==trdisplay==">
            <td class="text-center cell-50">
                <a href="javascript:;" class="icon-delete" title="Xóa" onclick="DeleleRowPrd('==ProductCode==')"><i class="fas fa-trash-alt"></i></a>
            </td>
            <td fieldid="PRODUCTCODE" sorttype="T" class="cell-100 ">
                ==ProductCodeUser== &nbsp; ==ProductType==
            </td>

            <td fieldid="PRODUCTNAME" sorttype="T" class="cell-200 "> ==ProductName== </td>

            <td fieldid="UNITCODE" sorttype="T" class="text-center cell-75" id="unitCode_==ProductCode==">
                <select @*class="listproductbase"*@ name="Lst_InvF_InventoryInDtl[==idx==].UnitCode" style="width:75px;" id="Unitchange-==ProductCode==" onchange="ChangUnit('==ProductCode==')">
                    <optgroup label="">
                        ==UnitCode==
                    </optgroup>
                </select>
            </td>

            <td fieldid="QTY" sorttype="T" class="text-center cell-75 ">
                <input arr="qty" style="width:75px;" type="text" class="text-right number ==ReadOnly==" name="Lst_InvF_InventoryInDtl[==idx==].Qty" id="qty_==ProductCode==" value="" onkeyup="inputQty(this)" />
            </td>

            <td fieldid="INVCODEINACTUAL" sorttype="T" class="text-center cell-150">
                <input arr="invcodeinactual" readonly="readonly" type="text" class="text-left col-md-11" name="Lst_InvF_InventoryInDtl[==idx==].InvCodeInActual" id="invCodeInActual_==ProductCode==" value="==InvCodeSuggest==" />
                ==ShowPopupInvCodeInActual==
            </td>

            <td fieldid="UPIN" sorttype="T" class="text-center cell-100 ">
                <input arr="upin" style="width:100px;" type="text" class="text-right number" name="Lst_InvF_InventoryInDtl[==idx==].UPIn" id="uPIn_==ProductCode==" value="==UPIn==" onkeyup="inputUPIn(this)" />
            </td>

            <td fieldid="UPINDESC" sorttype="T" class="text-center cell-100 ">
                <input arr="upindesc" style="width:100px;" type="text" class="text-right number" name="Lst_InvF_InventoryInDtl[==idx==].UPInDesc" id="uPInDesc_==ProductCode==" value="0" onkeyup="inputUPInDesc(this)" />
            </td>

            <td fieldid="VALINAFTERDESC" sorttype="T" class="text-center cell-100 ">
                <input arr="valinafterdesc" style="width:100px;" readonly="readonly" type="text" class="text-right number" name="Lst_InvF_InventoryInDtl[==idx==].ValInAfterDesc" id="valInAfterDesc_==ProductCode==" value="" />
            </td>

            <td fieldid="REMARK" sorttype="T" class="text-center cell-100 ">
                <input arr="remark" style="width:100px;" type="text" class="text-right" name="Lst_InvF_InventoryInDtl[==idx==].Remark" id="remark_==ProductCode==" value="" />
            </td>

            <input type="hidden" name="Lst_InvF_InventoryInDtl[==idx==].ProductCode" value="==ProductCode==" />
            <input type="hidden" name="Lst_InvF_InventoryInDtl[==idx==].ProductCodeUser" value="==ProductCodeUser==" />
            <input type="hidden" name="Lst_InvF_InventoryInDtl[==idx==].ProductCodeBase" value="==ProductCodeBase==" />
            <input type="hidden" name="Lst_InvF_InventoryInDtl[==idx==].ProductName" value="==ProductName==" />
            <input type="hidden" name="Lst_InvF_InventoryInDtl[==idx==].FlagLot" value="==FlagLot==" />
            <input type="hidden" name="Lst_InvF_InventoryInDtl[==idx==].FlagSerial" value="==FlagSerial==" />
        </tr>
    </tbody>
</table>

@**Modal Search Product*@
<div class="modal fade" id="ShowPopupProductSearch" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 1000px; max-width: 1000px;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="exampleModalLabel"><b>Tìm kiếm hàng hoá</b></h2>
                <a href="javascript:;" onclick="ClosePopupProductSearch()" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></a>
            </div>
            <div class="modal-body" style="">
                @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "manageFormShowPopupAdd" }))
                {
                    @Html.AntiForgeryToken()
                    <div class="layout-search">
                        <div class="form-group margin-bottom-5 padding-bottom-10">
                            <div class="col-xs-12 col-sm-4 no-padding-left">
                                <span class="block input-icon input-icon-left">
                                    <input type="text" id="ProductName" name="ProductName" class="col-12 text-left ProductName" value="" autocomplete="off" required placeholder="Nhập mã hoặc tên hàng hoá" />
                                </span>
                            </div>
                            <a class="btn btn-nc-button" onclick="SearchProduct()" href="javascript:void(0);" style=""><img class="img-button-search" src="@Url.Content("~/Images/search.svg")"></a>
                        </div>
                    </div>
                    <div class="col-12 no-padding" id="List_Product_Data">

                    </div>
                }
            </div>
            <div class="modal-footer">
                <a class="btn font-color mybtn-Button" href="javascript:void(0);" onclick="AddItems()" style="float: right;font-size: 13px;"><i class="fa fa-plus-circle" aria-hidden="true"></i> Chọn</a>
            </div>
        </div>
    </div>
</div>

@*Import Excel*@
<div class="modal fade" id="ImportExcelModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 500px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="exampleModalLabel">Nhập excel</h3>
                <a href="javascript:;" onclick="CloseModalImportExcel()" class="close" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </a>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm(null, null, FormMethod.Post, new { @id = "manageFormImportExcel" }))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="key" name="key" value="" />
                    <div class="form-group margin-bottom-9">
                        <input type="file" name="file" id="file" />
                    </div>
                }
            </div>
            <div class="modal-footer">
                <a href="javascript:void(0);" class="btn mybtn-Button" onclick="Import()" id="btnSaveImport" style="padding-left: 10px!important; padding-right: 10px!important; font-size: 16px; font-weight: 500;">Nhập</a>
            </div>
        </div>
    </div>
</div>

<script>
    $('select.ProductGrpCodeSearch').select2();
</script>

<script>
    var objCommonExcel = new CommonExcel();
        var objVariablesInit = {
            Id_FormMain: '',
            Id_FormImportExcel: 'manageFormImportExcel',
            Id_Modal: 'ImportExcelModal',
            Id_FileInput: 'file',
        };

        var ajaxSettings_Excel = {};
        ajaxSettings_Excel.Type = 'post';
        ajaxSettings_Excel.DataType = 'json';

    function ImportProducts() {
        $('#key').val("PRODUCT");
        $('#file').val('');
        ShowPopupImportExcel();
    }
    function ImportLot() {
        $('#key').val("LOT");
        $('#file').val('');
        ShowPopupImportExcel();
    }
    function ImportSerial() {
        $('#key').val("SERIAL");
        $('#file').val('');
        ShowPopupImportExcel();
    }
    function ImportQR() {
        $('#key').val("QR");
        $('#file').val('');
        ShowPopupImportExcel();
    }

        function ShowPopupImportExcel() {
            $('#ImportExcelModal').modal('show')
        }

        function CloseModalImportExcel() {
            $('#ImportExcelModal').modal('hide')
            $('#ImportExcelModal').on('hidden.bs.modal', function () {
                $(this).find('#manageFormImportExcel').trigger('reset');
            });
        }

        function Import() {
            var file = $("#file").val();

            if (file.length === 0) {
                alert("Nhập file cần Import");
                $("#file").val('');
                return false;
            } else {
                var checkFile = false;
                var _index = file.lastIndexOf('.');
                if (_index !== undefined && _index !== null && _index > 0) {
                    var fileType = file.substring(_index + 1, file.length).toLowerCase();
                    if (fileType === 'xls' || fileType.toLowerCase() === 'xlsx') {
                        checkFile = true;
                    }
                }
                if (checkFile) {
                    var key = $("#key").val();
                    if (key.toString().toUpperCase().trim() == "PRODUCT") {
                        ImportFileExcelProduct();
                    }
                    else if (key.toString().toUpperCase().trim() == "LOT") {
                        ImportFileExcelLot();
                    }
                    else if (key.toString().toUpperCase().trim() == "SERIAL") {
                        ImportFileExcelSerial();
                    }
                    else if (key.toString().toUpperCase().trim() == "QR") {
                        ImportFileExcelQR();
                    }
                } else {
                    alert("File Excel Import không hợp lệ!");
                }
            }
        }

    function ImportFileExcelProduct() {
        var formData = new window.FormData($('#manageFormImportExcel')[0]);
        formData.append('tax_file', $('input[type=file]')[0].files[0]);

        var invBUPattern = "";
        var invcodein = $('#InvCodeIn').val();

        if (invcodein === "") {
            alert("Kho nhập chưa được chọn");
            $('#InvCodeIn').focus();
            return;
        }
        var optSelect = $('#InvCodeIn').find('option:selected');
        invBUPattern = $(optSelect).attr("InvBUPattern");
        formData.append('invBUPattern', invBUPattern);

        if (formData != undefined && formData != null) {
            $('#ImportExcelModal').modal("hide");
            //Loading();
            var url = '@(Url.Action("ImportProduct", "InvF_InventoryIn"))';
            $.ajax({
                url: url,
                data: formData,
                type: 'post',
                beforeSend: function () { },
                success: function (result) {
                    //Endloading();
                    var getData = result;
                    if (getData.Success == false || getData.Success == 'false') {
                        if (getData.Detail != null) {
                            showErrorDialog("Lỗi!", getData.Detail);
                        } else {
                            alert(getData.Messages[0]);
                        }
                    } else {
                        $('#table-tbodyID.GetPrd').html('');
                        $('#table-detailLot').html('');
                        $('#table-detailSerial').html('');
                        $('#table-tbodyID.GetPrd').html(getData.Html);
                        TongTienHang();
                        $('.number').number(true, 2);

                        //Add bảng VT nhập
                        $('#table-detailInvCodeInActual').html('');
                        var rows = $('tbody#table-tbodyID tr').length;
                        if (rows > 0) {
                            $("#table-tbodyID tr").each(function () {
                                var idx = $(this).attr('idx');
                                var productCode = $(this).find('input[type="hidden"][name="Lst_InvF_InventoryInDtl[' + idx + '].ProductCode"]').val();
                                var invCodeInActual = $(this).find('input[type="text"][name="Lst_InvF_InventoryInDtl[' + idx + '].InvCodeInActual"]').val();
                                var qty = $(this).find('input[type="text"][name="Lst_InvF_InventoryInDtl[' + idx + '].Qty"]').val();
                                
                                let strHtmlVtNhap;
                                strHtmlVtNhap = getHtmlFromTemplate($('#rowtemplateInvCodeInActual'), {
                                    ProductCode: productCode,
                                    Qty: qty,
                                    InvCodeInActual: invCodeInActual,
                                    idx: 999999
                                });

                                $('#table-detailInvCodeInActual').append(strHtmlVtNhap);
                                updateTableTrIdx($('#table-detailInvCodeInActual tr'), false);
                            });
                        }
                    }
                },
                error: function () {
                    //Endloading();
                },
                cache: false,
                contentType: false,
                //dataType: "json",
                processData: false
            });
        }
    }

    function ImportFileExcelLot() {
        var formData = new window.FormData($('#manageFormImportExcel')[0]);
        formData.append('tax_file', $('input[type=file]')[0].files[0]);

        var invBUPattern = "";
        var invcodein = $('#InvCodeIn').val();

        if (invcodein === "") {
            alert("Kho nhập chưa được chọn");
            $('#InvCodeIn').focus();
            return;
        }
        var optSelect = $('#InvCodeIn').find('option:selected');
        invBUPattern = $(optSelect).attr("InvBUPattern");
        formData.append('invBUPattern', invBUPattern);

        if (formData != null && formData != undefined) {
            var rows = $("tbody#table-tbodyID tr.trdata").length;
            if (rows > 0) {
                var listPrd = [];
                $("tbody#table-tbodyID tr.trdata").each(function () {
                    var tr = $(this);
                    var idx = tr.attr('idx');
                    var product = {};
                    var productCode = tr.attr('data-prdcode');
                    var productCodeUser = tr.find('input[type="hidden"][name="Lst_InvF_InventoryInDtl[' + idx + '].ProductCodeUser"]').val();
                    var flagLot = tr.find('input[type="hidden"][name="Lst_InvF_InventoryInDtl[' + idx + '].FlagLot"]').val();
                    product.ProductCode = productCode;
                    product.ProductCodeUser = productCodeUser;
                    product.mp_FlagLot = flagLot;
                    listPrd.push(product);
                });
                $('#ImportExcelModal').modal("hide");
                //Loading();
                var url = '@(Url.Action("ImportLot", "InvF_InventoryIn"))';
                formData.append('listProduct', JSON.stringify(listPrd));
                $.ajax({
                    url: url,
                    type: 'post',
                    beforeSend: function () { },
                    success: function (result) {
                        //debugger;
                        //Endloading();
                        var getData = result;
                        if (getData.Success == false || getData.Success == 'false') {
                            if (getData.Detail != null) {
                                showErrorDialog("Lỗi!", getData.Detail);
                            } else {
                                alert(getData.Messages[0]);
                            }
                        } else {
                            $('#table-detailLot').html('');
                            $('#table-detailLot').html(getData.Html);
                            updateTableTrIdx($('#table-detailLot tr'), true);

                            //Update Số lượng, Vị trí lên DS hàng hóa
                            $("tbody#table-tbodyID tr.trdata").each(function () {
                                var trProduct = $(this);
                                var idx = trProduct.attr('idx');
                                var prdCode = trProduct.attr('data-prdcode');
                                var flagLot = trProduct.find('input[type="hidden"][name="Lst_InvF_InventoryInDtl[' + idx + '].FlagLot"]').val();
                                if (flagLot !== '1') {
                                    return;
                                }

                                var sumqty = 0.0;
                                var lstVitri = "";
                                $('#table-detailLot').find('tr[productcode="' + prdCode + '"]').each(function () {
                                    var tr = $(this);
                                    var idx = $(tr).attr('idx');
                                    var strqty = tr.find('input[type="hidden"][name="Lst_InvF_InventoryInInstLot[' + idx + '].Qty"]').val();

                                    var qty = parseFloat(strqty);
                                    sumqty += qty;

                                    var invCodeInActual = tr.find('input[type="hidden"][name="Lst_InvF_InventoryInInstLot[' + idx + '].InvCodeInActual"]').val();
                                    if (invCodeInActual != null) {
                                        if (lstVitri == "") {
                                            lstVitri += invCodeInActual;
                                        }
                                        else if (!lstVitri.includes(invCodeInActual)) {
                                            lstVitri += ", " + invCodeInActual;
                                        }
                                    }
                                });

                                trProduct.find('input[name="Lst_InvF_InventoryInDtl[' + idx + '].Qty"]').val(sumqty);
                                trProduct.find('input[name="Lst_InvF_InventoryInDtl[' + idx + '].InvCodeInActual"]').val(lstVitri);
                            });

                            TongTienHang();
                        }
                    },
                    error: function () {
                        //Endloading();
                    },
                    data: formData,
                    cache: false,
                    contentType: false,
                    //dataType: "json",
                    processData: false
                });
            }
            else {
                alert('@MvcHtmlString.Create("Lưới danh mục hàng hóa trống!")');
                return false;
            }
        }
    }

    function ImportFileExcelSerial() {
        var formData = new window.FormData($('#manageFormImportExcel')[0]);
        formData.append('tax_file', $('input[type=file]')[0].files[0]);

        var invBUPattern = "";
        var invcodein = $('#InvCodeIn').val();

        if (invcodein === "") {
            alert("Kho nhập chưa được chọn");
            $('#InvCodeIn').focus();
            return;
        }
        var optSelect = $('#InvCodeIn').find('option:selected');
        invBUPattern = $(optSelect).attr("InvBUPattern");
        formData.append('invBUPattern', invBUPattern);

        if (formData != null && formData != undefined) {
            var rows = $("tbody#table-tbodyID tr.trdata").length;
            if (rows > 0) {
                var listPrd = [];
                $("tbody#table-tbodyID tr.trdata").each(function () {
                    var tr = $(this);
                    var idx = tr.attr('idx');
                    var product = {};
                    var productCode = tr.attr('data-prdcode');
                    var productCodeUser = tr.find('input[type="hidden"][name="Lst_InvF_InventoryInDtl[' + idx + '].ProductCodeUser"]').val();
                    var flagSerial = tr.find('input[type="hidden"][name="Lst_InvF_InventoryInDtl[' + idx + '].FlagSerial"]').val();
                    product.ProductCode = productCode;
                    product.ProductCodeUser = productCodeUser;
                    product.mp_FlagSerial = flagSerial;
                    listPrd.push(product);
                });
                $('#ImportExcelModal').modal("hide");
                //Loading();
                var url = '@(Url.Action("ImportSerial", "InvF_InventoryIn"))';
                formData.append('listProduct', JSON.stringify(listPrd));
                $.ajax({
                    url: url,
                    type: 'post',
                    beforeSend: function () { },
                    success: function (result) {
                        //Endloading();
                        var getData = result;
                        if (getData.Success == false || getData.Success == 'false') {
                            if (getData.Detail != null) {
                                showErrorDialog("Lỗi!", getData.Detail);
                            } else {
                                alert(getData.Messages[0]);
                            }
                        } else {
                            $('#table-detailSerial').html('');
                            $('#table-detailSerial').html(getData.Html);
                            updateTableTrIdx($('#table-detailSerial tr'), true);

                            //Update Số lượng, Vị trí lên DS hàng hóa
                            $("tbody#table-tbodyID tr.trdata").each(function () {
                                var trProduct = $(this);
                                var idx = trProduct.attr('idx');
                                var prdCode = trProduct.attr('data-prdcode');
                                var flagSerial = trProduct.find('input[type="hidden"][name="Lst_InvF_InventoryInDtl[' + idx + '].FlagSerial"]').val();
                                if (flagSerial !== '1') {
                                    return;
                                }

                                var lstVitri = "";
                                var sumqty = $('#table-detailSerial').find('tr[productcode="' + prdCode + '"]').length;
                                $('#table-detailSerial').find('tr[productcode="' + prdCode + '"]').each(function () {
                                    var tr = $(this);
                                    var idx = $(tr).attr('idx');

                                    var invCodeInActual = tr.find('input[type="hidden"][name="Lst_InvF_InventoryInInstSerial[' + idx + '].InvCodeInActual"]').val();
                                    if (invCodeInActual != null) {
                                        if (lstVitri == "") {
                                            lstVitri += invCodeInActual;
                                        }
                                        else if (!lstVitri.includes(invCodeInActual)) {
                                            lstVitri += ", " + invCodeInActual;
                                        }
                                    }
                                });

                                trProduct.find('input[name="Lst_InvF_InventoryInDtl[' + idx + '].Qty"]').val(sumqty);
                                trProduct.find('input[name="Lst_InvF_InventoryInDtl[' + idx + '].InvCodeInActual"]').val(lstVitri);
                            });

                            TongTienHang();
                        }
                    },
                    error: function () {
                        //Endloading();
                    },
                    data: formData,
                    cache: false,
                    contentType: false,
                    //dataType: "json",
                    processData: false
                });
            }
            else {
                alert('@MvcHtmlString.Create("Lưới danh mục hàng hóa trống!")');
                return false;
            }
        }
    }

    function ImportFileExcelQR() {
        var formData = new window.FormData($('#manageFormImportExcel')[0]);
        formData.append('tax_file', $('input[type=file]')[0].files[0]);

        if (formData != undefined && formData != null) {
            var rows = $("tbody#table-tbodyID tr.trdata").length;
            if (rows > 0) {
                var listPrd = [];
                $("tbody#table-tbodyID tr.trdata").each(function () {
                    var tr = $(this);
                    var idx = tr.attr('idx');
                    var product = {};
                    var productCode = tr.attr('data-prdcode');
                    var productCodeUser = tr.find('input[type="hidden"][name="Lst_InvF_InventoryInDtl[' + idx + '].ProductCodeUser"]').val();
                    var productName = tr.find('input[type="hidden"][name="Lst_InvF_InventoryInDtl[' + idx + '].ProductName"]').val();
                    product.ProductCode = productCode;
                    product.ProductCodeUser = productCodeUser;
                    product.ProductName = productName;
                    listPrd.push(product);
                });
                $('#ImportExcelModal').modal("hide");
                //Loading();
                var url = '@(Url.Action("ImportQR", "InvF_InventoryIn"))';
                formData.append('listProduct', JSON.stringify(listPrd));
                $.ajax({
                    url: url,
                    data: formData,
                    type: 'post',
                    beforeSend: function () { },
                    success: function (result) {
                        //Endloading();
                        var getData = result;
                        if (getData.Success == false || getData.Success == 'false') {
                            if (getData.Detail != null) {
                                showErrorDialog("Lỗi!", getData.Detail);
                            } else {
                                alert(getData.Messages[0]);
                            }
                        } else {
                            $('#table-tbodyIDXacThuc').html('');
                            $('#table-tbodyIDXacThuc').html(getData.Html);
                            updateTableTrIdxColumn2($('#table-tbodyIDXacThuc tr'), true);
                        }
                    },
                    error: function () {
                        //Endloading();
                    },
                    cache: false,
                    contentType: false,
                    //dataType: "json",
                    processData: false
                });
            }
            else {
                alert('@MvcHtmlString.Create("Lưới danh mục hàng hóa trống!")');
                return false;
            }
        }
    }

    function ExportTemplateProduct() {

        ajaxSettings_Excel.Url = '@Url.Action("ExportTemplateProduct", "InvF_InventoryIn")';

        objCommonExcel.ajaxSettingsInit();
        objCommonExcel.ajaxSettings = ajaxSettings_Excel;
        objCommonExcel.exportExcel();
    }
    function ExportTemplateLot() {

            ajaxSettings_Excel.Url = '@Url.Action("ExportTemplateLot", "InvF_InventoryIn")';

            objCommonExcel.ajaxSettingsInit();
            objCommonExcel.ajaxSettings = ajaxSettings_Excel;
            objCommonExcel.exportExcel();
    }
    function ExportTemplateSerial() {

            ajaxSettings_Excel.Url = '@Url.Action("ExportTemplateSerial", "InvF_InventoryIn")';

            objCommonExcel.ajaxSettingsInit();
            objCommonExcel.ajaxSettings = ajaxSettings_Excel;
            objCommonExcel.exportExcel();
    }
    function ExportTemplateQR() {

            ajaxSettings_Excel.Url = '@Url.Action("ExportTemplateQR", "InvF_InventoryIn")';

            objCommonExcel.ajaxSettingsInit();
            objCommonExcel.ajaxSettings = ajaxSettings_Excel;
            objCommonExcel.exportExcel();
        }
</script>

<!-- Search product -->
<script type="text/javascript">
        function ClosePopupProductSearch() {
            $('#ShowPopupProductSearch').modal('hide');
            $('#ShowPopupProductSearch').on('hidden.bs.modal', function () {
                $('#ShowPopupProductSearch form')[0].reset();
            });
        }

    function SearchProduct() {
        let invcodein = $('#InvCodeIn').val();
        if (invcodein === undefined || invcodein === '') {
            alert("Kho nhập chưa được chọn");
            //$('#InvCodeIn').focus();
            return;
        }

        var productCode = commonUtils.returnValueText('#ShowPopupProductSearch #ProductName')
        var token = $('#ShowPopupProductSearch #manageForm input[name=__RequestVerificationToken]').val();
        var url = '@Url.Action("SearchMstProduct", "InvF_InventoryIn")';
        $.ajax({
            type: "post",
            data: {
                __RequestVerificationToken: token,
                productcode: productCode,
                invcode: invcodein
            },
            url: url,
            dataType: 'json',
            beforeSend: function () { }
        }).done(function (result) {
            if (result.Success) {
                $('#List_Product_Data').html('');
                $('#List_Product_Data').html(result.Html);
                //Disabled_previous_Next();
                $('.numberic').number(true, 2);
            } else {
                if (!commonUtils.isNullOrEmpty(result.Detail)) {
                    showErrorDialog(result.Detail);
                }
            }
        }).fail(function (jqXHR, textStatus, errorThrown) {

        }).always(function (jqXHROrData, textStatus, jqXHROrErrorThrown) {
            //alert("complete");
        });
    }

    function AddItems() {
        var checkedRows = $('#ShowPopupProductSearch #dynamic-table-thead-tbody input[type="checkbox"]:checked');
        if (checkedRows.length == 0) {
            alert("Không có hàng hoá được chọn!");
            return false;
        }
        for (let item of checkedRows) {
            debugger;
            let trRow = $(item).parent().parent();
            let idx = $(trRow).attr('idx');
            let flagShow = $(trRow).is(":hidden") ? '0' : '1';
            let productCode = $(trRow).find('input[type="hidden"][name="ListProduct[' + idx + '].ProductCode"]').val();
            let productCodeUser = $(trRow).find('input[type="hidden"][name="ListProduct[' + idx + '].ProductCodeUser"]').val();
            let productCodeBase = $(trRow).find('input[type="hidden"][name="ListProduct[' + idx + '].ProductCodeBase"]').val();
            let productName = $(trRow).find('input[type="hidden"][name="ListProduct[' + idx + '].ProductName"]').val();
            //let unitCode = $(trRow).find('input[type="hidden"][name="ListProduct[' + idx + '].UnitCode"]').val();
            let uPIn = $(trRow).find('input[type="hidden"][name="ListProduct[' + idx + '].UPIn"]').val();
            let flagLot = $(trRow).find('input[type="hidden"][name="ListProduct[' + idx + '].mp_FlagLot"]').val();
            let flagSerial = $(trRow).find('input[type="hidden"][name="ListProduct[' + idx + '].mp_FlagSerial"]').val();
            let invCodeSuggest = $(trRow).find('input[type="hidden"][name="ListProduct[' + idx + '].InvCodeSuggest"]').val();

            var trdisplay = flagShow === '0' ? "display: none" : "";
            var flagvisible = flagShow === '1' ? "1" : "0";
            var readonly = 'readonly';
            var ProductType = '';
            if (flagLot == "1") {
                ProductType = "<a href=\"javascript:;\" title=\"Chi tiết Lô\" onclick=\"ShowLo('" + productCode + "')\">(Lô)</a>";
            }
            else if (flagSerial == "1") {
                ProductType = "<a href=\"javascript:;\" title=\"Chi tiết Serial\" onclick=\"ShowSerial('" + productCode + "')\">(Serial)</a>";
            }
            else {
                readonly = '';
            }
            
            var UnitCode = document.getElementById('optgroup-' + productCode).innerHTML;

            var ShowPopupInvCodeInActual = '';
            if (flagSerial != "1" && flagLot != "1") {
                ShowPopupInvCodeInActual = "<a href=\"javascript:;\" title=\"Chọn vị trí nhập\" onclick=\"ShowVTNhap('" + productCode + "','" + productCodeUser + "','" + productName + "','" + productCodeBase + "')\"><i class=\"fa fa-caret-down\"></i></a>";
            }

            //
            var strHtml = getHtmlFromTemplate($('#rowtemplateProduct'), {
                ProductCode: productCode,
                ProductName: productName,
                ProductCodeUser: productCodeUser,
                ProductCodeBase: productCodeBase,
                ProductType: ProductType,
                UnitCode: UnitCode,
                ShowPopupInvCodeInActual: ShowPopupInvCodeInActual,
                UPIn: uPIn,
                trdisplay: trdisplay,
                flagvisible: flagvisible,
                FlagLot: flagLot,
                FlagSerial: flagSerial,
                ReadOnly: readonly,
                InvCodeSuggest: invCodeSuggest,
                idx: 999999
            });

            var oldItem = $('.GetPrd').find('tr[data-prdcode="' + productCode + '"]');
            if (oldItem != undefined && oldItem.length > 0) {
                let flagVisibleCur = oldItem.attr('flagvisible');
                if (flagVisibleCur === '1' && flagvisible === '1') {
                    commonUtils.showAlert('Mã hàng hóa ' + productCodeUser + ' đã tồn tại trên lưới dữ liệu!');
                    return;
                }
                else if (flagVisibleCur === '0' && flagvisible === '1') {
                    oldItem.remove();
                    $('.GetPrd').append(strHtml);

                    //Xóa VT cũ cùng ProductCode
                    var trOldInvs = $('#table-detailInvCodeInActual').find('tr[productcode="' + productCode + '"]');
                    $(trOldInvs).each(function () {
                        $(this).remove();
                    });
                    updateTableTrIdx($('#table-detailInvCodeInActual tr'), false);
                }
                else if (flagVisibleCur === '1' && flagvisible === '0') {
                    continue;
                }
            } else {
                $('.GetPrd').append(strHtml);
            }
            updateTableTrIdx($('#table-tbodyID tr.trdata'), false);
            jQuery(function ($) {
                if ($('.number').length) {
                    $('.number').number(true, 2);
                }
            });

            //Add row bảng vị trí nhập
            let strHtmlVtNhap;
            strHtmlVtNhap = getHtmlFromTemplate($('#rowtemplateInvCodeInActual'), {
                ProductCode: productCode,
                Qty: '0',
                InvCodeInActual: invCodeSuggest,
                idx: 999999
            });

            $('#table-detailInvCodeInActual').append(strHtmlVtNhap);
            updateTableTrIdx($('#table-detailInvCodeInActual tr'), false);

            ClosePopupProductSearch();
        }
    }
</script>

<script>

    function StartScan() {
        if (FlagScan === '0') {
            var listToastr = [];
            objToastr = { ToastrType: 'success', ToastrMessage: '@MvcHtmlString.Create("Bắt đầu chuyển sang chế độ quét".HtmlItemString("invf_inventorycusreturn"))' };
            listToastr.push(objToastr);
            commonUtils.showToastr(listToastr);
            FlagScan = '1';
            //Ẩn hiện ô quét
            $('#quetmavach').show();
            $('#myInput').val('');
            $('#myInput').hide();
            $('#quetmavach').focus();
        }
        else {
            var listToastr = [];
            objToastr = { ToastrType: 'success', ToastrMessage: '@MvcHtmlString.Create("Đã tắt chế độ quét".HtmlItemString("invf_inventorycusreturn"))' };
            listToastr.push(objToastr);
            commonUtils.showToastr(listToastr);
            FlagScan = '0';
            //Ẩn hiện ô quét
            $('#quetmavach').val('');
            $('#quetmavach').hide();
            $('#myInput').show();
        }
}
</script>
